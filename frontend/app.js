"use strict";(()=>{function E(u){return u>=1e9?(u/1e9).toFixed(2)+"B":u>=1e6?(u/1e6).toFixed(2)+"M":u>=1e3?(u/1e3).toFixed(2)+"K":u.toString()}function M(u){return u>=1e12?"$"+(u/1e12).toFixed(2)+"T":u>=1e9?"$"+(u/1e9).toFixed(2)+"B":"$"+(u/1e6).toFixed(2)+"M"}function L(u){let t=new Date(u),s=new Date().getTime()-t.getTime(),n=Math.floor(s/(1e3*60*60));return n<1?"Just now":n<24?`${n}h ago`:t.toLocaleDateString()}function w(u){if(!u)return"$";try{return new Intl.NumberFormat("en",{style:"currency",currency:u,currencyDisplay:"narrowSymbol",minimumFractionDigits:0,maximumFractionDigits:0}).formatToParts(0).find(s=>s.type==="currency")?.value||u}catch{return u}}function I(u,t="$"){if(u==null||isNaN(u))return"\u2014";let e=Math.abs(u),s=u<0?"-":"";return e>=1e9?s+t+(e/1e9).toFixed(1)+"B":e>=1e6?s+t+(e/1e6).toFixed(1)+"M":e>=1e3?s+t+(e/1e3).toFixed(1)+"K":s+t+e.toFixed(0)}function T(u,t="number"){if(u==null||isNaN(u))return"N/A";switch(t){case"percent":return(u*100).toFixed(2)+"%";case"currency":return M(u);case"ratio":return u.toFixed(2);default:return E(u)}}function C(u){return u==null?"":u>=0?"positive":"negative"}var b=class{constructor(){this.treasuryChart=null;this.commodityChart=null;this.commodityCandleSeries=null;this.currentCommoditySymbol=null;this.currentCommodityName=null;this.currentCommodityDays=30;this.indexChart=null;this.indexCandleSeries=null;this.currentIndexSymbol=null;this.currentIndexName=null;this.currentIndexDays=30;this.treasuryLineSeries=null;this.bondsChart=null;this.bondsLineSeries=null;this.currentTreasuryMaturity=null;this.currentTreasuryDays=365;this.currentBondCountry=null;this.currentBondCountryCode=null;this.currentBondYears=10;this.statementsData=null;this.statementsCurrencyMode="local";this.statementsCurrencyCode=null;this.statementsCurrencySymbol=null;this.statementsUsdRate=null;this.statementsPeriodMode="annual";this.currentTab="income";this.currentSymbol=null;this.chart=null;this.candleSeries=null;this.searchTimeout=null;this.selectedIndex=-1;this.searchResultsData=[];this.newsData=[];this.commandInput=document.getElementById("command-input"),this.searchResults=document.getElementById("search-results"),this.welcomeScreen=document.getElementById("welcome-screen"),this.securityView=document.getElementById("security-view"),this.tickerList=document.getElementById("ticker-list"),this.statusText=document.getElementById("status-text"),this.newsModal=document.getElementById("news-modal"),this.ratiosModal=document.getElementById("ratios-modal"),this.indexModal=document.getElementById("index-modal"),this.statementsModal=document.getElementById("statements-modal"),this.govtModal=document.getElementById("govt-modal"),this.treasuryChartModal=document.getElementById("treasury-chart-modal"),this.bondsModal=document.getElementById("bonds-modal"),this.bondsChartModal=document.getElementById("bonds-chart-modal"),this.commoditiesModal=document.getElementById("commodities-modal"),this.indexChartModal=document.getElementById("index-chart-modal"),this.commodityChartModal=document.getElementById("commodity-chart-modal"),this.init()}init(){this.setupEventListeners(),this.setupModalListeners(),this.setupRatiosModal(),this.setupIndexModal(),this.setupIndexChartModal(),this.setupStatementsModal(),this.setupGovtModal(),this.setupTreasuryChartModal(),this.setupBondsModal(),this.setupBondsChartModal(),this.setupCommoditiesModal(),this.setupCommodityChartModal(),this.updateTime(),this.loadQuickTickers(),setInterval(()=>this.updateTime(),1e3)}setupEventListeners(){this.commandInput.addEventListener("input",()=>this.handleSearch()),this.commandInput.addEventListener("keydown",t=>this.handleKeydown(t)),this.commandInput.addEventListener("focus",()=>{this.searchResultsData.length>0&&this.searchResults.classList.add("active")}),document.addEventListener("click",t=>{!this.commandInput.contains(t.target)&&!this.searchResults.contains(t.target)&&this.searchResults.classList.remove("active")}),document.querySelectorAll(".chart-btn").forEach(t=>{t.addEventListener("click",e=>{let s=e.target,n=parseInt(s.dataset.days||"90",10);document.querySelectorAll(".chart-btn").forEach(a=>a.classList.remove("active")),s.classList.add("active"),this.currentSymbol&&this.loadChartData(this.currentSymbol,n)})})}setupModalListeners(){let t=document.getElementById("modal-close"),e=this.newsModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.closeModal()),e?.addEventListener("click",()=>this.closeModal()),document.addEventListener("keydown",s=>{s.key==="Escape"&&!this.newsModal.classList.contains("hidden")&&this.closeModal()})}openNewsModal(t){let e=document.getElementById("modal-title"),s=document.getElementById("modal-source"),n=document.getElementById("modal-timestamp"),a=document.getElementById("modal-sentiment"),l=document.getElementById("modal-body"),d=document.getElementById("modal-link");if(e&&(e.textContent=t.title),s&&(s.textContent=t.source),n&&(n.textContent=this.formatTime(t.timestamp)),a&&(a.textContent=t.sentiment,a.className=`modal-sentiment ${t.sentiment}`),l){let m=t.content||t.summary;l.innerHTML=m.split(`

`).map(i=>`<p>${i}</p>`).join("")}d&&(d.href=t.url),this.newsModal.classList.remove("hidden")}closeModal(){this.newsModal.classList.add("hidden")}setupRatiosModal(){let t=document.getElementById("ratios-btn"),e=document.getElementById("ratios-modal-close"),s=this.ratiosModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.openRatiosModal()),e?.addEventListener("click",()=>this.closeRatiosModal()),s?.addEventListener("click",()=>this.closeRatiosModal()),document.addEventListener("keydown",n=>{n.key==="Escape"&&!this.ratiosModal.classList.contains("hidden")&&this.closeRatiosModal()})}async openRatiosModal(){if(!this.currentSymbol)return;let t=document.getElementById("ratios-loading"),e=document.getElementById("ratios-body"),s=document.getElementById("ratios-modal-title");s&&(s.textContent=`${this.currentSymbol} - Financial Ratios`),t&&(t.style.display="block"),e&&(e.innerHTML=""),this.ratiosModal.classList.remove("hidden");try{let n=await fetch(`/api/financials/${this.currentSymbol}`);if(!n.ok)throw new Error("Failed to fetch");let a=await n.json();this.renderRatios(a)}catch{e&&(e.innerHTML='<div class="ratios-loading">Failed to load financial data</div>')}finally{t&&(t.style.display="none")}}closeRatiosModal(){this.ratiosModal.classList.add("hidden")}renderRatios(t){let e=document.getElementById("ratios-body");if(!e)return;let s=(n,a="number")=>T(n,a);e.innerHTML=`
            <div class="ratios-section">
                <div class="ratios-section-title">VALUATION</div>
                <div class="ratio-row"><span class="ratio-label">P/E (TTM)</span><span class="ratio-value">${s(t.pe_ratio,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Forward P/E</span><span class="ratio-value">${s(t.forward_pe,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">PEG Ratio</span><span class="ratio-value">${s(t.peg_ratio,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Price/Book</span><span class="ratio-value">${s(t.price_to_book,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Price/Sales</span><span class="ratio-value">${s(t.price_to_sales,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EV/Revenue</span><span class="ratio-value">${s(t.ev_to_revenue,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EV/EBITDA</span><span class="ratio-value">${s(t.ev_to_ebitda,"ratio")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">PROFITABILITY</div>
                <div class="ratio-row"><span class="ratio-label">Profit Margin</span><span class="ratio-value ${C(t.profit_margin)}">${s(t.profit_margin,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Operating Margin</span><span class="ratio-value ${C(t.operating_margin)}">${s(t.operating_margin,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">ROA</span><span class="ratio-value ${C(t.return_on_assets)}">${s(t.return_on_assets,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">ROE</span><span class="ratio-value ${C(t.return_on_equity)}">${s(t.return_on_equity,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EPS (TTM)</span><span class="ratio-value">${s(t.eps,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EPS Forward</span><span class="ratio-value">${s(t.eps_forward,"ratio")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">GROWTH</div>
                <div class="ratio-row"><span class="ratio-label">Revenue Growth (QoQ)</span><span class="ratio-value ${C(t.quarterly_revenue_growth)}">${s(t.quarterly_revenue_growth,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Earnings Growth (QoQ)</span><span class="ratio-value ${C(t.quarterly_earnings_growth)}">${s(t.quarterly_earnings_growth,"percent")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">INCOME STATEMENT</div>
                <div class="ratio-row"><span class="ratio-label">Revenue</span><span class="ratio-value">${s(t.revenue,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Revenue/Share</span><span class="ratio-value">${s(t.revenue_per_share,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Gross Profit</span><span class="ratio-value">${s(t.gross_profit,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EBITDA</span><span class="ratio-value">${s(t.ebitda,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Net Income</span><span class="ratio-value">${s(t.net_income,"currency")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">BALANCE SHEET</div>
                <div class="ratio-row"><span class="ratio-label">Total Cash</span><span class="ratio-value">${s(t.total_cash,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Total Debt</span><span class="ratio-value">${s(t.total_debt,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Debt/Equity</span><span class="ratio-value">${s(t.debt_to_equity,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Current Ratio</span><span class="ratio-value">${s(t.current_ratio,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Book Value</span><span class="ratio-value">${s(t.book_value,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Enterprise Value</span><span class="ratio-value">${s(t.enterprise_value,"currency")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">CASH FLOW</div>
                <div class="ratio-row"><span class="ratio-label">Operating Cash Flow</span><span class="ratio-value">${s(t.operating_cash_flow,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Free Cash Flow</span><span class="ratio-value">${s(t.free_cash_flow,"currency")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">STOCK INFO</div>
                <div class="ratio-row"><span class="ratio-label">Beta</span><span class="ratio-value">${s(t.beta,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Shares Outstanding</span><span class="ratio-value">${s(t.shares_outstanding,"number")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Float</span><span class="ratio-value">${s(t.float_shares,"number")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Insider Ownership</span><span class="ratio-value">${s(t.held_by_insiders,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Institutional Ownership</span><span class="ratio-value">${s(t.held_by_institutions,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Short Ratio</span><span class="ratio-value">${s(t.short_ratio,"ratio")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">DIVIDENDS</div>
                <div class="ratio-row"><span class="ratio-label">Dividend Rate</span><span class="ratio-value">${s(t.dividend_rate,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Dividend Yield</span><span class="ratio-value">${s(t.dividend_yield,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Payout Ratio</span><span class="ratio-value">${s(t.payout_ratio,"percent")}</span></div>
            </div>
        `}setupIndexModal(){let t=document.querySelector('[data-fn="INDEX"]'),e=document.getElementById("index-modal-close"),s=this.indexModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.openIndexModal()),e?.addEventListener("click",()=>this.closeIndexModal()),s?.addEventListener("click",()=>this.closeIndexModal()),document.addEventListener("keydown",n=>{n.key==="Escape"&&!this.indexModal.classList.contains("hidden")&&this.closeIndexModal()})}async openIndexModal(){let t=document.getElementById("index-loading"),e=document.getElementById("index-body");t&&(t.style.display="block"),e&&(e.innerHTML=""),this.indexModal.classList.remove("hidden");try{let s=await fetch("/api/indices");if(!s.ok)throw new Error("Failed to fetch");let n=await s.json();this.renderIndices(n)}catch{e&&(e.innerHTML='<div class="ratios-loading">Failed to load indices</div>')}finally{t&&(t.style.display="none")}}closeIndexModal(){this.indexModal.classList.add("hidden")}setupIndexChartModal(){let t=document.getElementById("index-chart-modal-close"),e=this.indexChartModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.closeIndexChartModal()),e?.addEventListener("click",()=>this.closeIndexChartModal()),this.indexChartModal.querySelectorAll(".chart-btn").forEach(s=>{s.addEventListener("click",n=>{let a=n.target,l=parseInt(a.dataset.days||"30",10);this.indexChartModal.querySelectorAll(".chart-btn").forEach(d=>d.classList.remove("active")),a.classList.add("active"),this.currentIndexSymbol&&(this.currentIndexDays=l,this.loadIndexChartData(this.currentIndexSymbol,l))})}),document.addEventListener("keydown",s=>{s.key==="Escape"&&!this.indexChartModal.classList.contains("hidden")&&this.closeIndexChartModal()})}async openIndexChartModal(t,e){this.currentIndexSymbol=t,this.currentIndexName=e,this.currentIndexDays=30;let s=document.getElementById("index-chart-title"),n=document.getElementById("index-chart-loading"),a=document.getElementById("index-chart-container");s&&(s.textContent=`${e} (${t})`),n&&(n.style.display="block"),a&&(a.innerHTML=""),this.indexChartModal.querySelectorAll(".chart-btn").forEach(l=>{l.classList.toggle("active",l.getAttribute("data-days")==="30")}),this.indexChartModal.classList.remove("hidden"),await this.loadIndexChartData(t,30)}closeIndexChartModal(){this.indexChartModal.classList.add("hidden"),this.indexChart&&(this.indexChart.remove(),this.indexChart=null,this.indexCandleSeries=null),this.currentIndexSymbol=null,this.currentIndexName=null}async loadIndexChartData(t,e){let s=document.getElementById("index-chart-loading"),n=document.getElementById("index-chart-container");s&&(s.style.display="block");try{let a=await fetch(`/api/chart/${encodeURIComponent(t)}?days=${e}`);if(!a.ok)throw new Error("Failed to fetch chart data");let l=await a.json();this.renderIndexChart(l)}catch{n&&(n.innerHTML='<div class="ratios-loading">Failed to load chart data</div>')}finally{s&&(s.style.display="none")}}renderIndexChart(t){let e=document.getElementById("index-chart-container");if(!e)return;if(this.indexChart&&(this.indexChart.remove(),this.indexChart=null,this.indexCandleSeries=null),e.innerHTML="",t.points.length===0){e.innerHTML='<div class="ratios-loading">No chart data available</div>';return}this.indexChart=LightweightCharts.createChart(e,{width:e.clientWidth,height:400,layout:{background:{color:"#1a1a1a"},textColor:"#ff9900"},grid:{vertLines:{color:"rgba(255, 153, 0, 0.1)"},horzLines:{color:"rgba(255, 153, 0, 0.1)"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"rgba(255, 153, 0, 0.3)"},timeScale:{borderColor:"rgba(255, 153, 0, 0.3)",timeVisible:!0,secondsVisible:!1}}),this.indexCandleSeries=this.indexChart.addCandlestickSeries({upColor:"#00ff00",downColor:"#ff3333",borderUpColor:"#00ff00",borderDownColor:"#ff3333",wickUpColor:"#00ff00",wickDownColor:"#ff3333"});let s=t.points.map(a=>({time:a.timestamp,open:a.open,high:a.high,low:a.low,close:a.close}));this.indexCandleSeries.setData(s),this.indexChart.timeScale().fitContent(),new ResizeObserver(()=>{this.indexChart&&e&&this.indexChart.applyOptions({width:e.clientWidth})}).observe(e)}renderIndices(t){let e=document.getElementById("index-body");if(!e)return;let n=(m=>{let i=new Map,o=["US","UK","Germany","France","Europe","Netherlands","Spain","Italy","Switzerland","Japan","Hong Kong","China","Australia","South Korea","Taiwan","India","Singapore","Brazil","Mexico","Canada"];for(let r of o){let y=m.filter(g=>g.region===r);y.length>0&&i.set(r,y)}return i})(t),a="",l={US:"UNITED STATES",UK:"UNITED KINGDOM",Germany:"GERMANY",France:"FRANCE",Europe:"EUROPE",Netherlands:"NETHERLANDS",Spain:"SPAIN",Italy:"ITALY",Switzerland:"SWITZERLAND",Japan:"JAPAN","Hong Kong":"HONG KONG",China:"CHINA",Australia:"AUSTRALIA","South Korea":"SOUTH KOREA",Taiwan:"TAIWAN",India:"INDIA",Singapore:"SINGAPORE",Brazil:"BRAZIL",Mexico:"MEXICO",Canada:"CANADA"},d=m=>m.replace(/&/g,"").replace(/"/g,"").replace(/'/g,"").replace(/</g,"").replace(/>/g,"");n.forEach((m,i)=>{a+=`<div class="index-section">
                <div class="index-section-title">${l[i]||i}</div>`;for(let o of m){let r=o.change>=0?"positive":"negative",y=o.change>=0?"+":"";a+=`
                <div class="index-row clickable" data-symbol="${d(o.symbol)}" data-name="${d(o.name)}">
                    <div class="index-info">
                        <span class="index-symbol">${d(o.symbol)}</span>
                        <span class="index-name">${d(o.name)}</span>
                    </div>
                    <div class="index-data">
                        <span class="index-price">${o.price.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
                        <span class="index-change ${r}">${y}${o.change.toFixed(2)}</span>
                        <span class="index-percent ${r}">${y}${o.change_percent.toFixed(2)}%</span>
                    </div>
                </div>`}a+="</div>"}),e.innerHTML=a,e.querySelectorAll(".index-row.clickable").forEach(m=>{m.addEventListener("click",()=>{let i=m.getAttribute("data-symbol"),o=m.getAttribute("data-name");i&&o&&this.openIndexChartModal(i,o)})})}setupStatementsModal(){let t=document.getElementById("statements-btn"),e=document.getElementById("statements-modal-close"),s=this.statementsModal.querySelector(".modal-overlay"),n=document.getElementById("statements-currency-toggle"),a=this.statementsModal.querySelectorAll(".stmt-period-tab");t?.addEventListener("click",()=>this.openStatementsModal()),e?.addEventListener("click",()=>this.closeStatementsModal()),s?.addEventListener("click",()=>this.closeStatementsModal()),n?.addEventListener("click",()=>this.toggleStatementsCurrency()),this.statementsModal.querySelectorAll(".stmt-tab").forEach(l=>{l.addEventListener("click",d=>{let m=d.target,i=m.dataset.tab;this.currentTab=i,this.statementsModal.querySelectorAll(".stmt-tab").forEach(o=>o.classList.remove("active")),m.classList.add("active"),this.statementsData&&this.renderStatements(this.statementsData)})}),a.forEach(l=>{l.addEventListener("click",d=>{let i=d.target.dataset.period;i&&(this.statementsPeriodMode=i,this.updateStatementsPeriodUI(),this.statementsData&&this.renderStatements(this.statementsData))})}),document.addEventListener("keydown",l=>{l.key==="Escape"&&!this.statementsModal.classList.contains("hidden")&&this.closeStatementsModal()})}setupGovtModal(){let t=document.querySelector('[data-fn="GOVT"]'),e=document.getElementById("govt-modal-close"),s=document.getElementById("govt-refresh-btn"),n=this.govtModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.openGovtModal()),e?.addEventListener("click",()=>this.closeGovtModal()),s?.addEventListener("click",()=>this.refreshTreasury()),n?.addEventListener("click",()=>this.closeGovtModal()),document.addEventListener("keydown",a=>{a.key==="Escape"&&!this.govtModal.classList.contains("hidden")&&this.closeGovtModal()})}async openGovtModal(){let t=document.getElementById("govt-loading"),e=document.getElementById("govt-body");t&&(t.style.display="block"),e&&(e.innerHTML=""),this.govtModal.classList.remove("hidden");try{let s=await fetch("/api/treasury");if(!s.ok)throw new Error("Failed to fetch");let n=await s.json();this.renderTreasury(n)}catch{e&&(e.innerHTML='<div class="ratios-loading">Failed to load treasury rates</div>')}finally{t&&(t.style.display="none")}}closeGovtModal(){this.govtModal.classList.add("hidden")}async refreshTreasury(){let t=document.getElementById("govt-loading"),e=document.getElementById("govt-body"),s=document.getElementById("govt-refresh-btn");s&&(s.classList.add("spinning"),s.disabled=!0),t&&(t.style.display="block"),e&&(e.innerHTML="");try{let n=await fetch("/api/treasury/refresh",{method:"POST"});if(!n.ok)throw new Error("Failed to refresh");let a=await n.json();this.renderTreasury(a)}catch{e&&(e.innerHTML='<div class="ratios-loading">Failed to refresh treasury rates</div>')}finally{t&&(t.style.display="none"),s&&(s.classList.remove("spinning"),s.disabled=!1)}}renderTreasury(t){let e=document.getElementById("govt-body");if(!e)return;let s=t.rates.filter(i=>["1 Mo","1.5 Month","2 Mo","3 Mo","4 Mo","6 Mo"].includes(i.maturity)),n=t.rates.filter(i=>["1 Yr","2 Yr","3 Yr","5 Yr","7 Yr","10 Yr","20 Yr","30 Yr"].includes(i.maturity)),a=i=>{let o=i.change>=0?"positive":"negative",r=i.change>=0?"+":"";return`
                <div class="treasury-row">
                    <span class="treasury-maturity">${i.maturity}</span>
                    <span class="treasury-yield">${i.yield_rate.toFixed(2)}%</span>
                    <span class="treasury-change ${o}">${r}${i.change.toFixed(2)}</span>
                    <span class="treasury-pct ${o}">${r}${i.change_percent.toFixed(2)}%</span>
                </div>
            `},l="";s.length>0&&(l+=`
                <div class="treasury-section">
                    <div class="treasury-section-title">SHORT-TERM (BILLS)</div>
                    <div class="treasury-header">
                        <span>Maturity</span>
                        <span>Yield</span>
                        <span>Chg</span>
                        <span>Chg %</span>
                    </div>
                    ${s.map(a).join("")}
                </div>
            `),n.length>0&&(l+=`
                <div class="treasury-section">
                    <div class="treasury-section-title">LONG-TERM (NOTES & BONDS)</div>
                    <div class="treasury-header">
                        <span>Maturity</span>
                        <span>Yield</span>
                        <span>Chg</span>
                        <span>Chg %</span>
                    </div>
                    ${n.map(a).join("")}
                </div>
            `);let d=t.rates.find(i=>i.maturity==="10 Yr"),m=t.rates.find(i=>i.maturity==="2 Yr");if(d&&m){let i=d.yield_rate-m.yield_rate,o=i>=0?"positive":"negative";l+=`
                <div class="treasury-section">
                    <div class="treasury-section-title">YIELD CURVE</div>
                    <div class="treasury-row">
                        <span class="treasury-maturity">10Y-2Y Spread</span>
                        <span class="treasury-yield ${o}">${i>=0?"+":""}${(i*100).toFixed(0)} bps</span>
                        <span class="treasury-change"></span>
                        <span class="treasury-pct"></span>
                    </div>
                </div>
            `}l+=`<div class="treasury-updated">Last updated: ${new Date(t.updated_at).toLocaleString()}</div>`,e.innerHTML=l,e.querySelectorAll(".treasury-row").forEach(i=>{let o=i.querySelector(".treasury-maturity");if(o){let r=o.textContent;r&&!r.includes("Spread")&&(i.classList.add("clickable"),i.addEventListener("click",()=>this.openTreasuryChartModal(r)))}})}setupTreasuryChartModal(){let t=document.getElementById("treasury-chart-modal-close"),e=this.treasuryChartModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.closeTreasuryChartModal()),e?.addEventListener("click",()=>this.closeTreasuryChartModal()),document.addEventListener("keydown",s=>{s.key==="Escape"&&!this.treasuryChartModal.classList.contains("hidden")&&this.closeTreasuryChartModal()}),this.treasuryChartModal.querySelectorAll(".treasury-range-btn").forEach(s=>{s.addEventListener("click",n=>{let a=n.target,l=parseInt(a.dataset.days||"365",10);this.treasuryChartModal.querySelectorAll(".treasury-range-btn").forEach(d=>d.classList.remove("active")),a.classList.add("active"),this.currentTreasuryDays=l,this.currentTreasuryMaturity&&this.loadTreasuryHistory(this.currentTreasuryMaturity,l)})})}async openTreasuryChartModal(t){this.currentTreasuryMaturity=t,this.currentTreasuryDays=365;let e=document.getElementById("treasury-chart-title"),s=document.getElementById("treasury-chart-loading"),n=document.getElementById("treasury-chart-container");e&&(e.textContent=`${t} Treasury Yield History`),s&&(s.style.display="block"),n&&(n.innerHTML=""),this.treasuryChartModal.querySelectorAll(".treasury-range-btn").forEach(a=>{a.classList.toggle("active",a.getAttribute("data-days")==="365")}),this.treasuryChartModal.classList.remove("hidden"),await this.loadTreasuryHistory(t,365)}closeTreasuryChartModal(){this.treasuryChartModal.classList.add("hidden"),this.treasuryChart&&(this.treasuryChart.remove(),this.treasuryChart=null,this.treasuryLineSeries=null),this.currentTreasuryMaturity=null}async loadTreasuryHistory(t,e){let s=document.getElementById("treasury-chart-loading"),n=document.getElementById("treasury-chart-container");s&&(s.style.display="block");try{let a=encodeURIComponent(t),l=await fetch(`/api/treasury/history/${a}?days=${e}`);if(!l.ok)throw new Error("Failed to fetch treasury history");let d=await l.json();this.renderTreasuryChart(d)}catch{n&&(n.innerHTML='<div class="ratios-loading">Failed to load treasury history</div>')}finally{s&&(s.style.display="none")}}renderTreasuryChart(t){let e=document.getElementById("treasury-chart-container");if(!e)return;if(this.treasuryChart&&(this.treasuryChart.remove(),this.treasuryChart=null,this.treasuryLineSeries=null),e.innerHTML="",t.points.length===0){e.innerHTML='<div class="ratios-loading">No historical data available</div>';return}this.treasuryChart=LightweightCharts.createChart(e,{width:e.clientWidth,height:400,layout:{background:{color:"#1a1a1a"},textColor:"#ff9900"},grid:{vertLines:{color:"rgba(255, 153, 0, 0.1)"},horzLines:{color:"rgba(255, 153, 0, 0.1)"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"rgba(255, 153, 0, 0.3)"},timeScale:{borderColor:"rgba(255, 153, 0, 0.3)",timeVisible:!0,secondsVisible:!1}}),this.treasuryLineSeries=this.treasuryChart.addLineSeries({color:"#ff9900",lineWidth:2,crosshairMarkerVisible:!0,crosshairMarkerRadius:4,priceFormat:{type:"price",precision:2,minMove:.01}});let s=t.points.map(a=>({time:a.date,value:a.yield_rate}));this.treasuryLineSeries.setData(s),this.treasuryChart.timeScale().fitContent(),new ResizeObserver(()=>{this.treasuryChart&&e&&this.treasuryChart.applyOptions({width:e.clientWidth})}).observe(e)}setupBondsModal(){let t=document.querySelector('[data-fn="INTL"]'),e=document.getElementById("bonds-modal-close"),s=this.bondsModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.openBondsModal()),e?.addEventListener("click",()=>this.closeBondsModal()),s?.addEventListener("click",()=>this.closeBondsModal()),document.addEventListener("keydown",n=>{n.key==="Escape"&&!this.bondsModal.classList.contains("hidden")&&this.closeBondsModal()})}async openBondsModal(){let t=document.getElementById("bonds-loading"),e=document.getElementById("bonds-body"),s=document.getElementById("bonds-date");t&&(t.style.display="block"),e&&(e.innerHTML=""),this.bondsModal.classList.remove("hidden");try{let n=await fetch("/api/bonds");if(!n.ok)throw new Error("Failed to fetch");let a=await n.json();s&&(s.textContent=`Updated: ${new Date(a.updated_at).toLocaleString()}`),this.renderBonds(a)}catch{e&&(e.innerHTML='<div class="ratios-loading">Failed to load bond yields</div>')}finally{t&&(t.style.display="none")}}closeBondsModal(){this.bondsModal.classList.add("hidden")}renderBonds(t){let e=document.getElementById("bonds-body");if(!e)return;let s=["CN"],n=o=>{let r=o.change>=0?"positive":"negative",y=o.change>=0?"+":"",g=o.data_frequency==="daily"?"freq-daily":"freq-monthly",h=!s.includes(o.country_code)&&o.maturity==="10Y",f=h?"clickable":"",v=h||o.maturity!=="10Y"?"":'title="Historical chart not available"';return`
                <div class="bonds-row ${f}" data-country="${o.country}" data-country-code="${o.country_code}" ${v}>
                    <div class="bonds-info">
                        <span class="bonds-country">${o.country}<span class="bonds-freq ${g}" title="${o.data_frequency} data"></span></span>
                        <span class="bonds-code">${o.country_code}</span>
                    </div>
                    <div class="bonds-data">
                        <span class="bonds-yield">${o.yield_value.toFixed(2)}%</span>
                        <span class="bonds-change ${r}">${y}${o.change.toFixed(2)}</span>
                        <span class="bonds-pct ${r}">${y}${o.change_percent.toFixed(2)}%</span>
                    </div>
                </div>
            `},a=t.bonds.filter(o=>o.maturity==="10Y"),l=t.bonds.filter(o=>o.maturity==="20Y"),d=t.bonds.filter(o=>o.maturity==="30Y"),m=(o,r)=>r.length===0?"":`
                <div class="bonds-section">
                    <div class="bonds-header">
                        <span>Country</span>
                        <span>${o} Yield</span>
                        <span>Chg</span>
                        <span>Chg %</span>
                    </div>
                    ${r.map(n).join("")}
                </div>
            `,i=`
            ${m("10Y",a)}
            ${m("20Y",l)}
            ${m("30Y",d)}
            <div class="bonds-legend">
                <span class="bonds-freq freq-daily"></span> Daily
                <span class="bonds-freq freq-monthly" style="margin-left: 8px;"></span> Monthly
            </div>
        `;e.innerHTML=i,e.querySelectorAll(".bonds-row.clickable").forEach(o=>{o.addEventListener("click",()=>{let r=o.dataset.country,y=o.dataset.countryCode;r&&y&&this.openBondsChartModal(r,y)})})}setupBondsChartModal(){let t=document.getElementById("bonds-chart-modal-close"),e=this.bondsChartModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.closeBondsChartModal()),e?.addEventListener("click",()=>this.closeBondsChartModal()),document.addEventListener("keydown",s=>{s.key==="Escape"&&!this.bondsChartModal.classList.contains("hidden")&&this.closeBondsChartModal()}),this.bondsChartModal.querySelectorAll(".bonds-range-btn").forEach(s=>{s.addEventListener("click",n=>{let a=n.target,l=parseInt(a.dataset.years||"10",10);this.bondsChartModal.querySelectorAll(".bonds-range-btn").forEach(d=>d.classList.remove("active")),a.classList.add("active"),this.currentBondYears=l,this.currentBondCountryCode&&this.loadBondHistory(this.currentBondCountryCode,l)})})}async openBondsChartModal(t,e){this.currentBondCountry=t,this.currentBondCountryCode=e,this.currentBondYears=10;let s=document.getElementById("bonds-chart-title"),n=document.getElementById("bonds-chart-loading"),a=document.getElementById("bonds-chart-container");s&&(s.textContent=`${t} 10 Year Bond Yield History`),n&&(n.style.display="block"),a&&(a.innerHTML=""),this.bondsChartModal.querySelectorAll(".bonds-range-btn").forEach(l=>{l.classList.toggle("active",l.getAttribute("data-years")==="10")}),this.bondsChartModal.classList.remove("hidden"),await this.loadBondHistory(e,10)}closeBondsChartModal(){this.bondsChartModal.classList.add("hidden"),this.bondsChart&&(this.bondsChart.remove(),this.bondsChart=null,this.bondsLineSeries=null),this.currentBondCountry=null,this.currentBondCountryCode=null}async loadBondHistory(t,e){let s=document.getElementById("bonds-chart-loading"),n=document.getElementById("bonds-chart-container"),a=document.getElementById("bonds-chart-notice");s&&(s.style.display="block");try{let l=await fetch(`/api/bonds/history/${t}?years=${e}`);if(!l.ok)throw new Error("Failed to fetch bond history");let d=await l.json();a&&(a.textContent=d.data_delay),this.renderBondsChart(d)}catch{n&&(n.innerHTML='<div class="ratios-loading">Failed to load bond history</div>')}finally{s&&(s.style.display="none")}}renderBondsChart(t){let e=document.getElementById("bonds-chart-container");if(!e)return;if(this.bondsChart&&(this.bondsChart.remove(),this.bondsChart=null,this.bondsLineSeries=null),e.innerHTML="",t.points.length===0){e.innerHTML='<div class="ratios-loading">No historical data available</div>';return}this.bondsChart=LightweightCharts.createChart(e,{width:e.clientWidth,height:400,layout:{background:{color:"#1a1a1a"},textColor:"#ff9900"},grid:{vertLines:{color:"rgba(255, 153, 0, 0.1)"},horzLines:{color:"rgba(255, 153, 0, 0.1)"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"rgba(255, 153, 0, 0.3)"},timeScale:{borderColor:"rgba(255, 153, 0, 0.3)",timeVisible:!0,secondsVisible:!1}}),this.bondsLineSeries=this.bondsChart.addLineSeries({color:"#ff9900",lineWidth:2,crosshairMarkerVisible:!0,crosshairMarkerRadius:4,priceFormat:{type:"price",precision:2,minMove:.01}});let s=t.points.map(a=>({time:a.date,value:a.yield_rate}));this.bondsLineSeries.setData(s),this.bondsChart.timeScale().fitContent(),new ResizeObserver(()=>{this.bondsChart&&e&&this.bondsChart.applyOptions({width:e.clientWidth})}).observe(e)}setupCommoditiesModal(){let t=document.querySelector('[data-fn="CMDTY"]'),e=document.getElementById("commodities-modal-close"),s=this.commoditiesModal?.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.openCommoditiesModal()),e?.addEventListener("click",()=>this.closeCommoditiesModal()),s?.addEventListener("click",()=>this.closeCommoditiesModal()),document.addEventListener("keydown",n=>{n.key==="Escape"&&!this.commoditiesModal?.classList.contains("hidden")&&this.closeCommoditiesModal()})}async openCommoditiesModal(){let t=document.getElementById("commodities-loading"),e=document.getElementById("commodities-body");t&&(t.style.display="block"),e&&(e.innerHTML=""),this.commoditiesModal.classList.remove("hidden");try{let s=await fetch("/api/commodities");if(!s.ok)throw new Error("Failed to fetch");let n=await s.json();this.renderCommodities(n)}catch{e&&(e.innerHTML='<div class="ratios-loading">Failed to load commodities</div>')}finally{t&&(t.style.display="none")}}closeCommoditiesModal(){this.commoditiesModal.classList.add("hidden")}setupCommodityChartModal(){let t=document.getElementById("commodity-chart-modal-close"),e=this.commodityChartModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.closeCommodityChartModal()),e?.addEventListener("click",()=>this.closeCommodityChartModal()),this.commodityChartModal.querySelectorAll(".chart-btn").forEach(s=>{s.addEventListener("click",n=>{let a=n.target,l=parseInt(a.dataset.days||"30",10);this.commodityChartModal.querySelectorAll(".chart-btn").forEach(d=>d.classList.remove("active")),a.classList.add("active"),this.currentCommoditySymbol&&(this.currentCommodityDays=l,this.loadCommodityChartData(this.currentCommoditySymbol,l))})}),document.addEventListener("keydown",s=>{s.key==="Escape"&&!this.commodityChartModal.classList.contains("hidden")&&this.closeCommodityChartModal()})}async openCommodityChartModal(t,e){this.currentCommoditySymbol=t,this.currentCommodityName=e,this.currentCommodityDays=30;let s=document.getElementById("commodity-chart-title"),n=document.getElementById("commodity-chart-loading"),a=document.getElementById("commodity-chart-container");s&&(s.textContent=`${e} (${t})`),n&&(n.style.display="block"),a&&(a.innerHTML=""),this.commodityChartModal.querySelectorAll(".chart-btn").forEach(l=>{l.classList.toggle("active",l.getAttribute("data-days")==="30")}),this.commodityChartModal.classList.remove("hidden"),await this.loadCommodityChartData(t,30)}closeCommodityChartModal(){this.commodityChartModal.classList.add("hidden"),this.commodityChart&&(this.commodityChart.remove(),this.commodityChart=null,this.commodityCandleSeries=null),this.currentCommoditySymbol=null,this.currentCommodityName=null}async loadCommodityChartData(t,e){let s=document.getElementById("commodity-chart-loading"),n=document.getElementById("commodity-chart-container");s&&(s.style.display="block");try{let a=await fetch(`/api/chart/${encodeURIComponent(t)}?days=${e}`);if(!a.ok)throw new Error("Failed to fetch chart data");let l=await a.json();this.renderCommodityChart(l)}catch{n&&(n.innerHTML='<div class="ratios-loading">Failed to load chart data</div>')}finally{s&&(s.style.display="none")}}renderCommodityChart(t){let e=document.getElementById("commodity-chart-container");if(!e)return;if(this.commodityChart&&(this.commodityChart.remove(),this.commodityChart=null,this.commodityCandleSeries=null),e.innerHTML="",t.points.length===0){e.innerHTML='<div class="ratios-loading">No chart data available</div>';return}this.commodityChart=LightweightCharts.createChart(e,{width:e.clientWidth,height:400,layout:{background:{color:"#1a1a1a"},textColor:"#ff9900"},grid:{vertLines:{color:"rgba(255, 153, 0, 0.1)"},horzLines:{color:"rgba(255, 153, 0, 0.1)"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"rgba(255, 153, 0, 0.3)"},timeScale:{borderColor:"rgba(255, 153, 0, 0.3)",timeVisible:!0,secondsVisible:!1}}),this.commodityCandleSeries=this.commodityChart.addCandlestickSeries({upColor:"#00ff00",downColor:"#ff3333",borderUpColor:"#00ff00",borderDownColor:"#ff3333",wickUpColor:"#00ff00",wickDownColor:"#ff3333"});let s=t.points.map(a=>({time:a.timestamp,open:a.open,high:a.high,low:a.low,close:a.close}));this.commodityCandleSeries.setData(s),this.commodityChart.timeScale().fitContent(),new ResizeObserver(()=>{this.commodityChart&&e&&this.commodityChart.applyOptions({width:e.clientWidth})}).observe(e)}renderCommodities(t){let e=document.getElementById("commodities-body");if(!e)return;let s=[...new Set(t.commodities.map(d=>d.category))],n=d=>d.replace(/&/g,"").replace(/"/g,"").replace(/'/g,"").replace(/</g,"").replace(/>/g,""),a=d=>{let m=d.change>=0?"positive":"negative",i=d.change>=0?"+":"";return`
                <div class="commodity-row clickable" data-symbol="${n(d.symbol)}" data-name="${n(d.name)}">
                    <div class="commodity-info">
                        <span class="commodity-name">${n(d.name)}</span>
                        <span class="commodity-unit">${d.unit}</span>
                    </div>
                    <div class="commodity-data">
                        <span class="commodity-price">${d.price.toFixed(2)}</span>
                        <span class="commodity-change ${m}">${i}${d.change.toFixed(2)}</span>
                        <span class="commodity-pct ${m}">${i}${d.change_percent.toFixed(2)}%</span>
                    </div>
                </div>
            `},l="";for(let d of s){let m=t.commodities.filter(i=>i.category===d);l+=`
                <div class="commodity-section">
                    <div class="commodity-category">${d}</div>
                    ${m.map(a).join("")}
                </div>
            `}e.innerHTML=l,e.querySelectorAll(".commodity-row.clickable").forEach(d=>{d.addEventListener("click",()=>{let m=d.getAttribute("data-symbol"),i=d.getAttribute("data-name");m&&i&&this.openCommodityChartModal(m,i)})})}async openStatementsModal(){if(!this.currentSymbol)return;let t=document.getElementById("statements-loading"),e=document.getElementById("statements-body"),s=document.getElementById("statements-modal-title");s&&(s.textContent=`${this.currentSymbol} - Financial Statements`),t&&(t.style.display="block"),e&&(e.innerHTML=""),this.statementsCurrencyMode="local",this.statementsCurrencyCode=null,this.statementsCurrencySymbol=null,this.statementsUsdRate=null,this.statementsPeriodMode="annual",this.updateStatementsCurrencyUI(),this.updateStatementsPeriodUI(),this.statementsModal.classList.remove("hidden");try{let n=await fetch(`/api/statements/${this.currentSymbol}`);if(!n.ok)throw new Error("Failed to fetch");let a=await n.json();this.statementsData=a,this.setStatementsCurrencyMeta(a),this.renderStatements(a)}catch{e&&(e.innerHTML='<div class="ratios-loading">Failed to load financial statements</div>')}finally{t&&(t.style.display="none")}}closeStatementsModal(){this.statementsModal.classList.add("hidden")}setStatementsCurrencyMeta(t){let e=(t.currency||"USD").toUpperCase();this.statementsCurrencyCode=e,this.statementsCurrencySymbol=w(e),this.statementsUsdRate=t.usd_fx_rate??null}toggleStatementsCurrency(){!this.statementsData||!this.statementsCurrencyCode||!this.statementsUsdRate||this.statementsCurrencyCode==="USD"||(this.statementsCurrencyMode=this.statementsCurrencyMode==="local"?"usd":"local",this.renderStatements(this.statementsData))}formatFxRate(t){return t<.01?t.toFixed(6):t.toFixed(4)}updateStatementsCurrencyUI(){let t=document.getElementById("statements-currency-meta"),e=document.getElementById("statements-currency-note"),s=document.getElementById("statements-currency-toggle"),n=document.getElementById("statements-currency-rate"),a=this.statementsCurrencyCode,l=this.statementsCurrencySymbol,d=!!(a&&l);if(t&&t.classList.toggle("hidden",!d),!d){e&&(e.textContent=""),s&&(s.style.display="none"),n&&(n.textContent="");return}let m=this.statementsCurrencyMode==="usd",i=m?"USD":a,o=m?"$":l;e&&(e.textContent=`All figures in ${i} (${o})`);let r=!!this.statementsUsdRate&&a!=="USD";s&&(s.style.display=r?"inline-flex":"none",r&&(s.textContent=m?`View in ${a}`:"Convert to USD")),n&&(m&&r&&this.statementsUsdRate?(n.textContent=`Rate: 1 ${a} = ${this.formatFxRate(this.statementsUsdRate)} USD`,n.classList.remove("hidden")):(n.textContent="",n.classList.add("hidden")))}updateStatementsPeriodUI(){this.statementsModal.querySelectorAll(".stmt-period-tab").forEach(t=>{let e=t,s=e.dataset.period;e.classList.toggle("active",s===this.statementsPeriodMode)})}renderStatements(t){let e=document.getElementById("statements-body");if(!e)return;(!this.statementsCurrencyCode||!this.statementsCurrencySymbol)&&this.setStatementsCurrencyMeta(t);let s=this.statementsCurrencyMode==="usd"&&this.statementsUsdRate!==null,n=s?"$":this.statementsCurrencySymbol||"$",a=this.statementsUsdRate??1,l=r=>I(s&&r!==null?r*a:r,n),d=this.statementsPeriodMode==="quarterly",m=r=>r.some(y=>y!=null&&y!==0),i=(r,y,g=!1)=>{if(!m(y))return"";let h=g?' class="stmt-highlight"':"",f=s?y.map(v=>v===null?null:v*a):y;return`<tr${h}><td>${r}</td>${f.map(v=>`<td class="${C(v)}">${l(v)}</td>`).join("")}</tr>`},o="";if(this.currentTab==="income"){let r=d?t.income_statements_quarterly:t.income_statements;if(r.length===0)o='<div class="ratios-loading">No income statement data available</div>';else{let y=r.map(h=>h.fiscal_year.split("-")[0]||h.fiscal_year),g=[i("Total Revenue",r.map(h=>h.total_revenue),!0),i("Cost of Revenue",r.map(h=>h.cost_of_revenue)),i("Gross Profit",r.map(h=>h.gross_profit),!0),i("R&D Expenses",r.map(h=>h.research_development)),i("SG&A Expenses",r.map(h=>h.selling_general_admin)),i("Total Operating Expenses",r.map(h=>h.total_operating_expenses)),i("Operating Income",r.map(h=>h.operating_income),!0),i("Interest Expense",r.map(h=>h.interest_expense)),i("Income Before Tax",r.map(h=>h.income_before_tax)),i("Income Tax Expense",r.map(h=>h.income_tax_expense)),i("Net Income",r.map(h=>h.net_income),!0),i("EBIT",r.map(h=>h.ebit)),i("EBITDA",r.map(h=>h.ebitda))].filter(h=>h).join("");o=`
                    <table class="statements-table">
                        <thead>
                            <tr>
                                <th class="stmt-label-col">Item</th>
                                ${y.map(h=>`<th class="stmt-value-col">${h}</th>`).join("")}
                            </tr>
                        </thead>
                        <tbody>${g}</tbody>
                    </table>
                `}}else if(this.currentTab==="balance"){let r=d?t.balance_sheets_quarterly:t.balance_sheets;if(r.length===0)o='<div class="ratios-loading">No balance sheet data available</div>';else{let y=r.map(c=>c.fiscal_year.split("-")[0]||c.fiscal_year),g=[i("Cash & Equivalents",r.map(c=>c.cash_and_equivalents)),i("Short-term Investments",r.map(c=>c.short_term_investments)),i("Accounts Receivable",r.map(c=>c.accounts_receivable)),i("Inventory",r.map(c=>c.inventory)),i("Total Current Assets",r.map(c=>c.total_current_assets),!0),i("Property, Plant & Equipment",r.map(c=>c.property_plant_equipment)),i("Goodwill",r.map(c=>c.goodwill)),i("Intangible Assets",r.map(c=>c.intangible_assets)),i("Total Assets",r.map(c=>c.total_assets),!0)].filter(c=>c).join(""),h=[i("Accounts Payable",r.map(c=>c.accounts_payable)),i("Short-term Debt",r.map(c=>c.short_term_debt)),i("Total Current Liabilities",r.map(c=>c.total_current_liabilities),!0),i("Long-term Debt",r.map(c=>c.long_term_debt)),i("Total Liabilities",r.map(c=>c.total_liabilities),!0)].filter(c=>c).join(""),f=[i("Common Stock",r.map(c=>c.common_stock)),i("Retained Earnings",r.map(c=>c.retained_earnings)),i("Total Stockholders Equity",r.map(c=>c.total_stockholders_equity),!0)].filter(c=>c).join(""),v="";g&&(v+=`<tr class="stmt-section-header"><td colspan="${y.length+1}">ASSETS</td></tr>${g}`),h&&(v+=`<tr class="stmt-section-header"><td colspan="${y.length+1}">LIABILITIES</td></tr>${h}`),f&&(v+=`<tr class="stmt-section-header"><td colspan="${y.length+1}">EQUITY</td></tr>${f}`),v?o=`
                        <table class="statements-table">
                            <thead>
                                <tr>
                                    <th class="stmt-label-col">Item</th>
                                    ${y.map(c=>`<th class="stmt-value-col">${c}</th>`).join("")}
                                </tr>
                            </thead>
                            <tbody>${v}</tbody>
                        </table>
                    `:o='<div class="ratios-loading">No balance sheet data available</div>'}}else if(this.currentTab==="cashflow"){let r=d?t.cash_flows_quarterly:t.cash_flows;if(r.length===0)o='<div class="ratios-loading">No cash flow data available</div>';else{let y=r.map(p=>p.fiscal_year.split("-")[0]||p.fiscal_year),g=[i("Net Income",r.map(p=>p.net_income)),i("Depreciation",r.map(p=>p.depreciation)),i("Change in Working Capital",r.map(p=>p.change_in_working_capital)),i("Operating Cash Flow",r.map(p=>p.operating_cash_flow),!0)].filter(p=>p).join(""),h=[i("Capital Expenditures",r.map(p=>p.capital_expenditures)),i("Investments",r.map(p=>p.investments)),i("Investing Cash Flow",r.map(p=>p.investing_cash_flow),!0)].filter(p=>p).join(""),f=[i("Dividends Paid",r.map(p=>p.dividends_paid)),i("Stock Repurchases",r.map(p=>p.stock_repurchases)),i("Debt Repayment",r.map(p=>p.debt_repayment)),i("Financing Cash Flow",r.map(p=>p.financing_cash_flow),!0)].filter(p=>p).join(""),v=i("Free Cash Flow",r.map(p=>p.free_cash_flow),!0),c="";g&&(c+=`<tr class="stmt-section-header"><td colspan="${y.length+1}">OPERATING ACTIVITIES</td></tr>${g}`),h&&(c+=`<tr class="stmt-section-header"><td colspan="${y.length+1}">INVESTING ACTIVITIES</td></tr>${h}`),f&&(c+=`<tr class="stmt-section-header"><td colspan="${y.length+1}">FINANCING ACTIVITIES</td></tr>${f}`),v&&(c+=`<tr class="stmt-section-header"><td colspan="${y.length+1}">FREE CASH FLOW</td></tr>${v}`),c?o=`
                        <table class="statements-table">
                            <thead>
                                <tr>
                                    <th class="stmt-label-col">Item</th>
                                    ${y.map(p=>`<th class="stmt-value-col">${p}</th>`).join("")}
                                </tr>
                            </thead>
                            <tbody>${c}</tbody>
                        </table>
                    `:o='<div class="ratios-loading">No cash flow data available</div>'}}e.innerHTML=o,this.updateStatementsCurrencyUI()}handleKeydown(t){let e=this.searchResults.querySelectorAll(".search-item");t.key==="ArrowDown"?(t.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,e.length-1),this.updateSelectedItem(e)):t.key==="ArrowUp"?(t.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,-1),this.updateSelectedItem(e)):t.key==="Enter"?(t.preventDefault(),this.selectedIndex>=0&&this.searchResultsData[this.selectedIndex]?this.selectCompany(this.searchResultsData[this.selectedIndex]):this.searchResultsData.length>0&&this.selectCompany(this.searchResultsData[0])):t.key==="Escape"&&(this.searchResults.classList.remove("active"),this.selectedIndex=-1)}updateSelectedItem(t){t.forEach((e,s)=>{e.classList.toggle("selected",s===this.selectedIndex)})}async handleSearch(){let t=this.commandInput.value.trim();if(this.searchTimeout&&clearTimeout(this.searchTimeout),t.length<1){this.searchResults.classList.remove("active"),this.searchResultsData=[];return}this.searchTimeout=window.setTimeout(async()=>{this.setStatus("SEARCHING...");try{let s=await(await fetch(`/api/search?q=${encodeURIComponent(t)}`)).json();this.searchResultsData=s,this.selectedIndex=-1,this.renderSearchResults(s),this.setStatus("READY")}catch{this.setStatus("ERROR")}},150)}renderSearchResults(t){if(t.length===0){this.searchResults.innerHTML='<div class="search-item">No results found</div>',this.searchResults.classList.add("active");return}this.searchResults.innerHTML=t.map((e,s)=>`
            <div class="search-item" data-index="${s}">
                <span class="symbol">${e.symbol}</span>
                <span class="name">${e.name}</span>
            </div>
        `).join(""),this.searchResults.querySelectorAll(".search-item").forEach(e=>{e.addEventListener("click",()=>{let s=parseInt(e.dataset.index||"0",10);this.selectCompany(t[s])})}),this.searchResults.classList.add("active")}selectCompany(t){this.currentSymbol=t.symbol,this.commandInput.value=t.symbol,this.searchResults.classList.remove("active"),this.loadSecurityView(t)}async loadSecurityView(t){this.setStatus("LOADING..."),this.welcomeScreen.classList.add("hidden"),this.securityView.classList.remove("hidden"),await Promise.all([this.loadQuote(t.symbol),this.loadChartData(t.symbol,30),this.loadNews(t.symbol)]),this.renderDescription(t),this.setStatus("READY")}async loadQuote(t){try{let s=await(await fetch(`/api/quote/${t}`)).json();this.renderQuote(s)}catch{console.error("Failed to load quote")}}renderQuote(t){let e=document.getElementById("quote-symbol"),s=document.getElementById("quote-name"),n=document.getElementById("quote-exchange"),a=document.getElementById("quote-price"),l=document.getElementById("quote-change"),d=document.getElementById("quote-details");if(e&&(e.textContent=t.symbol),s&&(s.textContent=t.name),n&&(n.textContent=`\u2022 ${t.symbol.includes(".")?"LSE":"NASDAQ"}`),a&&(a.textContent=t.price.toFixed(2)),l){let m=t.change>=0?"+":"";l.textContent=`${m}${t.change.toFixed(2)} (${m}${t.change_percent.toFixed(2)}%)`,l.className=`change ${t.change>=0?"positive":"negative"}`}d&&(d.innerHTML=`
                <div class="quote-row"><span class="label">Open</span><span class="value">${t.open.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">High</span><span class="value">${t.high.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">Low</span><span class="value">${t.low.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">Volume</span><span class="value">${this.formatNumber(t.volume)}</span></div>
                <div class="quote-row"><span class="label">Mkt Cap</span><span class="value">${this.formatMarketCap(t.market_cap)}</span></div>
                <div class="quote-row"><span class="label">P/E</span><span class="value">${t.pe_ratio?.toFixed(2)||"N/A"}</span></div>
                <div class="quote-row"><span class="label">EPS</span><span class="value">${t.eps?.toFixed(2)||"N/A"}</span></div>
                <div class="quote-row"><span class="label">Div Yield</span><span class="value">${t.dividend_yield?t.dividend_yield.toFixed(2)+"%":"N/A"}</span></div>
                <div class="quote-row"><span class="label">52W High</span><span class="value">${t.week_52_high.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">52W Low</span><span class="value">${t.week_52_low.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">Avg Vol</span><span class="value">${this.formatNumber(t.avg_volume)}</span></div>
            `)}async loadChartData(t,e){try{let n=await(await fetch(`/api/chart/${t}?days=${e}`)).json();this.renderChart(n)}catch{console.error("Failed to load chart data")}}renderChart(t){let e=document.getElementById("chart-container");if(!e)return;this.chart&&this.chart.remove(),this.chart=LightweightCharts.createChart(e,{width:e.clientWidth,height:e.clientHeight,layout:{background:{color:"#111111"},textColor:"#888888"},grid:{vertLines:{color:"#222222"},horzLines:{color:"#222222"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"#333333"},timeScale:{borderColor:"#333333",timeVisible:!0}}),this.candleSeries=this.chart.addCandlestickSeries({upColor:"#00ff00",downColor:"#ff3333",borderUpColor:"#00ff00",borderDownColor:"#ff3333",wickUpColor:"#00ff00",wickDownColor:"#ff3333"});let s=t.points.map(a=>({time:a.timestamp,open:a.open,high:a.high,low:a.low,close:a.close}));this.candleSeries.setData(s),this.chart.timeScale().fitContent(),new ResizeObserver(()=>{this.chart&&e&&this.chart.applyOptions({width:e.clientWidth,height:e.clientHeight})}).observe(e)}async loadNews(t){try{let s=await(await fetch(`/api/news/${t}`)).json();this.renderNews(s)}catch{console.error("Failed to load news")}}renderNews(t){let e=document.getElementById("news-feed");e&&(this.newsData=t.items,e.innerHTML=t.items.map((s,n)=>`
            <div class="news-item">
                <div class="headline" data-news-index="${n}">${s.title}</div>
                <div class="meta">
                    <span>${s.source}</span>
                    <span>${this.formatTime(s.timestamp)}</span>
                    <span class="sentiment ${s.sentiment}">${s.sentiment.toUpperCase()}</span>
                </div>
            </div>
        `).join(""),e.querySelectorAll(".headline").forEach(s=>{s.addEventListener("click",()=>{let n=parseInt(s.dataset.newsIndex||"0",10);this.newsData[n]&&this.openNewsModal(this.newsData[n])})}))}renderDescription(t){let e=document.getElementById("company-description");e&&(e.innerHTML=`
                <p><strong>Sector:</strong> ${t.sector}</p>
                <p><strong>Industry:</strong> ${t.industry}</p>
                <p>${t.description}</p>
            `)}loadQuickTickers(){let t=["AAPL","MSFT","GOOGL","AMZN","NVDA","META","TSLA"];this.tickerList.innerHTML=t.map(e=>`<div class="ticker-item" data-symbol="${e}">${e}</div>`).join(""),this.tickerList.querySelectorAll(".ticker-item").forEach(e=>{e.addEventListener("click",async()=>{let s=e.dataset.symbol;if(s){this.commandInput.value=s;let a=await(await fetch(`/api/search?q=${s}`)).json();a.length>0&&this.selectCompany(a[0])}})})}updateTime(){let t=document.getElementById("current-time");if(t){let e=new Date;t.textContent=e.toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"})}}setStatus(t){this.statusText.textContent=t}formatNumber(t){return E(t)}formatMarketCap(t){return M(t)}formatTime(t){return L(t)}};document.addEventListener("DOMContentLoaded",()=>{});new b;})();
