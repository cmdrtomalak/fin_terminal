"use strict";(()=>{function b(u){return u>=1e9?(u/1e9).toFixed(2)+"B":u>=1e6?(u/1e6).toFixed(2)+"M":u>=1e3?(u/1e3).toFixed(2)+"K":u.toString()}function E(u){return u>=1e12?"$"+(u/1e12).toFixed(2)+"T":u>=1e9?"$"+(u/1e9).toFixed(2)+"B":"$"+(u/1e6).toFixed(2)+"M"}function M(u){let t=new Date(u),s=new Date().getTime()-t.getTime(),i=Math.floor(s/(1e3*60*60));return i<1?"Just now":i<24?`${i}h ago`:t.toLocaleDateString()}function w(u){if(!u)return"$";try{return new Intl.NumberFormat("en",{style:"currency",currency:u,currencyDisplay:"narrowSymbol",minimumFractionDigits:0,maximumFractionDigits:0}).formatToParts(0).find(s=>s.type==="currency")?.value||u}catch{return u}}function L(u,t="$"){if(u==null||isNaN(u))return"\u2014";let e=Math.abs(u),s=u<0?"-":"";return e>=1e9?s+t+(e/1e9).toFixed(1)+"B":e>=1e6?s+t+(e/1e6).toFixed(1)+"M":e>=1e3?s+t+(e/1e3).toFixed(1)+"K":s+t+e.toFixed(0)}function I(u,t="number"){if(u==null||isNaN(u))return"N/A";switch(t){case"percent":return(u*100).toFixed(2)+"%";case"currency":return E(u);case"ratio":return u.toFixed(2);default:return b(u)}}function f(u){return u==null?"":u>=0?"positive":"negative"}var C=class{constructor(){this.treasuryChart=null;this.commodityChart=null;this.commodityCandleSeries=null;this.currentCommoditySymbol=null;this.currentCommodityName=null;this.currentCommodityDays=30;this.indexChart=null;this.indexCandleSeries=null;this.currentIndexSymbol=null;this.currentIndexName=null;this.currentIndexDays=30;this.treasuryLineSeries=null;this.bondsChart=null;this.bondsLineSeries=null;this.currentTreasuryMaturity=null;this.currentTreasuryDays=365;this.currentBondCountry=null;this.currentBondCountryCode=null;this.currentBondYears=10;this.statementsData=null;this.statementsCurrencyMode="local";this.statementsCurrencyCode=null;this.statementsCurrencySymbol=null;this.statementsUsdRate=null;this.currentTab="income";this.currentSymbol=null;this.chart=null;this.candleSeries=null;this.searchTimeout=null;this.selectedIndex=-1;this.searchResultsData=[];this.newsData=[];this.commandInput=document.getElementById("command-input"),this.searchResults=document.getElementById("search-results"),this.welcomeScreen=document.getElementById("welcome-screen"),this.securityView=document.getElementById("security-view"),this.tickerList=document.getElementById("ticker-list"),this.statusText=document.getElementById("status-text"),this.newsModal=document.getElementById("news-modal"),this.ratiosModal=document.getElementById("ratios-modal"),this.indexModal=document.getElementById("index-modal"),this.statementsModal=document.getElementById("statements-modal"),this.govtModal=document.getElementById("govt-modal"),this.treasuryChartModal=document.getElementById("treasury-chart-modal"),this.bondsModal=document.getElementById("bonds-modal"),this.bondsChartModal=document.getElementById("bonds-chart-modal"),this.commoditiesModal=document.getElementById("commodities-modal"),this.indexChartModal=document.getElementById("index-chart-modal"),this.commodityChartModal=document.getElementById("commodity-chart-modal"),this.init()}init(){this.setupEventListeners(),this.setupModalListeners(),this.setupRatiosModal(),this.setupIndexModal(),this.setupIndexChartModal(),this.setupStatementsModal(),this.setupGovtModal(),this.setupTreasuryChartModal(),this.setupBondsModal(),this.setupBondsChartModal(),this.setupCommoditiesModal(),this.setupCommodityChartModal(),this.updateTime(),this.loadQuickTickers(),setInterval(()=>this.updateTime(),1e3)}setupEventListeners(){this.commandInput.addEventListener("input",()=>this.handleSearch()),this.commandInput.addEventListener("keydown",t=>this.handleKeydown(t)),this.commandInput.addEventListener("focus",()=>{this.searchResultsData.length>0&&this.searchResults.classList.add("active")}),document.addEventListener("click",t=>{!this.commandInput.contains(t.target)&&!this.searchResults.contains(t.target)&&this.searchResults.classList.remove("active")}),document.querySelectorAll(".chart-btn").forEach(t=>{t.addEventListener("click",e=>{let s=e.target,i=parseInt(s.dataset.days||"90",10);document.querySelectorAll(".chart-btn").forEach(a=>a.classList.remove("active")),s.classList.add("active"),this.currentSymbol&&this.loadChartData(this.currentSymbol,i)})})}setupModalListeners(){let t=document.getElementById("modal-close"),e=this.newsModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.closeModal()),e?.addEventListener("click",()=>this.closeModal()),document.addEventListener("keydown",s=>{s.key==="Escape"&&!this.newsModal.classList.contains("hidden")&&this.closeModal()})}openNewsModal(t){let e=document.getElementById("modal-title"),s=document.getElementById("modal-source"),i=document.getElementById("modal-timestamp"),a=document.getElementById("modal-sentiment"),o=document.getElementById("modal-body"),d=document.getElementById("modal-link");if(e&&(e.textContent=t.title),s&&(s.textContent=t.source),i&&(i.textContent=this.formatTime(t.timestamp)),a&&(a.textContent=t.sentiment,a.className=`modal-sentiment ${t.sentiment}`),o){let r=t.content||t.summary;o.innerHTML=r.split(`

`).map(l=>`<p>${l}</p>`).join("")}d&&(d.href=t.url),this.newsModal.classList.remove("hidden")}closeModal(){this.newsModal.classList.add("hidden")}setupRatiosModal(){let t=document.getElementById("ratios-btn"),e=document.getElementById("ratios-modal-close"),s=this.ratiosModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.openRatiosModal()),e?.addEventListener("click",()=>this.closeRatiosModal()),s?.addEventListener("click",()=>this.closeRatiosModal()),document.addEventListener("keydown",i=>{i.key==="Escape"&&!this.ratiosModal.classList.contains("hidden")&&this.closeRatiosModal()})}async openRatiosModal(){if(!this.currentSymbol)return;let t=document.getElementById("ratios-loading"),e=document.getElementById("ratios-body"),s=document.getElementById("ratios-modal-title");s&&(s.textContent=`${this.currentSymbol} - Financial Ratios`),t&&(t.style.display="block"),e&&(e.innerHTML=""),this.ratiosModal.classList.remove("hidden");try{let i=await fetch(`/api/financials/${this.currentSymbol}`);if(!i.ok)throw new Error("Failed to fetch");let a=await i.json();this.renderRatios(a)}catch{e&&(e.innerHTML='<div class="ratios-loading">Failed to load financial data</div>')}finally{t&&(t.style.display="none")}}closeRatiosModal(){this.ratiosModal.classList.add("hidden")}renderRatios(t){let e=document.getElementById("ratios-body");if(!e)return;let s=(i,a="number")=>I(i,a);e.innerHTML=`
            <div class="ratios-section">
                <div class="ratios-section-title">VALUATION</div>
                <div class="ratio-row"><span class="ratio-label">P/E (TTM)</span><span class="ratio-value">${s(t.pe_ratio,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Forward P/E</span><span class="ratio-value">${s(t.forward_pe,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">PEG Ratio</span><span class="ratio-value">${s(t.peg_ratio,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Price/Book</span><span class="ratio-value">${s(t.price_to_book,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Price/Sales</span><span class="ratio-value">${s(t.price_to_sales,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EV/Revenue</span><span class="ratio-value">${s(t.ev_to_revenue,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EV/EBITDA</span><span class="ratio-value">${s(t.ev_to_ebitda,"ratio")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">PROFITABILITY</div>
                <div class="ratio-row"><span class="ratio-label">Profit Margin</span><span class="ratio-value ${f(t.profit_margin)}">${s(t.profit_margin,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Operating Margin</span><span class="ratio-value ${f(t.operating_margin)}">${s(t.operating_margin,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">ROA</span><span class="ratio-value ${f(t.return_on_assets)}">${s(t.return_on_assets,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">ROE</span><span class="ratio-value ${f(t.return_on_equity)}">${s(t.return_on_equity,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EPS (TTM)</span><span class="ratio-value">${s(t.eps,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EPS Forward</span><span class="ratio-value">${s(t.eps_forward,"ratio")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">GROWTH</div>
                <div class="ratio-row"><span class="ratio-label">Revenue Growth (QoQ)</span><span class="ratio-value ${f(t.quarterly_revenue_growth)}">${s(t.quarterly_revenue_growth,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Earnings Growth (QoQ)</span><span class="ratio-value ${f(t.quarterly_earnings_growth)}">${s(t.quarterly_earnings_growth,"percent")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">INCOME STATEMENT</div>
                <div class="ratio-row"><span class="ratio-label">Revenue</span><span class="ratio-value">${s(t.revenue,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Revenue/Share</span><span class="ratio-value">${s(t.revenue_per_share,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Gross Profit</span><span class="ratio-value">${s(t.gross_profit,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EBITDA</span><span class="ratio-value">${s(t.ebitda,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Net Income</span><span class="ratio-value">${s(t.net_income,"currency")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">BALANCE SHEET</div>
                <div class="ratio-row"><span class="ratio-label">Total Cash</span><span class="ratio-value">${s(t.total_cash,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Total Debt</span><span class="ratio-value">${s(t.total_debt,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Debt/Equity</span><span class="ratio-value">${s(t.debt_to_equity,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Current Ratio</span><span class="ratio-value">${s(t.current_ratio,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Book Value</span><span class="ratio-value">${s(t.book_value,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Enterprise Value</span><span class="ratio-value">${s(t.enterprise_value,"currency")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">CASH FLOW</div>
                <div class="ratio-row"><span class="ratio-label">Operating Cash Flow</span><span class="ratio-value">${s(t.operating_cash_flow,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Free Cash Flow</span><span class="ratio-value">${s(t.free_cash_flow,"currency")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">STOCK INFO</div>
                <div class="ratio-row"><span class="ratio-label">Beta</span><span class="ratio-value">${s(t.beta,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Shares Outstanding</span><span class="ratio-value">${s(t.shares_outstanding,"number")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Float</span><span class="ratio-value">${s(t.float_shares,"number")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Insider Ownership</span><span class="ratio-value">${s(t.held_by_insiders,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Institutional Ownership</span><span class="ratio-value">${s(t.held_by_institutions,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Short Ratio</span><span class="ratio-value">${s(t.short_ratio,"ratio")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">DIVIDENDS</div>
                <div class="ratio-row"><span class="ratio-label">Dividend Rate</span><span class="ratio-value">${s(t.dividend_rate,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Dividend Yield</span><span class="ratio-value">${s(t.dividend_yield,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Payout Ratio</span><span class="ratio-value">${s(t.payout_ratio,"percent")}</span></div>
            </div>
        `}setupIndexModal(){let t=document.querySelector('[data-fn="INDEX"]'),e=document.getElementById("index-modal-close"),s=this.indexModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.openIndexModal()),e?.addEventListener("click",()=>this.closeIndexModal()),s?.addEventListener("click",()=>this.closeIndexModal()),document.addEventListener("keydown",i=>{i.key==="Escape"&&!this.indexModal.classList.contains("hidden")&&this.closeIndexModal()})}async openIndexModal(){let t=document.getElementById("index-loading"),e=document.getElementById("index-body");t&&(t.style.display="block"),e&&(e.innerHTML=""),this.indexModal.classList.remove("hidden");try{let s=await fetch("/api/indices");if(!s.ok)throw new Error("Failed to fetch");let i=await s.json();this.renderIndices(i)}catch{e&&(e.innerHTML='<div class="ratios-loading">Failed to load indices</div>')}finally{t&&(t.style.display="none")}}closeIndexModal(){this.indexModal.classList.add("hidden")}setupIndexChartModal(){let t=document.getElementById("index-chart-modal-close"),e=this.indexChartModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.closeIndexChartModal()),e?.addEventListener("click",()=>this.closeIndexChartModal()),this.indexChartModal.querySelectorAll(".chart-btn").forEach(s=>{s.addEventListener("click",i=>{let a=i.target,o=parseInt(a.dataset.days||"30",10);this.indexChartModal.querySelectorAll(".chart-btn").forEach(d=>d.classList.remove("active")),a.classList.add("active"),this.currentIndexSymbol&&(this.currentIndexDays=o,this.loadIndexChartData(this.currentIndexSymbol,o))})}),document.addEventListener("keydown",s=>{s.key==="Escape"&&!this.indexChartModal.classList.contains("hidden")&&this.closeIndexChartModal()})}async openIndexChartModal(t,e){this.currentIndexSymbol=t,this.currentIndexName=e,this.currentIndexDays=30;let s=document.getElementById("index-chart-title"),i=document.getElementById("index-chart-loading"),a=document.getElementById("index-chart-container");s&&(s.textContent=`${e} (${t})`),i&&(i.style.display="block"),a&&(a.innerHTML=""),this.indexChartModal.querySelectorAll(".chart-btn").forEach(o=>{o.classList.toggle("active",o.getAttribute("data-days")==="30")}),this.indexChartModal.classList.remove("hidden"),await this.loadIndexChartData(t,30)}closeIndexChartModal(){this.indexChartModal.classList.add("hidden"),this.indexChart&&(this.indexChart.remove(),this.indexChart=null,this.indexCandleSeries=null),this.currentIndexSymbol=null,this.currentIndexName=null}async loadIndexChartData(t,e){let s=document.getElementById("index-chart-loading"),i=document.getElementById("index-chart-container");s&&(s.style.display="block");try{let a=await fetch(`/api/chart/${encodeURIComponent(t)}?days=${e}`);if(!a.ok)throw new Error("Failed to fetch chart data");let o=await a.json();this.renderIndexChart(o)}catch{i&&(i.innerHTML='<div class="ratios-loading">Failed to load chart data</div>')}finally{s&&(s.style.display="none")}}renderIndexChart(t){let e=document.getElementById("index-chart-container");if(!e)return;if(this.indexChart&&(this.indexChart.remove(),this.indexChart=null,this.indexCandleSeries=null),e.innerHTML="",t.points.length===0){e.innerHTML='<div class="ratios-loading">No chart data available</div>';return}this.indexChart=LightweightCharts.createChart(e,{width:e.clientWidth,height:400,layout:{background:{color:"#1a1a1a"},textColor:"#ff9900"},grid:{vertLines:{color:"rgba(255, 153, 0, 0.1)"},horzLines:{color:"rgba(255, 153, 0, 0.1)"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"rgba(255, 153, 0, 0.3)"},timeScale:{borderColor:"rgba(255, 153, 0, 0.3)",timeVisible:!0,secondsVisible:!1}}),this.indexCandleSeries=this.indexChart.addCandlestickSeries({upColor:"#00ff00",downColor:"#ff3333",borderUpColor:"#00ff00",borderDownColor:"#ff3333",wickUpColor:"#00ff00",wickDownColor:"#ff3333"});let s=t.points.map(a=>({time:a.timestamp,open:a.open,high:a.high,low:a.low,close:a.close}));this.indexCandleSeries.setData(s),this.indexChart.timeScale().fitContent(),new ResizeObserver(()=>{this.indexChart&&e&&this.indexChart.applyOptions({width:e.clientWidth})}).observe(e)}renderIndices(t){let e=document.getElementById("index-body");if(!e)return;let i=(r=>{let l=new Map,n=["US","UK","Germany","France","Europe","Netherlands","Spain","Italy","Switzerland","Japan","Hong Kong","China","Australia","South Korea","Taiwan","India","Singapore","Brazil","Mexico","Canada"];for(let h of n){let y=r.filter(m=>m.region===h);y.length>0&&l.set(h,y)}return l})(t),a="",o={US:"UNITED STATES",UK:"UNITED KINGDOM",Germany:"GERMANY",France:"FRANCE",Europe:"EUROPE",Netherlands:"NETHERLANDS",Spain:"SPAIN",Italy:"ITALY",Switzerland:"SWITZERLAND",Japan:"JAPAN","Hong Kong":"HONG KONG",China:"CHINA",Australia:"AUSTRALIA","South Korea":"SOUTH KOREA",Taiwan:"TAIWAN",India:"INDIA",Singapore:"SINGAPORE",Brazil:"BRAZIL",Mexico:"MEXICO",Canada:"CANADA"},d=r=>r.replace(/&/g,"").replace(/"/g,"").replace(/'/g,"").replace(/</g,"").replace(/>/g,"");i.forEach((r,l)=>{a+=`<div class="index-section">
                <div class="index-section-title">${o[l]||l}</div>`;for(let n of r){let h=n.change>=0?"positive":"negative",y=n.change>=0?"+":"";a+=`
                <div class="index-row clickable" data-symbol="${d(n.symbol)}" data-name="${d(n.name)}">
                    <div class="index-info">
                        <span class="index-symbol">${d(n.symbol)}</span>
                        <span class="index-name">${d(n.name)}</span>
                    </div>
                    <div class="index-data">
                        <span class="index-price">${n.price.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
                        <span class="index-change ${h}">${y}${n.change.toFixed(2)}</span>
                        <span class="index-percent ${h}">${y}${n.change_percent.toFixed(2)}%</span>
                    </div>
                </div>`}a+="</div>"}),e.innerHTML=a,e.querySelectorAll(".index-row.clickable").forEach(r=>{r.addEventListener("click",()=>{let l=r.getAttribute("data-symbol"),n=r.getAttribute("data-name");l&&n&&this.openIndexChartModal(l,n)})})}setupStatementsModal(){let t=document.getElementById("statements-btn"),e=document.getElementById("statements-modal-close"),s=this.statementsModal.querySelector(".modal-overlay"),i=document.getElementById("statements-currency-toggle");t?.addEventListener("click",()=>this.openStatementsModal()),e?.addEventListener("click",()=>this.closeStatementsModal()),s?.addEventListener("click",()=>this.closeStatementsModal()),i?.addEventListener("click",()=>this.toggleStatementsCurrency()),this.statementsModal.querySelectorAll(".stmt-tab").forEach(a=>{a.addEventListener("click",o=>{let d=o.target,r=d.dataset.tab;this.currentTab=r,this.statementsModal.querySelectorAll(".stmt-tab").forEach(l=>l.classList.remove("active")),d.classList.add("active"),this.statementsData&&this.renderStatements(this.statementsData)})}),document.addEventListener("keydown",a=>{a.key==="Escape"&&!this.statementsModal.classList.contains("hidden")&&this.closeStatementsModal()})}setupGovtModal(){let t=document.querySelector('[data-fn="GOVT"]'),e=document.getElementById("govt-modal-close"),s=document.getElementById("govt-refresh-btn"),i=this.govtModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.openGovtModal()),e?.addEventListener("click",()=>this.closeGovtModal()),s?.addEventListener("click",()=>this.refreshTreasury()),i?.addEventListener("click",()=>this.closeGovtModal()),document.addEventListener("keydown",a=>{a.key==="Escape"&&!this.govtModal.classList.contains("hidden")&&this.closeGovtModal()})}async openGovtModal(){let t=document.getElementById("govt-loading"),e=document.getElementById("govt-body");t&&(t.style.display="block"),e&&(e.innerHTML=""),this.govtModal.classList.remove("hidden");try{let s=await fetch("/api/treasury");if(!s.ok)throw new Error("Failed to fetch");let i=await s.json();this.renderTreasury(i)}catch{e&&(e.innerHTML='<div class="ratios-loading">Failed to load treasury rates</div>')}finally{t&&(t.style.display="none")}}closeGovtModal(){this.govtModal.classList.add("hidden")}async refreshTreasury(){let t=document.getElementById("govt-loading"),e=document.getElementById("govt-body"),s=document.getElementById("govt-refresh-btn");s&&(s.classList.add("spinning"),s.disabled=!0),t&&(t.style.display="block"),e&&(e.innerHTML="");try{let i=await fetch("/api/treasury/refresh",{method:"POST"});if(!i.ok)throw new Error("Failed to refresh");let a=await i.json();this.renderTreasury(a)}catch{e&&(e.innerHTML='<div class="ratios-loading">Failed to refresh treasury rates</div>')}finally{t&&(t.style.display="none"),s&&(s.classList.remove("spinning"),s.disabled=!1)}}renderTreasury(t){let e=document.getElementById("govt-body");if(!e)return;let s=t.rates.filter(l=>["1 Mo","1.5 Month","2 Mo","3 Mo","4 Mo","6 Mo"].includes(l.maturity)),i=t.rates.filter(l=>["1 Yr","2 Yr","3 Yr","5 Yr","7 Yr","10 Yr","20 Yr","30 Yr"].includes(l.maturity)),a=l=>{let n=l.change>=0?"positive":"negative",h=l.change>=0?"+":"";return`
                <div class="treasury-row">
                    <span class="treasury-maturity">${l.maturity}</span>
                    <span class="treasury-yield">${l.yield_rate.toFixed(2)}%</span>
                    <span class="treasury-change ${n}">${h}${l.change.toFixed(2)}</span>
                    <span class="treasury-pct ${n}">${h}${l.change_percent.toFixed(2)}%</span>
                </div>
            `},o="";s.length>0&&(o+=`
                <div class="treasury-section">
                    <div class="treasury-section-title">SHORT-TERM (BILLS)</div>
                    <div class="treasury-header">
                        <span>Maturity</span>
                        <span>Yield</span>
                        <span>Chg</span>
                        <span>Chg %</span>
                    </div>
                    ${s.map(a).join("")}
                </div>
            `),i.length>0&&(o+=`
                <div class="treasury-section">
                    <div class="treasury-section-title">LONG-TERM (NOTES & BONDS)</div>
                    <div class="treasury-header">
                        <span>Maturity</span>
                        <span>Yield</span>
                        <span>Chg</span>
                        <span>Chg %</span>
                    </div>
                    ${i.map(a).join("")}
                </div>
            `);let d=t.rates.find(l=>l.maturity==="10 Yr"),r=t.rates.find(l=>l.maturity==="2 Yr");if(d&&r){let l=d.yield_rate-r.yield_rate,n=l>=0?"positive":"negative";o+=`
                <div class="treasury-section">
                    <div class="treasury-section-title">YIELD CURVE</div>
                    <div class="treasury-row">
                        <span class="treasury-maturity">10Y-2Y Spread</span>
                        <span class="treasury-yield ${n}">${l>=0?"+":""}${(l*100).toFixed(0)} bps</span>
                        <span class="treasury-change"></span>
                        <span class="treasury-pct"></span>
                    </div>
                </div>
            `}o+=`<div class="treasury-updated">Last updated: ${new Date(t.updated_at).toLocaleString()}</div>`,e.innerHTML=o,e.querySelectorAll(".treasury-row").forEach(l=>{let n=l.querySelector(".treasury-maturity");if(n){let h=n.textContent;h&&!h.includes("Spread")&&(l.classList.add("clickable"),l.addEventListener("click",()=>this.openTreasuryChartModal(h)))}})}setupTreasuryChartModal(){let t=document.getElementById("treasury-chart-modal-close"),e=this.treasuryChartModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.closeTreasuryChartModal()),e?.addEventListener("click",()=>this.closeTreasuryChartModal()),document.addEventListener("keydown",s=>{s.key==="Escape"&&!this.treasuryChartModal.classList.contains("hidden")&&this.closeTreasuryChartModal()}),this.treasuryChartModal.querySelectorAll(".treasury-range-btn").forEach(s=>{s.addEventListener("click",i=>{let a=i.target,o=parseInt(a.dataset.days||"365",10);this.treasuryChartModal.querySelectorAll(".treasury-range-btn").forEach(d=>d.classList.remove("active")),a.classList.add("active"),this.currentTreasuryDays=o,this.currentTreasuryMaturity&&this.loadTreasuryHistory(this.currentTreasuryMaturity,o)})})}async openTreasuryChartModal(t){this.currentTreasuryMaturity=t,this.currentTreasuryDays=365;let e=document.getElementById("treasury-chart-title"),s=document.getElementById("treasury-chart-loading"),i=document.getElementById("treasury-chart-container");e&&(e.textContent=`${t} Treasury Yield History`),s&&(s.style.display="block"),i&&(i.innerHTML=""),this.treasuryChartModal.querySelectorAll(".treasury-range-btn").forEach(a=>{a.classList.toggle("active",a.getAttribute("data-days")==="365")}),this.treasuryChartModal.classList.remove("hidden"),await this.loadTreasuryHistory(t,365)}closeTreasuryChartModal(){this.treasuryChartModal.classList.add("hidden"),this.treasuryChart&&(this.treasuryChart.remove(),this.treasuryChart=null,this.treasuryLineSeries=null),this.currentTreasuryMaturity=null}async loadTreasuryHistory(t,e){let s=document.getElementById("treasury-chart-loading"),i=document.getElementById("treasury-chart-container");s&&(s.style.display="block");try{let a=encodeURIComponent(t),o=await fetch(`/api/treasury/history/${a}?days=${e}`);if(!o.ok)throw new Error("Failed to fetch treasury history");let d=await o.json();this.renderTreasuryChart(d)}catch{i&&(i.innerHTML='<div class="ratios-loading">Failed to load treasury history</div>')}finally{s&&(s.style.display="none")}}renderTreasuryChart(t){let e=document.getElementById("treasury-chart-container");if(!e)return;if(this.treasuryChart&&(this.treasuryChart.remove(),this.treasuryChart=null,this.treasuryLineSeries=null),e.innerHTML="",t.points.length===0){e.innerHTML='<div class="ratios-loading">No historical data available</div>';return}this.treasuryChart=LightweightCharts.createChart(e,{width:e.clientWidth,height:400,layout:{background:{color:"#1a1a1a"},textColor:"#ff9900"},grid:{vertLines:{color:"rgba(255, 153, 0, 0.1)"},horzLines:{color:"rgba(255, 153, 0, 0.1)"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"rgba(255, 153, 0, 0.3)"},timeScale:{borderColor:"rgba(255, 153, 0, 0.3)",timeVisible:!0,secondsVisible:!1}}),this.treasuryLineSeries=this.treasuryChart.addLineSeries({color:"#ff9900",lineWidth:2,crosshairMarkerVisible:!0,crosshairMarkerRadius:4,priceFormat:{type:"price",precision:2,minMove:.01}});let s=t.points.map(a=>({time:a.date,value:a.yield_rate}));this.treasuryLineSeries.setData(s),this.treasuryChart.timeScale().fitContent(),new ResizeObserver(()=>{this.treasuryChart&&e&&this.treasuryChart.applyOptions({width:e.clientWidth})}).observe(e)}setupBondsModal(){let t=document.querySelector('[data-fn="INTL"]'),e=document.getElementById("bonds-modal-close"),s=this.bondsModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.openBondsModal()),e?.addEventListener("click",()=>this.closeBondsModal()),s?.addEventListener("click",()=>this.closeBondsModal()),document.addEventListener("keydown",i=>{i.key==="Escape"&&!this.bondsModal.classList.contains("hidden")&&this.closeBondsModal()})}async openBondsModal(){let t=document.getElementById("bonds-loading"),e=document.getElementById("bonds-body"),s=document.getElementById("bonds-date");t&&(t.style.display="block"),e&&(e.innerHTML=""),this.bondsModal.classList.remove("hidden");try{let i=await fetch("/api/bonds");if(!i.ok)throw new Error("Failed to fetch");let a=await i.json();s&&(s.textContent=`Updated: ${new Date(a.updated_at).toLocaleString()}`),this.renderBonds(a)}catch{e&&(e.innerHTML='<div class="ratios-loading">Failed to load bond yields</div>')}finally{t&&(t.style.display="none")}}closeBondsModal(){this.bondsModal.classList.add("hidden")}renderBonds(t){let e=document.getElementById("bonds-body");if(!e)return;let s=["CN"],i=n=>{let h=n.change>=0?"positive":"negative",y=n.change>=0?"+":"",m=n.data_frequency==="daily"?"freq-daily":"freq-monthly",g=!s.includes(n.country_code)&&n.maturity==="10Y",v=g?"clickable":"",c=g||n.maturity!=="10Y"?"":'title="Historical chart not available"';return`
                <div class="bonds-row ${v}" data-country="${n.country}" data-country-code="${n.country_code}" ${c}>
                    <div class="bonds-info">
                        <span class="bonds-country">${n.country}<span class="bonds-freq ${m}" title="${n.data_frequency} data"></span></span>
                        <span class="bonds-code">${n.country_code}</span>
                    </div>
                    <div class="bonds-data">
                        <span class="bonds-yield">${n.yield_value.toFixed(2)}%</span>
                        <span class="bonds-change ${h}">${y}${n.change.toFixed(2)}</span>
                        <span class="bonds-pct ${h}">${y}${n.change_percent.toFixed(2)}%</span>
                    </div>
                </div>
            `},a=t.bonds.filter(n=>n.maturity==="10Y"),o=t.bonds.filter(n=>n.maturity==="20Y"),d=t.bonds.filter(n=>n.maturity==="30Y"),r=(n,h)=>h.length===0?"":`
                <div class="bonds-section">
                    <div class="bonds-header">
                        <span>Country</span>
                        <span>${n} Yield</span>
                        <span>Chg</span>
                        <span>Chg %</span>
                    </div>
                    ${h.map(i).join("")}
                </div>
            `,l=`
            ${r("10Y",a)}
            ${r("20Y",o)}
            ${r("30Y",d)}
            <div class="bonds-legend">
                <span class="bonds-freq freq-daily"></span> Daily
                <span class="bonds-freq freq-monthly" style="margin-left: 8px;"></span> Monthly
            </div>
        `;e.innerHTML=l,e.querySelectorAll(".bonds-row.clickable").forEach(n=>{n.addEventListener("click",()=>{let h=n.dataset.country,y=n.dataset.countryCode;h&&y&&this.openBondsChartModal(h,y)})})}setupBondsChartModal(){let t=document.getElementById("bonds-chart-modal-close"),e=this.bondsChartModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.closeBondsChartModal()),e?.addEventListener("click",()=>this.closeBondsChartModal()),document.addEventListener("keydown",s=>{s.key==="Escape"&&!this.bondsChartModal.classList.contains("hidden")&&this.closeBondsChartModal()}),this.bondsChartModal.querySelectorAll(".bonds-range-btn").forEach(s=>{s.addEventListener("click",i=>{let a=i.target,o=parseInt(a.dataset.years||"10",10);this.bondsChartModal.querySelectorAll(".bonds-range-btn").forEach(d=>d.classList.remove("active")),a.classList.add("active"),this.currentBondYears=o,this.currentBondCountryCode&&this.loadBondHistory(this.currentBondCountryCode,o)})})}async openBondsChartModal(t,e){this.currentBondCountry=t,this.currentBondCountryCode=e,this.currentBondYears=10;let s=document.getElementById("bonds-chart-title"),i=document.getElementById("bonds-chart-loading"),a=document.getElementById("bonds-chart-container");s&&(s.textContent=`${t} 10 Year Bond Yield History`),i&&(i.style.display="block"),a&&(a.innerHTML=""),this.bondsChartModal.querySelectorAll(".bonds-range-btn").forEach(o=>{o.classList.toggle("active",o.getAttribute("data-years")==="10")}),this.bondsChartModal.classList.remove("hidden"),await this.loadBondHistory(e,10)}closeBondsChartModal(){this.bondsChartModal.classList.add("hidden"),this.bondsChart&&(this.bondsChart.remove(),this.bondsChart=null,this.bondsLineSeries=null),this.currentBondCountry=null,this.currentBondCountryCode=null}async loadBondHistory(t,e){let s=document.getElementById("bonds-chart-loading"),i=document.getElementById("bonds-chart-container"),a=document.getElementById("bonds-chart-notice");s&&(s.style.display="block");try{let o=await fetch(`/api/bonds/history/${t}?years=${e}`);if(!o.ok)throw new Error("Failed to fetch bond history");let d=await o.json();a&&(a.textContent=d.data_delay),this.renderBondsChart(d)}catch{i&&(i.innerHTML='<div class="ratios-loading">Failed to load bond history</div>')}finally{s&&(s.style.display="none")}}renderBondsChart(t){let e=document.getElementById("bonds-chart-container");if(!e)return;if(this.bondsChart&&(this.bondsChart.remove(),this.bondsChart=null,this.bondsLineSeries=null),e.innerHTML="",t.points.length===0){e.innerHTML='<div class="ratios-loading">No historical data available</div>';return}this.bondsChart=LightweightCharts.createChart(e,{width:e.clientWidth,height:400,layout:{background:{color:"#1a1a1a"},textColor:"#ff9900"},grid:{vertLines:{color:"rgba(255, 153, 0, 0.1)"},horzLines:{color:"rgba(255, 153, 0, 0.1)"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"rgba(255, 153, 0, 0.3)"},timeScale:{borderColor:"rgba(255, 153, 0, 0.3)",timeVisible:!0,secondsVisible:!1}}),this.bondsLineSeries=this.bondsChart.addLineSeries({color:"#ff9900",lineWidth:2,crosshairMarkerVisible:!0,crosshairMarkerRadius:4,priceFormat:{type:"price",precision:2,minMove:.01}});let s=t.points.map(a=>({time:a.date,value:a.yield_rate}));this.bondsLineSeries.setData(s),this.bondsChart.timeScale().fitContent(),new ResizeObserver(()=>{this.bondsChart&&e&&this.bondsChart.applyOptions({width:e.clientWidth})}).observe(e)}setupCommoditiesModal(){let t=document.querySelector('[data-fn="CMDTY"]'),e=document.getElementById("commodities-modal-close"),s=this.commoditiesModal?.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.openCommoditiesModal()),e?.addEventListener("click",()=>this.closeCommoditiesModal()),s?.addEventListener("click",()=>this.closeCommoditiesModal()),document.addEventListener("keydown",i=>{i.key==="Escape"&&!this.commoditiesModal?.classList.contains("hidden")&&this.closeCommoditiesModal()})}async openCommoditiesModal(){let t=document.getElementById("commodities-loading"),e=document.getElementById("commodities-body");t&&(t.style.display="block"),e&&(e.innerHTML=""),this.commoditiesModal.classList.remove("hidden");try{let s=await fetch("/api/commodities");if(!s.ok)throw new Error("Failed to fetch");let i=await s.json();this.renderCommodities(i)}catch{e&&(e.innerHTML='<div class="ratios-loading">Failed to load commodities</div>')}finally{t&&(t.style.display="none")}}closeCommoditiesModal(){this.commoditiesModal.classList.add("hidden")}setupCommodityChartModal(){let t=document.getElementById("commodity-chart-modal-close"),e=this.commodityChartModal.querySelector(".modal-overlay");t?.addEventListener("click",()=>this.closeCommodityChartModal()),e?.addEventListener("click",()=>this.closeCommodityChartModal()),this.commodityChartModal.querySelectorAll(".chart-btn").forEach(s=>{s.addEventListener("click",i=>{let a=i.target,o=parseInt(a.dataset.days||"30",10);this.commodityChartModal.querySelectorAll(".chart-btn").forEach(d=>d.classList.remove("active")),a.classList.add("active"),this.currentCommoditySymbol&&(this.currentCommodityDays=o,this.loadCommodityChartData(this.currentCommoditySymbol,o))})}),document.addEventListener("keydown",s=>{s.key==="Escape"&&!this.commodityChartModal.classList.contains("hidden")&&this.closeCommodityChartModal()})}async openCommodityChartModal(t,e){this.currentCommoditySymbol=t,this.currentCommodityName=e,this.currentCommodityDays=30;let s=document.getElementById("commodity-chart-title"),i=document.getElementById("commodity-chart-loading"),a=document.getElementById("commodity-chart-container");s&&(s.textContent=`${e} (${t})`),i&&(i.style.display="block"),a&&(a.innerHTML=""),this.commodityChartModal.querySelectorAll(".chart-btn").forEach(o=>{o.classList.toggle("active",o.getAttribute("data-days")==="30")}),this.commodityChartModal.classList.remove("hidden"),await this.loadCommodityChartData(t,30)}closeCommodityChartModal(){this.commodityChartModal.classList.add("hidden"),this.commodityChart&&(this.commodityChart.remove(),this.commodityChart=null,this.commodityCandleSeries=null),this.currentCommoditySymbol=null,this.currentCommodityName=null}async loadCommodityChartData(t,e){let s=document.getElementById("commodity-chart-loading"),i=document.getElementById("commodity-chart-container");s&&(s.style.display="block");try{let a=await fetch(`/api/chart/${encodeURIComponent(t)}?days=${e}`);if(!a.ok)throw new Error("Failed to fetch chart data");let o=await a.json();this.renderCommodityChart(o)}catch{i&&(i.innerHTML='<div class="ratios-loading">Failed to load chart data</div>')}finally{s&&(s.style.display="none")}}renderCommodityChart(t){let e=document.getElementById("commodity-chart-container");if(!e)return;if(this.commodityChart&&(this.commodityChart.remove(),this.commodityChart=null,this.commodityCandleSeries=null),e.innerHTML="",t.points.length===0){e.innerHTML='<div class="ratios-loading">No chart data available</div>';return}this.commodityChart=LightweightCharts.createChart(e,{width:e.clientWidth,height:400,layout:{background:{color:"#1a1a1a"},textColor:"#ff9900"},grid:{vertLines:{color:"rgba(255, 153, 0, 0.1)"},horzLines:{color:"rgba(255, 153, 0, 0.1)"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"rgba(255, 153, 0, 0.3)"},timeScale:{borderColor:"rgba(255, 153, 0, 0.3)",timeVisible:!0,secondsVisible:!1}}),this.commodityCandleSeries=this.commodityChart.addCandlestickSeries({upColor:"#00ff00",downColor:"#ff3333",borderUpColor:"#00ff00",borderDownColor:"#ff3333",wickUpColor:"#00ff00",wickDownColor:"#ff3333"});let s=t.points.map(a=>({time:a.timestamp,open:a.open,high:a.high,low:a.low,close:a.close}));this.commodityCandleSeries.setData(s),this.commodityChart.timeScale().fitContent(),new ResizeObserver(()=>{this.commodityChart&&e&&this.commodityChart.applyOptions({width:e.clientWidth})}).observe(e)}renderCommodities(t){let e=document.getElementById("commodities-body");if(!e)return;let s=[...new Set(t.commodities.map(d=>d.category))],i=d=>d.replace(/&/g,"").replace(/"/g,"").replace(/'/g,"").replace(/</g,"").replace(/>/g,""),a=d=>{let r=d.change>=0?"positive":"negative",l=d.change>=0?"+":"";return`
                <div class="commodity-row clickable" data-symbol="${i(d.symbol)}" data-name="${i(d.name)}">
                    <div class="commodity-info">
                        <span class="commodity-name">${i(d.name)}</span>
                        <span class="commodity-unit">${d.unit}</span>
                    </div>
                    <div class="commodity-data">
                        <span class="commodity-price">${d.price.toFixed(2)}</span>
                        <span class="commodity-change ${r}">${l}${d.change.toFixed(2)}</span>
                        <span class="commodity-pct ${r}">${l}${d.change_percent.toFixed(2)}%</span>
                    </div>
                </div>
            `},o="";for(let d of s){let r=t.commodities.filter(l=>l.category===d);o+=`
                <div class="commodity-section">
                    <div class="commodity-category">${d}</div>
                    ${r.map(a).join("")}
                </div>
            `}e.innerHTML=o,e.querySelectorAll(".commodity-row.clickable").forEach(d=>{d.addEventListener("click",()=>{let r=d.getAttribute("data-symbol"),l=d.getAttribute("data-name");r&&l&&this.openCommodityChartModal(r,l)})})}async openStatementsModal(){if(!this.currentSymbol)return;let t=document.getElementById("statements-loading"),e=document.getElementById("statements-body"),s=document.getElementById("statements-modal-title");s&&(s.textContent=`${this.currentSymbol} - Financial Statements`),t&&(t.style.display="block"),e&&(e.innerHTML=""),this.statementsCurrencyMode="local",this.statementsCurrencyCode=null,this.statementsCurrencySymbol=null,this.statementsUsdRate=null,this.updateStatementsCurrencyUI(),this.statementsModal.classList.remove("hidden");try{let i=await fetch(`/api/statements/${this.currentSymbol}`);if(!i.ok)throw new Error("Failed to fetch");let a=await i.json();this.statementsData=a,this.setStatementsCurrencyMeta(a),this.renderStatements(a)}catch{e&&(e.innerHTML='<div class="ratios-loading">Failed to load financial statements</div>')}finally{t&&(t.style.display="none")}}closeStatementsModal(){this.statementsModal.classList.add("hidden")}setStatementsCurrencyMeta(t){let e=(t.currency||"USD").toUpperCase();this.statementsCurrencyCode=e,this.statementsCurrencySymbol=w(e),this.statementsUsdRate=t.usd_fx_rate??null}toggleStatementsCurrency(){!this.statementsData||!this.statementsCurrencyCode||!this.statementsUsdRate||this.statementsCurrencyCode==="USD"||(this.statementsCurrencyMode=this.statementsCurrencyMode==="local"?"usd":"local",this.renderStatements(this.statementsData))}formatFxRate(t){return t<.01?t.toFixed(6):t.toFixed(4)}updateStatementsCurrencyUI(){let t=document.getElementById("statements-currency-subtitle"),e=document.getElementById("statements-currency-meta"),s=document.getElementById("statements-currency-note"),i=document.getElementById("statements-currency-toggle"),a=document.getElementById("statements-currency-rate"),o=this.statementsCurrencyCode,d=this.statementsCurrencySymbol,r=!!(o&&d);if(t&&(t.textContent=r?`Currency: ${o} (${d})`:""),e&&e.classList.toggle("hidden",!r),!r){s&&(s.textContent=""),i&&(i.style.display="none"),a&&(a.textContent="");return}let l=this.statementsCurrencyMode==="usd",n=l?"USD":o,h=l?"$":d;s&&(s.textContent=`All figures in ${n} (${h})`);let y=!!this.statementsUsdRate&&o!=="USD";i&&(i.style.display=y?"inline-flex":"none",y&&(i.textContent=l?`View in ${o}`:"Convert to USD")),a&&(l&&y&&this.statementsUsdRate?(a.textContent=`Rate: 1 ${o} = ${this.formatFxRate(this.statementsUsdRate)} USD`,a.classList.remove("hidden")):(a.textContent="",a.classList.add("hidden")))}renderStatements(t){let e=document.getElementById("statements-body");if(!e)return;(!this.statementsCurrencyCode||!this.statementsCurrencySymbol)&&this.setStatementsCurrencyMeta(t);let s=this.statementsCurrencyMode==="usd"&&this.statementsUsdRate!==null,i=s?"$":this.statementsCurrencySymbol||"$",a=this.statementsUsdRate??1,o=n=>L(s&&n!==null?n*a:n,i),d=n=>n.some(h=>h!=null&&h!==0),r=(n,h,y=!1)=>{if(!d(h))return"";let m=y?' class="stmt-highlight"':"",g=s?h.map(v=>v===null?null:v*a):h;return`<tr${m}><td>${n}</td>${g.map(v=>`<td class="${f(v)}">${o(v)}</td>`).join("")}</tr>`},l="";if(this.currentTab==="income"){let n=t.income_statements;if(n.length===0)l='<div class="ratios-loading">No income statement data available</div>';else{let h=n.map(m=>m.fiscal_year.split("-")[0]||m.fiscal_year),y=[r("Total Revenue",n.map(m=>m.total_revenue),!0),r("Cost of Revenue",n.map(m=>m.cost_of_revenue)),r("Gross Profit",n.map(m=>m.gross_profit),!0),r("R&D Expenses",n.map(m=>m.research_development)),r("SG&A Expenses",n.map(m=>m.selling_general_admin)),r("Total Operating Expenses",n.map(m=>m.total_operating_expenses)),r("Operating Income",n.map(m=>m.operating_income),!0),r("Interest Expense",n.map(m=>m.interest_expense)),r("Income Before Tax",n.map(m=>m.income_before_tax)),r("Income Tax Expense",n.map(m=>m.income_tax_expense)),r("Net Income",n.map(m=>m.net_income),!0),r("EBIT",n.map(m=>m.ebit)),r("EBITDA",n.map(m=>m.ebitda))].filter(m=>m).join("");l=`
                    <table class="statements-table">
                        <thead>
                            <tr>
                                <th class="stmt-label-col">Item</th>
                                ${h.map(m=>`<th class="stmt-value-col">${m}</th>`).join("")}
                            </tr>
                        </thead>
                        <tbody>${y}</tbody>
                    </table>
                `}}else if(this.currentTab==="balance"){let n=t.balance_sheets;if(n.length===0)l='<div class="ratios-loading">No balance sheet data available</div>';else{let h=n.map(c=>c.fiscal_year.split("-")[0]||c.fiscal_year),y=[r("Cash & Equivalents",n.map(c=>c.cash_and_equivalents)),r("Short-term Investments",n.map(c=>c.short_term_investments)),r("Accounts Receivable",n.map(c=>c.accounts_receivable)),r("Inventory",n.map(c=>c.inventory)),r("Total Current Assets",n.map(c=>c.total_current_assets),!0),r("Property, Plant & Equipment",n.map(c=>c.property_plant_equipment)),r("Goodwill",n.map(c=>c.goodwill)),r("Intangible Assets",n.map(c=>c.intangible_assets)),r("Total Assets",n.map(c=>c.total_assets),!0)].filter(c=>c).join(""),m=[r("Accounts Payable",n.map(c=>c.accounts_payable)),r("Short-term Debt",n.map(c=>c.short_term_debt)),r("Total Current Liabilities",n.map(c=>c.total_current_liabilities),!0),r("Long-term Debt",n.map(c=>c.long_term_debt)),r("Total Liabilities",n.map(c=>c.total_liabilities),!0)].filter(c=>c).join(""),g=[r("Common Stock",n.map(c=>c.common_stock)),r("Retained Earnings",n.map(c=>c.retained_earnings)),r("Total Stockholders Equity",n.map(c=>c.total_stockholders_equity),!0)].filter(c=>c).join(""),v="";y&&(v+=`<tr class="stmt-section-header"><td colspan="${h.length+1}">ASSETS</td></tr>${y}`),m&&(v+=`<tr class="stmt-section-header"><td colspan="${h.length+1}">LIABILITIES</td></tr>${m}`),g&&(v+=`<tr class="stmt-section-header"><td colspan="${h.length+1}">EQUITY</td></tr>${g}`),v?l=`
                        <table class="statements-table">
                            <thead>
                                <tr>
                                    <th class="stmt-label-col">Item</th>
                                    ${h.map(c=>`<th class="stmt-value-col">${c}</th>`).join("")}
                                </tr>
                            </thead>
                            <tbody>${v}</tbody>
                        </table>
                    `:l='<div class="ratios-loading">No balance sheet data available</div>'}}else if(this.currentTab==="cashflow"){let n=t.cash_flows;if(n.length===0)l='<div class="ratios-loading">No cash flow data available</div>';else{let h=n.map(p=>p.fiscal_year.split("-")[0]||p.fiscal_year),y=[r("Net Income",n.map(p=>p.net_income)),r("Depreciation",n.map(p=>p.depreciation)),r("Change in Working Capital",n.map(p=>p.change_in_working_capital)),r("Operating Cash Flow",n.map(p=>p.operating_cash_flow),!0)].filter(p=>p).join(""),m=[r("Capital Expenditures",n.map(p=>p.capital_expenditures)),r("Investments",n.map(p=>p.investments)),r("Investing Cash Flow",n.map(p=>p.investing_cash_flow),!0)].filter(p=>p).join(""),g=[r("Dividends Paid",n.map(p=>p.dividends_paid)),r("Stock Repurchases",n.map(p=>p.stock_repurchases)),r("Debt Repayment",n.map(p=>p.debt_repayment)),r("Financing Cash Flow",n.map(p=>p.financing_cash_flow),!0)].filter(p=>p).join(""),v=r("Free Cash Flow",n.map(p=>p.free_cash_flow),!0),c="";y&&(c+=`<tr class="stmt-section-header"><td colspan="${h.length+1}">OPERATING ACTIVITIES</td></tr>${y}`),m&&(c+=`<tr class="stmt-section-header"><td colspan="${h.length+1}">INVESTING ACTIVITIES</td></tr>${m}`),g&&(c+=`<tr class="stmt-section-header"><td colspan="${h.length+1}">FINANCING ACTIVITIES</td></tr>${g}`),v&&(c+=`<tr class="stmt-section-header"><td colspan="${h.length+1}">FREE CASH FLOW</td></tr>${v}`),c?l=`
                        <table class="statements-table">
                            <thead>
                                <tr>
                                    <th class="stmt-label-col">Item</th>
                                    ${h.map(p=>`<th class="stmt-value-col">${p}</th>`).join("")}
                                </tr>
                            </thead>
                            <tbody>${c}</tbody>
                        </table>
                    `:l='<div class="ratios-loading">No cash flow data available</div>'}}e.innerHTML=l,this.updateStatementsCurrencyUI()}handleKeydown(t){let e=this.searchResults.querySelectorAll(".search-item");t.key==="ArrowDown"?(t.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,e.length-1),this.updateSelectedItem(e)):t.key==="ArrowUp"?(t.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,-1),this.updateSelectedItem(e)):t.key==="Enter"?(t.preventDefault(),this.selectedIndex>=0&&this.searchResultsData[this.selectedIndex]?this.selectCompany(this.searchResultsData[this.selectedIndex]):this.searchResultsData.length>0&&this.selectCompany(this.searchResultsData[0])):t.key==="Escape"&&(this.searchResults.classList.remove("active"),this.selectedIndex=-1)}updateSelectedItem(t){t.forEach((e,s)=>{e.classList.toggle("selected",s===this.selectedIndex)})}async handleSearch(){let t=this.commandInput.value.trim();if(this.searchTimeout&&clearTimeout(this.searchTimeout),t.length<1){this.searchResults.classList.remove("active"),this.searchResultsData=[];return}this.searchTimeout=window.setTimeout(async()=>{this.setStatus("SEARCHING...");try{let s=await(await fetch(`/api/search?q=${encodeURIComponent(t)}`)).json();this.searchResultsData=s,this.selectedIndex=-1,this.renderSearchResults(s),this.setStatus("READY")}catch{this.setStatus("ERROR")}},150)}renderSearchResults(t){if(t.length===0){this.searchResults.innerHTML='<div class="search-item">No results found</div>',this.searchResults.classList.add("active");return}this.searchResults.innerHTML=t.map((e,s)=>`
            <div class="search-item" data-index="${s}">
                <span class="symbol">${e.symbol}</span>
                <span class="name">${e.name}</span>
            </div>
        `).join(""),this.searchResults.querySelectorAll(".search-item").forEach(e=>{e.addEventListener("click",()=>{let s=parseInt(e.dataset.index||"0",10);this.selectCompany(t[s])})}),this.searchResults.classList.add("active")}selectCompany(t){this.currentSymbol=t.symbol,this.commandInput.value=t.symbol,this.searchResults.classList.remove("active"),this.loadSecurityView(t)}async loadSecurityView(t){this.setStatus("LOADING..."),this.welcomeScreen.classList.add("hidden"),this.securityView.classList.remove("hidden"),await Promise.all([this.loadQuote(t.symbol),this.loadChartData(t.symbol,30),this.loadNews(t.symbol)]),this.renderDescription(t),this.setStatus("READY")}async loadQuote(t){try{let s=await(await fetch(`/api/quote/${t}`)).json();this.renderQuote(s)}catch{console.error("Failed to load quote")}}renderQuote(t){let e=document.getElementById("quote-symbol"),s=document.getElementById("quote-name"),i=document.getElementById("quote-exchange"),a=document.getElementById("quote-price"),o=document.getElementById("quote-change"),d=document.getElementById("quote-details");if(e&&(e.textContent=t.symbol),s&&(s.textContent=t.name),i&&(i.textContent=`\u2022 ${t.symbol.includes(".")?"LSE":"NASDAQ"}`),a&&(a.textContent=t.price.toFixed(2)),o){let r=t.change>=0?"+":"";o.textContent=`${r}${t.change.toFixed(2)} (${r}${t.change_percent.toFixed(2)}%)`,o.className=`change ${t.change>=0?"positive":"negative"}`}d&&(d.innerHTML=`
                <div class="quote-row"><span class="label">Open</span><span class="value">${t.open.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">High</span><span class="value">${t.high.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">Low</span><span class="value">${t.low.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">Volume</span><span class="value">${this.formatNumber(t.volume)}</span></div>
                <div class="quote-row"><span class="label">Mkt Cap</span><span class="value">${this.formatMarketCap(t.market_cap)}</span></div>
                <div class="quote-row"><span class="label">P/E</span><span class="value">${t.pe_ratio?.toFixed(2)||"N/A"}</span></div>
                <div class="quote-row"><span class="label">EPS</span><span class="value">${t.eps?.toFixed(2)||"N/A"}</span></div>
                <div class="quote-row"><span class="label">Div Yield</span><span class="value">${t.dividend_yield?t.dividend_yield.toFixed(2)+"%":"N/A"}</span></div>
                <div class="quote-row"><span class="label">52W High</span><span class="value">${t.week_52_high.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">52W Low</span><span class="value">${t.week_52_low.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">Avg Vol</span><span class="value">${this.formatNumber(t.avg_volume)}</span></div>
            `)}async loadChartData(t,e){try{let i=await(await fetch(`/api/chart/${t}?days=${e}`)).json();this.renderChart(i)}catch{console.error("Failed to load chart data")}}renderChart(t){let e=document.getElementById("chart-container");if(!e)return;this.chart&&this.chart.remove(),this.chart=LightweightCharts.createChart(e,{width:e.clientWidth,height:e.clientHeight,layout:{background:{color:"#111111"},textColor:"#888888"},grid:{vertLines:{color:"#222222"},horzLines:{color:"#222222"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"#333333"},timeScale:{borderColor:"#333333",timeVisible:!0}}),this.candleSeries=this.chart.addCandlestickSeries({upColor:"#00ff00",downColor:"#ff3333",borderUpColor:"#00ff00",borderDownColor:"#ff3333",wickUpColor:"#00ff00",wickDownColor:"#ff3333"});let s=t.points.map(a=>({time:a.timestamp,open:a.open,high:a.high,low:a.low,close:a.close}));this.candleSeries.setData(s),this.chart.timeScale().fitContent(),new ResizeObserver(()=>{this.chart&&e&&this.chart.applyOptions({width:e.clientWidth,height:e.clientHeight})}).observe(e)}async loadNews(t){try{let s=await(await fetch(`/api/news/${t}`)).json();this.renderNews(s)}catch{console.error("Failed to load news")}}renderNews(t){let e=document.getElementById("news-feed");e&&(this.newsData=t.items,e.innerHTML=t.items.map((s,i)=>`
            <div class="news-item">
                <div class="headline" data-news-index="${i}">${s.title}</div>
                <div class="meta">
                    <span>${s.source}</span>
                    <span>${this.formatTime(s.timestamp)}</span>
                    <span class="sentiment ${s.sentiment}">${s.sentiment.toUpperCase()}</span>
                </div>
            </div>
        `).join(""),e.querySelectorAll(".headline").forEach(s=>{s.addEventListener("click",()=>{let i=parseInt(s.dataset.newsIndex||"0",10);this.newsData[i]&&this.openNewsModal(this.newsData[i])})}))}renderDescription(t){let e=document.getElementById("company-description");e&&(e.innerHTML=`
                <p><strong>Sector:</strong> ${t.sector}</p>
                <p><strong>Industry:</strong> ${t.industry}</p>
                <p>${t.description}</p>
            `)}loadQuickTickers(){let t=["AAPL","MSFT","GOOGL","AMZN","NVDA","META","TSLA"];this.tickerList.innerHTML=t.map(e=>`<div class="ticker-item" data-symbol="${e}">${e}</div>`).join(""),this.tickerList.querySelectorAll(".ticker-item").forEach(e=>{e.addEventListener("click",async()=>{let s=e.dataset.symbol;if(s){this.commandInput.value=s;let a=await(await fetch(`/api/search?q=${s}`)).json();a.length>0&&this.selectCompany(a[0])}})})}updateTime(){let t=document.getElementById("current-time");if(t){let e=new Date;t.textContent=e.toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"})}}setStatus(t){this.statusText.textContent=t}formatNumber(t){return b(t)}formatMarketCap(t){return E(t)}formatTime(t){return M(t)}};document.addEventListener("DOMContentLoaded",()=>{});new C;})();
