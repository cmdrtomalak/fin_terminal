"use strict";(()=>{function v(m){return m>=1e9?(m/1e9).toFixed(2)+"B":m>=1e6?(m/1e6).toFixed(2)+"M":m>=1e3?(m/1e3).toFixed(2)+"K":m.toString()}function g(m){return m>=1e12?"$"+(m/1e12).toFixed(2)+"T":m>=1e9?"$"+(m/1e9).toFixed(2)+"B":"$"+(m/1e6).toFixed(2)+"M"}function f(m){let e=new Date(m),a=new Date().getTime()-e.getTime(),i=Math.floor(a/(1e3*60*60));return i<1?"Just now":i<24?`${i}h ago`:e.toLocaleDateString()}function C(m){if(m==null||isNaN(m))return"\u2014";let e=Math.abs(m),t=m<0?"-":"";return e>=1e9?t+"$"+(e/1e9).toFixed(1)+"B":e>=1e6?t+"$"+(e/1e6).toFixed(1)+"M":e>=1e3?t+"$"+(e/1e3).toFixed(1)+"K":t+"$"+e.toFixed(0)}function E(m,e="number"){if(m==null||isNaN(m))return"N/A";switch(e){case"percent":return(m*100).toFixed(2)+"%";case"currency":return g(m);case"ratio":return m.toFixed(2);default:return v(m)}}function y(m){return m==null?"":m>=0?"positive":"negative"}var b=class{constructor(){this.treasuryChart=null;this.commodityChart=null;this.commodityCandleSeries=null;this.currentCommoditySymbol=null;this.currentCommodityName=null;this.currentCommodityDays=30;this.indexChart=null;this.indexCandleSeries=null;this.currentIndexSymbol=null;this.currentIndexName=null;this.currentIndexDays=30;this.treasuryLineSeries=null;this.bondsChart=null;this.bondsLineSeries=null;this.currentTreasuryMaturity=null;this.currentTreasuryDays=365;this.currentBondCountry=null;this.currentBondCountryCode=null;this.currentBondYears=10;this.statementsData=null;this.currentTab="income";this.currentSymbol=null;this.chart=null;this.candleSeries=null;this.searchTimeout=null;this.selectedIndex=-1;this.searchResultsData=[];this.newsData=[];this.commandInput=document.getElementById("command-input"),this.searchResults=document.getElementById("search-results"),this.welcomeScreen=document.getElementById("welcome-screen"),this.securityView=document.getElementById("security-view"),this.tickerList=document.getElementById("ticker-list"),this.statusText=document.getElementById("status-text"),this.newsModal=document.getElementById("news-modal"),this.ratiosModal=document.getElementById("ratios-modal"),this.indexModal=document.getElementById("index-modal"),this.statementsModal=document.getElementById("statements-modal"),this.govtModal=document.getElementById("govt-modal"),this.treasuryChartModal=document.getElementById("treasury-chart-modal"),this.bondsModal=document.getElementById("bonds-modal"),this.bondsChartModal=document.getElementById("bonds-chart-modal"),this.commoditiesModal=document.getElementById("commodities-modal"),this.indexChartModal=document.getElementById("index-chart-modal"),this.commodityChartModal=document.getElementById("commodity-chart-modal"),this.init()}init(){this.setupEventListeners(),this.setupModalListeners(),this.setupRatiosModal(),this.setupIndexModal(),this.setupIndexChartModal(),this.setupStatementsModal(),this.setupGovtModal(),this.setupTreasuryChartModal(),this.setupBondsModal(),this.setupBondsChartModal(),this.setupCommoditiesModal(),this.setupCommodityChartModal(),this.updateTime(),this.loadQuickTickers(),setInterval(()=>this.updateTime(),1e3)}setupEventListeners(){this.commandInput.addEventListener("input",()=>this.handleSearch()),this.commandInput.addEventListener("keydown",e=>this.handleKeydown(e)),this.commandInput.addEventListener("focus",()=>{this.searchResultsData.length>0&&this.searchResults.classList.add("active")}),document.addEventListener("click",e=>{!this.commandInput.contains(e.target)&&!this.searchResults.contains(e.target)&&this.searchResults.classList.remove("active")}),document.querySelectorAll(".chart-btn").forEach(e=>{e.addEventListener("click",t=>{let a=t.target,i=parseInt(a.dataset.days||"90",10);document.querySelectorAll(".chart-btn").forEach(s=>s.classList.remove("active")),a.classList.add("active"),this.currentSymbol&&this.loadChartData(this.currentSymbol,i)})})}setupModalListeners(){let e=document.getElementById("modal-close"),t=this.newsModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.closeModal()),t?.addEventListener("click",()=>this.closeModal()),document.addEventListener("keydown",a=>{a.key==="Escape"&&!this.newsModal.classList.contains("hidden")&&this.closeModal()})}openNewsModal(e){let t=document.getElementById("modal-title"),a=document.getElementById("modal-source"),i=document.getElementById("modal-timestamp"),s=document.getElementById("modal-sentiment"),r=document.getElementById("modal-body"),n=document.getElementById("modal-link");if(t&&(t.textContent=e.title),a&&(a.textContent=e.source),i&&(i.textContent=this.formatTime(e.timestamp)),s&&(s.textContent=e.sentiment,s.className=`modal-sentiment ${e.sentiment}`),r){let l=e.content||e.summary;r.innerHTML=l.split(`

`).map(d=>`<p>${d}</p>`).join("")}n&&(n.href=e.url),this.newsModal.classList.remove("hidden")}closeModal(){this.newsModal.classList.add("hidden")}setupRatiosModal(){let e=document.getElementById("ratios-btn"),t=document.getElementById("ratios-modal-close"),a=this.ratiosModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.openRatiosModal()),t?.addEventListener("click",()=>this.closeRatiosModal()),a?.addEventListener("click",()=>this.closeRatiosModal()),document.addEventListener("keydown",i=>{i.key==="Escape"&&!this.ratiosModal.classList.contains("hidden")&&this.closeRatiosModal()})}async openRatiosModal(){if(!this.currentSymbol)return;let e=document.getElementById("ratios-loading"),t=document.getElementById("ratios-body"),a=document.getElementById("ratios-modal-title");a&&(a.textContent=`${this.currentSymbol} - Financial Ratios`),e&&(e.style.display="block"),t&&(t.innerHTML=""),this.ratiosModal.classList.remove("hidden");try{let i=await fetch(`/api/financials/${this.currentSymbol}`);if(!i.ok)throw new Error("Failed to fetch");let s=await i.json();this.renderRatios(s)}catch{t&&(t.innerHTML='<div class="ratios-loading">Failed to load financial data</div>')}finally{e&&(e.style.display="none")}}closeRatiosModal(){this.ratiosModal.classList.add("hidden")}renderRatios(e){let t=document.getElementById("ratios-body");if(!t)return;let a=(i,s="number")=>E(i,s);t.innerHTML=`
            <div class="ratios-section">
                <div class="ratios-section-title">VALUATION</div>
                <div class="ratio-row"><span class="ratio-label">P/E (TTM)</span><span class="ratio-value">${a(e.pe_ratio,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Forward P/E</span><span class="ratio-value">${a(e.forward_pe,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">PEG Ratio</span><span class="ratio-value">${a(e.peg_ratio,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Price/Book</span><span class="ratio-value">${a(e.price_to_book,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Price/Sales</span><span class="ratio-value">${a(e.price_to_sales,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EV/Revenue</span><span class="ratio-value">${a(e.ev_to_revenue,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EV/EBITDA</span><span class="ratio-value">${a(e.ev_to_ebitda,"ratio")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">PROFITABILITY</div>
                <div class="ratio-row"><span class="ratio-label">Profit Margin</span><span class="ratio-value ${y(e.profit_margin)}">${a(e.profit_margin,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Operating Margin</span><span class="ratio-value ${y(e.operating_margin)}">${a(e.operating_margin,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">ROA</span><span class="ratio-value ${y(e.return_on_assets)}">${a(e.return_on_assets,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">ROE</span><span class="ratio-value ${y(e.return_on_equity)}">${a(e.return_on_equity,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EPS (TTM)</span><span class="ratio-value">${a(e.eps,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EPS Forward</span><span class="ratio-value">${a(e.eps_forward,"ratio")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">GROWTH</div>
                <div class="ratio-row"><span class="ratio-label">Revenue Growth (QoQ)</span><span class="ratio-value ${y(e.quarterly_revenue_growth)}">${a(e.quarterly_revenue_growth,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Earnings Growth (QoQ)</span><span class="ratio-value ${y(e.quarterly_earnings_growth)}">${a(e.quarterly_earnings_growth,"percent")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">INCOME STATEMENT</div>
                <div class="ratio-row"><span class="ratio-label">Revenue</span><span class="ratio-value">${a(e.revenue,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Revenue/Share</span><span class="ratio-value">${a(e.revenue_per_share,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Gross Profit</span><span class="ratio-value">${a(e.gross_profit,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EBITDA</span><span class="ratio-value">${a(e.ebitda,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Net Income</span><span class="ratio-value">${a(e.net_income,"currency")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">BALANCE SHEET</div>
                <div class="ratio-row"><span class="ratio-label">Total Cash</span><span class="ratio-value">${a(e.total_cash,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Total Debt</span><span class="ratio-value">${a(e.total_debt,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Debt/Equity</span><span class="ratio-value">${a(e.debt_to_equity,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Current Ratio</span><span class="ratio-value">${a(e.current_ratio,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Book Value</span><span class="ratio-value">${a(e.book_value,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Enterprise Value</span><span class="ratio-value">${a(e.enterprise_value,"currency")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">CASH FLOW</div>
                <div class="ratio-row"><span class="ratio-label">Operating Cash Flow</span><span class="ratio-value">${a(e.operating_cash_flow,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Free Cash Flow</span><span class="ratio-value">${a(e.free_cash_flow,"currency")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">STOCK INFO</div>
                <div class="ratio-row"><span class="ratio-label">Beta</span><span class="ratio-value">${a(e.beta,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Shares Outstanding</span><span class="ratio-value">${a(e.shares_outstanding,"number")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Float</span><span class="ratio-value">${a(e.float_shares,"number")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Insider Ownership</span><span class="ratio-value">${a(e.held_by_insiders,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Institutional Ownership</span><span class="ratio-value">${a(e.held_by_institutions,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Short Ratio</span><span class="ratio-value">${a(e.short_ratio,"ratio")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">DIVIDENDS</div>
                <div class="ratio-row"><span class="ratio-label">Dividend Rate</span><span class="ratio-value">${a(e.dividend_rate,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Dividend Yield</span><span class="ratio-value">${a(e.dividend_yield,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Payout Ratio</span><span class="ratio-value">${a(e.payout_ratio,"percent")}</span></div>
            </div>
        `}setupIndexModal(){let e=document.querySelector('[data-fn="INDEX"]'),t=document.getElementById("index-modal-close"),a=this.indexModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.openIndexModal()),t?.addEventListener("click",()=>this.closeIndexModal()),a?.addEventListener("click",()=>this.closeIndexModal()),document.addEventListener("keydown",i=>{i.key==="Escape"&&!this.indexModal.classList.contains("hidden")&&this.closeIndexModal()})}async openIndexModal(){let e=document.getElementById("index-loading"),t=document.getElementById("index-body");e&&(e.style.display="block"),t&&(t.innerHTML=""),this.indexModal.classList.remove("hidden");try{let a=await fetch("/api/indices");if(!a.ok)throw new Error("Failed to fetch");let i=await a.json();this.renderIndices(i)}catch{t&&(t.innerHTML='<div class="ratios-loading">Failed to load indices</div>')}finally{e&&(e.style.display="none")}}closeIndexModal(){this.indexModal.classList.add("hidden")}setupIndexChartModal(){let e=document.getElementById("index-chart-modal-close"),t=this.indexChartModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.closeIndexChartModal()),t?.addEventListener("click",()=>this.closeIndexChartModal()),this.indexChartModal.querySelectorAll(".chart-btn").forEach(a=>{a.addEventListener("click",i=>{let s=i.target,r=parseInt(s.dataset.days||"30",10);this.indexChartModal.querySelectorAll(".chart-btn").forEach(n=>n.classList.remove("active")),s.classList.add("active"),this.currentIndexSymbol&&(this.currentIndexDays=r,this.loadIndexChartData(this.currentIndexSymbol,r))})}),document.addEventListener("keydown",a=>{a.key==="Escape"&&!this.indexChartModal.classList.contains("hidden")&&this.closeIndexChartModal()})}async openIndexChartModal(e,t){this.currentIndexSymbol=e,this.currentIndexName=t,this.currentIndexDays=30;let a=document.getElementById("index-chart-title"),i=document.getElementById("index-chart-loading"),s=document.getElementById("index-chart-container");a&&(a.textContent=`${t} (${e})`),i&&(i.style.display="block"),s&&(s.innerHTML=""),this.indexChartModal.querySelectorAll(".chart-btn").forEach(r=>{r.classList.toggle("active",r.getAttribute("data-days")==="30")}),this.indexChartModal.classList.remove("hidden"),await this.loadIndexChartData(e,30)}closeIndexChartModal(){this.indexChartModal.classList.add("hidden"),this.indexChart&&(this.indexChart.remove(),this.indexChart=null,this.indexCandleSeries=null),this.currentIndexSymbol=null,this.currentIndexName=null}async loadIndexChartData(e,t){let a=document.getElementById("index-chart-loading"),i=document.getElementById("index-chart-container");a&&(a.style.display="block");try{let s=await fetch(`/api/chart/${encodeURIComponent(e)}?days=${t}`);if(!s.ok)throw new Error("Failed to fetch chart data");let r=await s.json();this.renderIndexChart(r)}catch{i&&(i.innerHTML='<div class="ratios-loading">Failed to load chart data</div>')}finally{a&&(a.style.display="none")}}renderIndexChart(e){let t=document.getElementById("index-chart-container");if(!t)return;if(this.indexChart&&(this.indexChart.remove(),this.indexChart=null,this.indexCandleSeries=null),t.innerHTML="",e.points.length===0){t.innerHTML='<div class="ratios-loading">No chart data available</div>';return}this.indexChart=LightweightCharts.createChart(t,{width:t.clientWidth,height:400,layout:{background:{color:"#1a1a1a"},textColor:"#ff9900"},grid:{vertLines:{color:"rgba(255, 153, 0, 0.1)"},horzLines:{color:"rgba(255, 153, 0, 0.1)"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"rgba(255, 153, 0, 0.3)"},timeScale:{borderColor:"rgba(255, 153, 0, 0.3)",timeVisible:!0,secondsVisible:!1}}),this.indexCandleSeries=this.indexChart.addCandlestickSeries({upColor:"#00ff00",downColor:"#ff3333",borderUpColor:"#00ff00",borderDownColor:"#ff3333",wickUpColor:"#00ff00",wickDownColor:"#ff3333"});let a=e.points.map(s=>({time:s.timestamp,open:s.open,high:s.high,low:s.low,close:s.close}));this.indexCandleSeries.setData(a),this.indexChart.timeScale().fitContent(),new ResizeObserver(()=>{this.indexChart&&t&&this.indexChart.applyOptions({width:t.clientWidth})}).observe(t)}renderIndices(e){let t=document.getElementById("index-body");if(!t)return;let i=(l=>{let d=new Map,o=["US","UK","Germany","France","Europe","Netherlands","Spain","Italy","Switzerland","Japan","Hong Kong","China","Australia","South Korea","Taiwan","India","Singapore","Brazil","Mexico","Canada"];for(let u of o){let p=l.filter(c=>c.region===u);p.length>0&&d.set(u,p)}return d})(e),s="",r={US:"UNITED STATES",UK:"UNITED KINGDOM",Germany:"GERMANY",France:"FRANCE",Europe:"EUROPE",Netherlands:"NETHERLANDS",Spain:"SPAIN",Italy:"ITALY",Switzerland:"SWITZERLAND",Japan:"JAPAN","Hong Kong":"HONG KONG",China:"CHINA",Australia:"AUSTRALIA","South Korea":"SOUTH KOREA",Taiwan:"TAIWAN",India:"INDIA",Singapore:"SINGAPORE",Brazil:"BRAZIL",Mexico:"MEXICO",Canada:"CANADA"},n=l=>l.replace(/&/g,"").replace(/"/g,"").replace(/'/g,"").replace(/</g,"").replace(/>/g,"");i.forEach((l,d)=>{s+=`<div class="index-section">
                <div class="index-section-title">${r[d]||d}</div>`;for(let o of l){let u=o.change>=0?"positive":"negative",p=o.change>=0?"+":"";s+=`
                <div class="index-row clickable" data-symbol="${n(o.symbol)}" data-name="${n(o.name)}">
                    <div class="index-info">
                        <span class="index-symbol">${n(o.symbol)}</span>
                        <span class="index-name">${n(o.name)}</span>
                    </div>
                    <div class="index-data">
                        <span class="index-price">${o.price.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
                        <span class="index-change ${u}">${p}${o.change.toFixed(2)}</span>
                        <span class="index-percent ${u}">${p}${o.change_percent.toFixed(2)}%</span>
                    </div>
                </div>`}s+="</div>"}),t.innerHTML=s,t.querySelectorAll(".index-row.clickable").forEach(l=>{l.addEventListener("click",()=>{let d=l.getAttribute("data-symbol"),o=l.getAttribute("data-name");d&&o&&this.openIndexChartModal(d,o)})})}setupStatementsModal(){let e=document.getElementById("statements-btn"),t=document.getElementById("statements-modal-close"),a=this.statementsModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.openStatementsModal()),t?.addEventListener("click",()=>this.closeStatementsModal()),a?.addEventListener("click",()=>this.closeStatementsModal()),this.statementsModal.querySelectorAll(".stmt-tab").forEach(i=>{i.addEventListener("click",s=>{let r=s.target,n=r.dataset.tab;this.currentTab=n,this.statementsModal.querySelectorAll(".stmt-tab").forEach(l=>l.classList.remove("active")),r.classList.add("active"),this.statementsData&&this.renderStatements(this.statementsData)})}),document.addEventListener("keydown",i=>{i.key==="Escape"&&!this.statementsModal.classList.contains("hidden")&&this.closeStatementsModal()})}setupGovtModal(){let e=document.querySelector('[data-fn="GOVT"]'),t=document.getElementById("govt-modal-close"),a=document.getElementById("govt-refresh-btn"),i=this.govtModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.openGovtModal()),t?.addEventListener("click",()=>this.closeGovtModal()),a?.addEventListener("click",()=>this.refreshTreasury()),i?.addEventListener("click",()=>this.closeGovtModal()),document.addEventListener("keydown",s=>{s.key==="Escape"&&!this.govtModal.classList.contains("hidden")&&this.closeGovtModal()})}async openGovtModal(){let e=document.getElementById("govt-loading"),t=document.getElementById("govt-body");e&&(e.style.display="block"),t&&(t.innerHTML=""),this.govtModal.classList.remove("hidden");try{let a=await fetch("/api/treasury");if(!a.ok)throw new Error("Failed to fetch");let i=await a.json();this.renderTreasury(i)}catch{t&&(t.innerHTML='<div class="ratios-loading">Failed to load treasury rates</div>')}finally{e&&(e.style.display="none")}}closeGovtModal(){this.govtModal.classList.add("hidden")}async refreshTreasury(){let e=document.getElementById("govt-loading"),t=document.getElementById("govt-body"),a=document.getElementById("govt-refresh-btn");a&&(a.classList.add("spinning"),a.disabled=!0),e&&(e.style.display="block"),t&&(t.innerHTML="");try{let i=await fetch("/api/treasury/refresh",{method:"POST"});if(!i.ok)throw new Error("Failed to refresh");let s=await i.json();this.renderTreasury(s)}catch{t&&(t.innerHTML='<div class="ratios-loading">Failed to refresh treasury rates</div>')}finally{e&&(e.style.display="none"),a&&(a.classList.remove("spinning"),a.disabled=!1)}}renderTreasury(e){let t=document.getElementById("govt-body");if(!t)return;let a=e.rates.filter(d=>["1 Mo","1.5 Month","2 Mo","3 Mo","4 Mo","6 Mo"].includes(d.maturity)),i=e.rates.filter(d=>["1 Yr","2 Yr","3 Yr","5 Yr","7 Yr","10 Yr","20 Yr","30 Yr"].includes(d.maturity)),s=d=>{let o=d.change>=0?"positive":"negative",u=d.change>=0?"+":"";return`
                <div class="treasury-row">
                    <span class="treasury-maturity">${d.maturity}</span>
                    <span class="treasury-yield">${d.yield_rate.toFixed(2)}%</span>
                    <span class="treasury-change ${o}">${u}${d.change.toFixed(2)}</span>
                    <span class="treasury-pct ${o}">${u}${d.change_percent.toFixed(2)}%</span>
                </div>
            `},r="";a.length>0&&(r+=`
                <div class="treasury-section">
                    <div class="treasury-section-title">SHORT-TERM (BILLS)</div>
                    <div class="treasury-header">
                        <span>Maturity</span>
                        <span>Yield</span>
                        <span>Chg</span>
                        <span>Chg %</span>
                    </div>
                    ${a.map(s).join("")}
                </div>
            `),i.length>0&&(r+=`
                <div class="treasury-section">
                    <div class="treasury-section-title">LONG-TERM (NOTES & BONDS)</div>
                    <div class="treasury-header">
                        <span>Maturity</span>
                        <span>Yield</span>
                        <span>Chg</span>
                        <span>Chg %</span>
                    </div>
                    ${i.map(s).join("")}
                </div>
            `);let n=e.rates.find(d=>d.maturity==="10 Yr"),l=e.rates.find(d=>d.maturity==="2 Yr");if(n&&l){let d=n.yield_rate-l.yield_rate,o=d>=0?"positive":"negative";r+=`
                <div class="treasury-section">
                    <div class="treasury-section-title">YIELD CURVE</div>
                    <div class="treasury-row">
                        <span class="treasury-maturity">10Y-2Y Spread</span>
                        <span class="treasury-yield ${o}">${d>=0?"+":""}${(d*100).toFixed(0)} bps</span>
                        <span class="treasury-change"></span>
                        <span class="treasury-pct"></span>
                    </div>
                </div>
            `}r+=`<div class="treasury-updated">Last updated: ${new Date(e.updated_at).toLocaleString()}</div>`,t.innerHTML=r,t.querySelectorAll(".treasury-row").forEach(d=>{let o=d.querySelector(".treasury-maturity");if(o){let u=o.textContent;u&&!u.includes("Spread")&&(d.classList.add("clickable"),d.addEventListener("click",()=>this.openTreasuryChartModal(u)))}})}setupTreasuryChartModal(){let e=document.getElementById("treasury-chart-modal-close"),t=this.treasuryChartModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.closeTreasuryChartModal()),t?.addEventListener("click",()=>this.closeTreasuryChartModal()),document.addEventListener("keydown",a=>{a.key==="Escape"&&!this.treasuryChartModal.classList.contains("hidden")&&this.closeTreasuryChartModal()}),this.treasuryChartModal.querySelectorAll(".treasury-range-btn").forEach(a=>{a.addEventListener("click",i=>{let s=i.target,r=parseInt(s.dataset.days||"365",10);this.treasuryChartModal.querySelectorAll(".treasury-range-btn").forEach(n=>n.classList.remove("active")),s.classList.add("active"),this.currentTreasuryDays=r,this.currentTreasuryMaturity&&this.loadTreasuryHistory(this.currentTreasuryMaturity,r)})})}async openTreasuryChartModal(e){this.currentTreasuryMaturity=e,this.currentTreasuryDays=365;let t=document.getElementById("treasury-chart-title"),a=document.getElementById("treasury-chart-loading"),i=document.getElementById("treasury-chart-container");t&&(t.textContent=`${e} Treasury Yield History`),a&&(a.style.display="block"),i&&(i.innerHTML=""),this.treasuryChartModal.querySelectorAll(".treasury-range-btn").forEach(s=>{s.classList.toggle("active",s.getAttribute("data-days")==="365")}),this.treasuryChartModal.classList.remove("hidden"),await this.loadTreasuryHistory(e,365)}closeTreasuryChartModal(){this.treasuryChartModal.classList.add("hidden"),this.treasuryChart&&(this.treasuryChart.remove(),this.treasuryChart=null,this.treasuryLineSeries=null),this.currentTreasuryMaturity=null}async loadTreasuryHistory(e,t){let a=document.getElementById("treasury-chart-loading"),i=document.getElementById("treasury-chart-container");a&&(a.style.display="block");try{let s=encodeURIComponent(e),r=await fetch(`/api/treasury/history/${s}?days=${t}`);if(!r.ok)throw new Error("Failed to fetch treasury history");let n=await r.json();this.renderTreasuryChart(n)}catch{i&&(i.innerHTML='<div class="ratios-loading">Failed to load treasury history</div>')}finally{a&&(a.style.display="none")}}renderTreasuryChart(e){let t=document.getElementById("treasury-chart-container");if(!t)return;if(this.treasuryChart&&(this.treasuryChart.remove(),this.treasuryChart=null,this.treasuryLineSeries=null),t.innerHTML="",e.points.length===0){t.innerHTML='<div class="ratios-loading">No historical data available</div>';return}this.treasuryChart=LightweightCharts.createChart(t,{width:t.clientWidth,height:400,layout:{background:{color:"#1a1a1a"},textColor:"#ff9900"},grid:{vertLines:{color:"rgba(255, 153, 0, 0.1)"},horzLines:{color:"rgba(255, 153, 0, 0.1)"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"rgba(255, 153, 0, 0.3)"},timeScale:{borderColor:"rgba(255, 153, 0, 0.3)",timeVisible:!0,secondsVisible:!1}}),this.treasuryLineSeries=this.treasuryChart.addLineSeries({color:"#ff9900",lineWidth:2,crosshairMarkerVisible:!0,crosshairMarkerRadius:4,priceFormat:{type:"price",precision:2,minMove:.01}});let a=e.points.map(s=>({time:s.date,value:s.yield_rate}));this.treasuryLineSeries.setData(a),this.treasuryChart.timeScale().fitContent(),new ResizeObserver(()=>{this.treasuryChart&&t&&this.treasuryChart.applyOptions({width:t.clientWidth})}).observe(t)}setupBondsModal(){let e=document.querySelector('[data-fn="INTL"]'),t=document.getElementById("bonds-modal-close"),a=this.bondsModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.openBondsModal()),t?.addEventListener("click",()=>this.closeBondsModal()),a?.addEventListener("click",()=>this.closeBondsModal()),document.addEventListener("keydown",i=>{i.key==="Escape"&&!this.bondsModal.classList.contains("hidden")&&this.closeBondsModal()})}async openBondsModal(){let e=document.getElementById("bonds-loading"),t=document.getElementById("bonds-body"),a=document.getElementById("bonds-date");e&&(e.style.display="block"),t&&(t.innerHTML=""),this.bondsModal.classList.remove("hidden");try{let i=await fetch("/api/bonds");if(!i.ok)throw new Error("Failed to fetch");let s=await i.json();a&&(a.textContent=`Updated: ${new Date(s.updated_at).toLocaleString()}`),this.renderBonds(s)}catch{t&&(t.innerHTML='<div class="ratios-loading">Failed to load bond yields</div>')}finally{e&&(e.style.display="none")}}closeBondsModal(){this.bondsModal.classList.add("hidden")}renderBonds(e){let t=document.getElementById("bonds-body");if(!t)return;let a=["CN"],i=r=>{let n=r.change>=0?"positive":"negative",l=r.change>=0?"+":"",d=r.data_frequency==="daily"?"freq-daily":"freq-monthly",o=!a.includes(r.country_code),u=o?"clickable":"",p=o?"":'title="Historical chart not available"';return`
                <div class="bonds-row ${u}" data-country="${r.country}" data-country-code="${r.country_code}" ${p}>
                    <div class="bonds-info">
                        <span class="bonds-country">${r.country}<span class="bonds-freq ${d}" title="${r.data_frequency} data"></span></span>
                        <span class="bonds-code">${r.country_code}</span>
                    </div>
                    <div class="bonds-data">
                        <span class="bonds-yield">${r.yield_10y.toFixed(2)}%</span>
                        <span class="bonds-change ${n}">${l}${r.change.toFixed(2)}</span>
                        <span class="bonds-pct ${n}">${l}${r.change_percent.toFixed(2)}%</span>
                    </div>
                </div>
            `},s=`
            <div class="bonds-section">
                <div class="bonds-header">
                    <span>Country</span>
                    <span>10Y Yield</span>
                    <span>Chg</span>
                    <span>Chg %</span>
                </div>
                ${e.bonds.map(i).join("")}
            </div>
            <div class="bonds-legend">
                <span class="bonds-freq freq-daily"></span> Daily
                <span class="bonds-freq freq-monthly" style="margin-left: 8px;"></span> Monthly
            </div>
        `;t.innerHTML=s,t.querySelectorAll(".bonds-row.clickable").forEach(r=>{r.addEventListener("click",()=>{let n=r.dataset.country,l=r.dataset.countryCode;n&&l&&this.openBondsChartModal(n,l)})})}setupBondsChartModal(){let e=document.getElementById("bonds-chart-modal-close"),t=this.bondsChartModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.closeBondsChartModal()),t?.addEventListener("click",()=>this.closeBondsChartModal()),document.addEventListener("keydown",a=>{a.key==="Escape"&&!this.bondsChartModal.classList.contains("hidden")&&this.closeBondsChartModal()}),this.bondsChartModal.querySelectorAll(".bonds-range-btn").forEach(a=>{a.addEventListener("click",i=>{let s=i.target,r=parseInt(s.dataset.years||"10",10);this.bondsChartModal.querySelectorAll(".bonds-range-btn").forEach(n=>n.classList.remove("active")),s.classList.add("active"),this.currentBondYears=r,this.currentBondCountryCode&&this.loadBondHistory(this.currentBondCountryCode,r)})})}async openBondsChartModal(e,t){this.currentBondCountry=e,this.currentBondCountryCode=t,this.currentBondYears=10;let a=document.getElementById("bonds-chart-title"),i=document.getElementById("bonds-chart-loading"),s=document.getElementById("bonds-chart-container");a&&(a.textContent=`${e} 10 Year Bond Yield History`),i&&(i.style.display="block"),s&&(s.innerHTML=""),this.bondsChartModal.querySelectorAll(".bonds-range-btn").forEach(r=>{r.classList.toggle("active",r.getAttribute("data-years")==="10")}),this.bondsChartModal.classList.remove("hidden"),await this.loadBondHistory(t,10)}closeBondsChartModal(){this.bondsChartModal.classList.add("hidden"),this.bondsChart&&(this.bondsChart.remove(),this.bondsChart=null,this.bondsLineSeries=null),this.currentBondCountry=null,this.currentBondCountryCode=null}async loadBondHistory(e,t){let a=document.getElementById("bonds-chart-loading"),i=document.getElementById("bonds-chart-container"),s=document.getElementById("bonds-chart-notice");a&&(a.style.display="block");try{let r=await fetch(`/api/bonds/history/${e}?years=${t}`);if(!r.ok)throw new Error("Failed to fetch bond history");let n=await r.json();s&&(s.textContent=n.data_delay),this.renderBondsChart(n)}catch{i&&(i.innerHTML='<div class="ratios-loading">Failed to load bond history</div>')}finally{a&&(a.style.display="none")}}renderBondsChart(e){let t=document.getElementById("bonds-chart-container");if(!t)return;if(this.bondsChart&&(this.bondsChart.remove(),this.bondsChart=null,this.bondsLineSeries=null),t.innerHTML="",e.points.length===0){t.innerHTML='<div class="ratios-loading">No historical data available</div>';return}this.bondsChart=LightweightCharts.createChart(t,{width:t.clientWidth,height:400,layout:{background:{color:"#1a1a1a"},textColor:"#ff9900"},grid:{vertLines:{color:"rgba(255, 153, 0, 0.1)"},horzLines:{color:"rgba(255, 153, 0, 0.1)"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"rgba(255, 153, 0, 0.3)"},timeScale:{borderColor:"rgba(255, 153, 0, 0.3)",timeVisible:!0,secondsVisible:!1}}),this.bondsLineSeries=this.bondsChart.addLineSeries({color:"#ff9900",lineWidth:2,crosshairMarkerVisible:!0,crosshairMarkerRadius:4,priceFormat:{type:"price",precision:2,minMove:.01}});let a=e.points.map(s=>({time:s.date,value:s.yield_rate}));this.bondsLineSeries.setData(a),this.bondsChart.timeScale().fitContent(),new ResizeObserver(()=>{this.bondsChart&&t&&this.bondsChart.applyOptions({width:t.clientWidth})}).observe(t)}setupCommoditiesModal(){let e=document.querySelector('[data-fn="CMDTY"]'),t=document.getElementById("commodities-modal-close"),a=this.commoditiesModal?.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.openCommoditiesModal()),t?.addEventListener("click",()=>this.closeCommoditiesModal()),a?.addEventListener("click",()=>this.closeCommoditiesModal()),document.addEventListener("keydown",i=>{i.key==="Escape"&&!this.commoditiesModal?.classList.contains("hidden")&&this.closeCommoditiesModal()})}async openCommoditiesModal(){let e=document.getElementById("commodities-loading"),t=document.getElementById("commodities-body");e&&(e.style.display="block"),t&&(t.innerHTML=""),this.commoditiesModal.classList.remove("hidden");try{let a=await fetch("/api/commodities");if(!a.ok)throw new Error("Failed to fetch");let i=await a.json();this.renderCommodities(i)}catch{t&&(t.innerHTML='<div class="ratios-loading">Failed to load commodities</div>')}finally{e&&(e.style.display="none")}}closeCommoditiesModal(){this.commoditiesModal.classList.add("hidden")}setupCommodityChartModal(){let e=document.getElementById("commodity-chart-modal-close"),t=this.commodityChartModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.closeCommodityChartModal()),t?.addEventListener("click",()=>this.closeCommodityChartModal()),this.commodityChartModal.querySelectorAll(".chart-btn").forEach(a=>{a.addEventListener("click",i=>{let s=i.target,r=parseInt(s.dataset.days||"30",10);this.commodityChartModal.querySelectorAll(".chart-btn").forEach(n=>n.classList.remove("active")),s.classList.add("active"),this.currentCommoditySymbol&&(this.currentCommodityDays=r,this.loadCommodityChartData(this.currentCommoditySymbol,r))})}),document.addEventListener("keydown",a=>{a.key==="Escape"&&!this.commodityChartModal.classList.contains("hidden")&&this.closeCommodityChartModal()})}async openCommodityChartModal(e,t){this.currentCommoditySymbol=e,this.currentCommodityName=t,this.currentCommodityDays=30;let a=document.getElementById("commodity-chart-title"),i=document.getElementById("commodity-chart-loading"),s=document.getElementById("commodity-chart-container");a&&(a.textContent=`${t} (${e})`),i&&(i.style.display="block"),s&&(s.innerHTML=""),this.commodityChartModal.querySelectorAll(".chart-btn").forEach(r=>{r.classList.toggle("active",r.getAttribute("data-days")==="30")}),this.commodityChartModal.classList.remove("hidden"),await this.loadCommodityChartData(e,30)}closeCommodityChartModal(){this.commodityChartModal.classList.add("hidden"),this.commodityChart&&(this.commodityChart.remove(),this.commodityChart=null,this.commodityCandleSeries=null),this.currentCommoditySymbol=null,this.currentCommodityName=null}async loadCommodityChartData(e,t){let a=document.getElementById("commodity-chart-loading"),i=document.getElementById("commodity-chart-container");a&&(a.style.display="block");try{let s=await fetch(`/api/chart/${encodeURIComponent(e)}?days=${t}`);if(!s.ok)throw new Error("Failed to fetch chart data");let r=await s.json();this.renderCommodityChart(r)}catch{i&&(i.innerHTML='<div class="ratios-loading">Failed to load chart data</div>')}finally{a&&(a.style.display="none")}}renderCommodityChart(e){let t=document.getElementById("commodity-chart-container");if(!t)return;if(this.commodityChart&&(this.commodityChart.remove(),this.commodityChart=null,this.commodityCandleSeries=null),t.innerHTML="",e.points.length===0){t.innerHTML='<div class="ratios-loading">No chart data available</div>';return}this.commodityChart=LightweightCharts.createChart(t,{width:t.clientWidth,height:400,layout:{background:{color:"#1a1a1a"},textColor:"#ff9900"},grid:{vertLines:{color:"rgba(255, 153, 0, 0.1)"},horzLines:{color:"rgba(255, 153, 0, 0.1)"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"rgba(255, 153, 0, 0.3)"},timeScale:{borderColor:"rgba(255, 153, 0, 0.3)",timeVisible:!0,secondsVisible:!1}}),this.commodityCandleSeries=this.commodityChart.addCandlestickSeries({upColor:"#00ff00",downColor:"#ff3333",borderUpColor:"#00ff00",borderDownColor:"#ff3333",wickUpColor:"#00ff00",wickDownColor:"#ff3333"});let a=e.points.map(s=>({time:s.timestamp,open:s.open,high:s.high,low:s.low,close:s.close}));this.commodityCandleSeries.setData(a),this.commodityChart.timeScale().fitContent(),new ResizeObserver(()=>{this.commodityChart&&t&&this.commodityChart.applyOptions({width:t.clientWidth})}).observe(t)}renderCommodities(e){let t=document.getElementById("commodities-body");if(!t)return;let a=[...new Set(e.commodities.map(n=>n.category))],i=n=>n.replace(/&/g,"").replace(/"/g,"").replace(/'/g,"").replace(/</g,"").replace(/>/g,""),s=n=>{let l=n.change>=0?"positive":"negative",d=n.change>=0?"+":"";return`
                <div class="commodity-row clickable" data-symbol="${i(n.symbol)}" data-name="${i(n.name)}">
                    <div class="commodity-info">
                        <span class="commodity-name">${i(n.name)}</span>
                        <span class="commodity-unit">${n.unit}</span>
                    </div>
                    <div class="commodity-data">
                        <span class="commodity-price">${n.price.toFixed(2)}</span>
                        <span class="commodity-change ${l}">${d}${n.change.toFixed(2)}</span>
                        <span class="commodity-pct ${l}">${d}${n.change_percent.toFixed(2)}%</span>
                    </div>
                </div>
            `},r="";for(let n of a){let l=e.commodities.filter(d=>d.category===n);r+=`
                <div class="commodity-section">
                    <div class="commodity-category">${n}</div>
                    ${l.map(s).join("")}
                </div>
            `}t.innerHTML=r,t.querySelectorAll(".commodity-row.clickable").forEach(n=>{n.addEventListener("click",()=>{let l=n.getAttribute("data-symbol"),d=n.getAttribute("data-name");l&&d&&this.openCommodityChartModal(l,d)})})}async openStatementsModal(){if(!this.currentSymbol)return;let e=document.getElementById("statements-loading"),t=document.getElementById("statements-body"),a=document.getElementById("statements-modal-title");a&&(a.textContent=`${this.currentSymbol} - Financial Statements`),e&&(e.style.display="block"),t&&(t.innerHTML=""),this.statementsModal.classList.remove("hidden");try{let i=await fetch(`/api/statements/${this.currentSymbol}`);if(!i.ok)throw new Error("Failed to fetch");this.statementsData=await i.json(),this.renderStatements(this.statementsData)}catch{t&&(t.innerHTML='<div class="ratios-loading">Failed to load financial statements</div>')}finally{e&&(e.style.display="none")}}closeStatementsModal(){this.statementsModal.classList.add("hidden")}renderStatements(e){let t=document.getElementById("statements-body");if(!t)return;let a=n=>C(n),i=n=>n.some(l=>l!=null&&l!==0),s=(n,l,d=!1)=>i(l)?`<tr${d?' class="stmt-highlight"':""}><td>${n}</td>${l.map(u=>`<td class="${y(u)}">${a(u)}</td>`).join("")}</tr>`:"",r="";if(this.currentTab==="income"){let n=e.income_statements;if(n.length===0)r='<div class="ratios-loading">No income statement data available</div>';else{let l=n.map(o=>o.fiscal_year.split("-")[0]||o.fiscal_year),d=[s("Total Revenue",n.map(o=>o.total_revenue),!0),s("Cost of Revenue",n.map(o=>o.cost_of_revenue)),s("Gross Profit",n.map(o=>o.gross_profit),!0),s("R&D Expenses",n.map(o=>o.research_development)),s("SG&A Expenses",n.map(o=>o.selling_general_admin)),s("Total Operating Expenses",n.map(o=>o.total_operating_expenses)),s("Operating Income",n.map(o=>o.operating_income),!0),s("Interest Expense",n.map(o=>o.interest_expense)),s("Income Before Tax",n.map(o=>o.income_before_tax)),s("Income Tax Expense",n.map(o=>o.income_tax_expense)),s("Net Income",n.map(o=>o.net_income),!0),s("EBIT",n.map(o=>o.ebit)),s("EBITDA",n.map(o=>o.ebitda))].filter(o=>o).join("");r=`
                    <table class="statements-table">
                        <thead>
                            <tr>
                                <th class="stmt-label-col">Item</th>
                                ${l.map(o=>`<th class="stmt-value-col">${o}</th>`).join("")}
                            </tr>
                        </thead>
                        <tbody>${d}</tbody>
                    </table>
                `}}else if(this.currentTab==="balance"){let n=e.balance_sheets;if(n.length===0)r='<div class="ratios-loading">No balance sheet data available</div>';else{let l=n.map(c=>c.fiscal_year.split("-")[0]||c.fiscal_year),d=[s("Cash & Equivalents",n.map(c=>c.cash_and_equivalents)),s("Short-term Investments",n.map(c=>c.short_term_investments)),s("Accounts Receivable",n.map(c=>c.accounts_receivable)),s("Inventory",n.map(c=>c.inventory)),s("Total Current Assets",n.map(c=>c.total_current_assets),!0),s("Property, Plant & Equipment",n.map(c=>c.property_plant_equipment)),s("Goodwill",n.map(c=>c.goodwill)),s("Intangible Assets",n.map(c=>c.intangible_assets)),s("Total Assets",n.map(c=>c.total_assets),!0)].filter(c=>c).join(""),o=[s("Accounts Payable",n.map(c=>c.accounts_payable)),s("Short-term Debt",n.map(c=>c.short_term_debt)),s("Total Current Liabilities",n.map(c=>c.total_current_liabilities),!0),s("Long-term Debt",n.map(c=>c.long_term_debt)),s("Total Liabilities",n.map(c=>c.total_liabilities),!0)].filter(c=>c).join(""),u=[s("Common Stock",n.map(c=>c.common_stock)),s("Retained Earnings",n.map(c=>c.retained_earnings)),s("Total Stockholders Equity",n.map(c=>c.total_stockholders_equity),!0)].filter(c=>c).join(""),p="";d&&(p+=`<tr class="stmt-section-header"><td colspan="${l.length+1}">ASSETS</td></tr>${d}`),o&&(p+=`<tr class="stmt-section-header"><td colspan="${l.length+1}">LIABILITIES</td></tr>${o}`),u&&(p+=`<tr class="stmt-section-header"><td colspan="${l.length+1}">EQUITY</td></tr>${u}`),p?r=`
                        <table class="statements-table">
                            <thead>
                                <tr>
                                    <th class="stmt-label-col">Item</th>
                                    ${l.map(c=>`<th class="stmt-value-col">${c}</th>`).join("")}
                                </tr>
                            </thead>
                            <tbody>${p}</tbody>
                        </table>
                    `:r='<div class="ratios-loading">No balance sheet data available</div>'}}else if(this.currentTab==="cashflow"){let n=e.cash_flows;if(n.length===0)r='<div class="ratios-loading">No cash flow data available</div>';else{let l=n.map(h=>h.fiscal_year.split("-")[0]||h.fiscal_year),d=[s("Net Income",n.map(h=>h.net_income)),s("Depreciation",n.map(h=>h.depreciation)),s("Change in Working Capital",n.map(h=>h.change_in_working_capital)),s("Operating Cash Flow",n.map(h=>h.operating_cash_flow),!0)].filter(h=>h).join(""),o=[s("Capital Expenditures",n.map(h=>h.capital_expenditures)),s("Investments",n.map(h=>h.investments)),s("Investing Cash Flow",n.map(h=>h.investing_cash_flow),!0)].filter(h=>h).join(""),u=[s("Dividends Paid",n.map(h=>h.dividends_paid)),s("Stock Repurchases",n.map(h=>h.stock_repurchases)),s("Debt Repayment",n.map(h=>h.debt_repayment)),s("Financing Cash Flow",n.map(h=>h.financing_cash_flow),!0)].filter(h=>h).join(""),p=s("Free Cash Flow",n.map(h=>h.free_cash_flow),!0),c="";d&&(c+=`<tr class="stmt-section-header"><td colspan="${l.length+1}">OPERATING ACTIVITIES</td></tr>${d}`),o&&(c+=`<tr class="stmt-section-header"><td colspan="${l.length+1}">INVESTING ACTIVITIES</td></tr>${o}`),u&&(c+=`<tr class="stmt-section-header"><td colspan="${l.length+1}">FINANCING ACTIVITIES</td></tr>${u}`),p&&(c+=`<tr class="stmt-section-header"><td colspan="${l.length+1}">FREE CASH FLOW</td></tr>${p}`),c?r=`
                        <table class="statements-table">
                            <thead>
                                <tr>
                                    <th class="stmt-label-col">Item</th>
                                    ${l.map(h=>`<th class="stmt-value-col">${h}</th>`).join("")}
                                </tr>
                            </thead>
                            <tbody>${c}</tbody>
                        </table>
                    `:r='<div class="ratios-loading">No cash flow data available</div>'}}t.innerHTML=r}handleKeydown(e){let t=this.searchResults.querySelectorAll(".search-item");e.key==="ArrowDown"?(e.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,t.length-1),this.updateSelectedItem(t)):e.key==="ArrowUp"?(e.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,-1),this.updateSelectedItem(t)):e.key==="Enter"?(e.preventDefault(),this.selectedIndex>=0&&this.searchResultsData[this.selectedIndex]?this.selectCompany(this.searchResultsData[this.selectedIndex]):this.searchResultsData.length>0&&this.selectCompany(this.searchResultsData[0])):e.key==="Escape"&&(this.searchResults.classList.remove("active"),this.selectedIndex=-1)}updateSelectedItem(e){e.forEach((t,a)=>{t.classList.toggle("selected",a===this.selectedIndex)})}async handleSearch(){let e=this.commandInput.value.trim();if(this.searchTimeout&&clearTimeout(this.searchTimeout),e.length<1){this.searchResults.classList.remove("active"),this.searchResultsData=[];return}this.searchTimeout=window.setTimeout(async()=>{this.setStatus("SEARCHING...");try{let a=await(await fetch(`/api/search?q=${encodeURIComponent(e)}`)).json();this.searchResultsData=a,this.selectedIndex=-1,this.renderSearchResults(a),this.setStatus("READY")}catch{this.setStatus("ERROR")}},150)}renderSearchResults(e){if(e.length===0){this.searchResults.innerHTML='<div class="search-item">No results found</div>',this.searchResults.classList.add("active");return}this.searchResults.innerHTML=e.map((t,a)=>`
            <div class="search-item" data-index="${a}">
                <span class="symbol">${t.symbol}</span>
                <span class="name">${t.name}</span>
            </div>
        `).join(""),this.searchResults.querySelectorAll(".search-item").forEach(t=>{t.addEventListener("click",()=>{let a=parseInt(t.dataset.index||"0",10);this.selectCompany(e[a])})}),this.searchResults.classList.add("active")}selectCompany(e){this.currentSymbol=e.symbol,this.commandInput.value=e.symbol,this.searchResults.classList.remove("active"),this.loadSecurityView(e)}async loadSecurityView(e){this.setStatus("LOADING..."),this.welcomeScreen.classList.add("hidden"),this.securityView.classList.remove("hidden"),await Promise.all([this.loadQuote(e.symbol),this.loadChartData(e.symbol,30),this.loadNews(e.symbol)]),this.renderDescription(e),this.setStatus("READY")}async loadQuote(e){try{let a=await(await fetch(`/api/quote/${e}`)).json();this.renderQuote(a)}catch{console.error("Failed to load quote")}}renderQuote(e){let t=document.getElementById("quote-symbol"),a=document.getElementById("quote-name"),i=document.getElementById("quote-exchange"),s=document.getElementById("quote-price"),r=document.getElementById("quote-change"),n=document.getElementById("quote-details");if(t&&(t.textContent=e.symbol),a&&(a.textContent=e.name),i&&(i.textContent=`\u2022 ${e.symbol.includes(".")?"LSE":"NASDAQ"}`),s&&(s.textContent=e.price.toFixed(2)),r){let l=e.change>=0?"+":"";r.textContent=`${l}${e.change.toFixed(2)} (${l}${e.change_percent.toFixed(2)}%)`,r.className=`change ${e.change>=0?"positive":"negative"}`}n&&(n.innerHTML=`
                <div class="quote-row"><span class="label">Open</span><span class="value">${e.open.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">High</span><span class="value">${e.high.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">Low</span><span class="value">${e.low.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">Volume</span><span class="value">${this.formatNumber(e.volume)}</span></div>
                <div class="quote-row"><span class="label">Mkt Cap</span><span class="value">${this.formatMarketCap(e.market_cap)}</span></div>
                <div class="quote-row"><span class="label">P/E</span><span class="value">${e.pe_ratio?.toFixed(2)||"N/A"}</span></div>
                <div class="quote-row"><span class="label">EPS</span><span class="value">${e.eps?.toFixed(2)||"N/A"}</span></div>
                <div class="quote-row"><span class="label">Div Yield</span><span class="value">${e.dividend_yield?e.dividend_yield.toFixed(2)+"%":"N/A"}</span></div>
                <div class="quote-row"><span class="label">52W High</span><span class="value">${e.week_52_high.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">52W Low</span><span class="value">${e.week_52_low.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">Avg Vol</span><span class="value">${this.formatNumber(e.avg_volume)}</span></div>
            `)}async loadChartData(e,t){try{let i=await(await fetch(`/api/chart/${e}?days=${t}`)).json();this.renderChart(i)}catch{console.error("Failed to load chart data")}}renderChart(e){let t=document.getElementById("chart-container");if(!t)return;this.chart&&this.chart.remove(),this.chart=LightweightCharts.createChart(t,{width:t.clientWidth,height:t.clientHeight,layout:{background:{color:"#111111"},textColor:"#888888"},grid:{vertLines:{color:"#222222"},horzLines:{color:"#222222"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"#333333"},timeScale:{borderColor:"#333333",timeVisible:!0}}),this.candleSeries=this.chart.addCandlestickSeries({upColor:"#00ff00",downColor:"#ff3333",borderUpColor:"#00ff00",borderDownColor:"#ff3333",wickUpColor:"#00ff00",wickDownColor:"#ff3333"});let a=e.points.map(s=>({time:s.timestamp,open:s.open,high:s.high,low:s.low,close:s.close}));this.candleSeries.setData(a),this.chart.timeScale().fitContent(),new ResizeObserver(()=>{this.chart&&t&&this.chart.applyOptions({width:t.clientWidth,height:t.clientHeight})}).observe(t)}async loadNews(e){try{let a=await(await fetch(`/api/news/${e}`)).json();this.renderNews(a)}catch{console.error("Failed to load news")}}renderNews(e){let t=document.getElementById("news-feed");t&&(this.newsData=e.items,t.innerHTML=e.items.map((a,i)=>`
            <div class="news-item">
                <div class="headline" data-news-index="${i}">${a.title}</div>
                <div class="meta">
                    <span>${a.source}</span>
                    <span>${this.formatTime(a.timestamp)}</span>
                    <span class="sentiment ${a.sentiment}">${a.sentiment.toUpperCase()}</span>
                </div>
            </div>
        `).join(""),t.querySelectorAll(".headline").forEach(a=>{a.addEventListener("click",()=>{let i=parseInt(a.dataset.newsIndex||"0",10);this.newsData[i]&&this.openNewsModal(this.newsData[i])})}))}renderDescription(e){let t=document.getElementById("company-description");t&&(t.innerHTML=`
                <p><strong>Sector:</strong> ${e.sector}</p>
                <p><strong>Industry:</strong> ${e.industry}</p>
                <p>${e.description}</p>
            `)}loadQuickTickers(){let e=["AAPL","MSFT","GOOGL","AMZN","NVDA","META","TSLA"];this.tickerList.innerHTML=e.map(t=>`<div class="ticker-item" data-symbol="${t}">${t}</div>`).join(""),this.tickerList.querySelectorAll(".ticker-item").forEach(t=>{t.addEventListener("click",async()=>{let a=t.dataset.symbol;if(a){this.commandInput.value=a;let s=await(await fetch(`/api/search?q=${a}`)).json();s.length>0&&this.selectCompany(s[0])}})})}updateTime(){let e=document.getElementById("current-time");if(e){let t=new Date;e.textContent=t.toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"})}}setStatus(e){this.statusText.textContent=e}formatNumber(e){return v(e)}formatMarketCap(e){return g(e)}formatTime(e){return f(e)}};document.addEventListener("DOMContentLoaded",()=>{new b});})();
