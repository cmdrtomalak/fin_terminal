"use strict";(()=>{function y(u){return u>=1e9?(u/1e9).toFixed(2)+"B":u>=1e6?(u/1e6).toFixed(2)+"M":u>=1e3?(u/1e3).toFixed(2)+"K":u.toString()}function g(u){return u>=1e12?"$"+(u/1e12).toFixed(2)+"T":u>=1e9?"$"+(u/1e9).toFixed(2)+"B":"$"+(u/1e6).toFixed(2)+"M"}function f(u){let e=new Date(u),s=new Date().getTime()-e.getTime(),i=Math.floor(s/(1e3*60*60));return i<1?"Just now":i<24?`${i}h ago`:e.toLocaleDateString()}function _(u){if(u==null||isNaN(u))return"\u2014";let e=Math.abs(u),t=u<0?"-":"";return e>=1e9?t+"$"+(e/1e9).toFixed(1)+"B":e>=1e6?t+"$"+(e/1e6).toFixed(1)+"M":e>=1e3?t+"$"+(e/1e3).toFixed(1)+"K":t+"$"+e.toFixed(0)}function E(u,e="number"){if(u==null||isNaN(u))return"N/A";switch(e){case"percent":return(u*100).toFixed(2)+"%";case"currency":return g(u);case"ratio":return u.toFixed(2);default:return y(u)}}function v(u){return u==null?"":u>=0?"positive":"negative"}var b=class{constructor(){this.treasuryChart=null;this.treasuryLineSeries=null;this.bondsChart=null;this.bondsLineSeries=null;this.currentTreasuryMaturity=null;this.currentTreasuryDays=365;this.currentBondCountry=null;this.currentBondCountryCode=null;this.currentBondYears=10;this.statementsData=null;this.currentTab="income";this.currentSymbol=null;this.chart=null;this.candleSeries=null;this.searchTimeout=null;this.selectedIndex=-1;this.searchResultsData=[];this.newsData=[];this.commandInput=document.getElementById("command-input"),this.searchResults=document.getElementById("search-results"),this.welcomeScreen=document.getElementById("welcome-screen"),this.securityView=document.getElementById("security-view"),this.tickerList=document.getElementById("ticker-list"),this.statusText=document.getElementById("status-text"),this.newsModal=document.getElementById("news-modal"),this.ratiosModal=document.getElementById("ratios-modal"),this.indexModal=document.getElementById("index-modal"),this.statementsModal=document.getElementById("statements-modal"),this.govtModal=document.getElementById("govt-modal"),this.treasuryChartModal=document.getElementById("treasury-chart-modal"),this.bondsModal=document.getElementById("bonds-modal"),this.bondsChartModal=document.getElementById("bonds-chart-modal"),this.commoditiesModal=document.getElementById("commodities-modal"),this.init()}init(){this.setupEventListeners(),this.setupModalListeners(),this.setupRatiosModal(),this.setupIndexModal(),this.setupStatementsModal(),this.setupGovtModal(),this.setupTreasuryChartModal(),this.setupBondsModal(),this.setupBondsChartModal(),this.setupCommoditiesModal(),this.updateTime(),this.loadQuickTickers(),setInterval(()=>this.updateTime(),1e3)}setupEventListeners(){this.commandInput.addEventListener("input",()=>this.handleSearch()),this.commandInput.addEventListener("keydown",e=>this.handleKeydown(e)),this.commandInput.addEventListener("focus",()=>{this.searchResultsData.length>0&&this.searchResults.classList.add("active")}),document.addEventListener("click",e=>{!this.commandInput.contains(e.target)&&!this.searchResults.contains(e.target)&&this.searchResults.classList.remove("active")}),document.querySelectorAll(".chart-btn").forEach(e=>{e.addEventListener("click",t=>{let s=t.target,i=parseInt(s.dataset.days||"90",10);document.querySelectorAll(".chart-btn").forEach(a=>a.classList.remove("active")),s.classList.add("active"),this.currentSymbol&&this.loadChartData(this.currentSymbol,i)})})}setupModalListeners(){let e=document.getElementById("modal-close"),t=this.newsModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.closeModal()),t?.addEventListener("click",()=>this.closeModal()),document.addEventListener("keydown",s=>{s.key==="Escape"&&!this.newsModal.classList.contains("hidden")&&this.closeModal()})}openNewsModal(e){let t=document.getElementById("modal-title"),s=document.getElementById("modal-source"),i=document.getElementById("modal-timestamp"),a=document.getElementById("modal-sentiment"),r=document.getElementById("modal-body"),n=document.getElementById("modal-link");if(t&&(t.textContent=e.title),s&&(s.textContent=e.source),i&&(i.textContent=this.formatTime(e.timestamp)),a&&(a.textContent=e.sentiment,a.className=`modal-sentiment ${e.sentiment}`),r){let d=e.content||e.summary;r.innerHTML=d.split(`

`).map(c=>`<p>${c}</p>`).join("")}n&&(n.href=e.url),this.newsModal.classList.remove("hidden")}closeModal(){this.newsModal.classList.add("hidden")}setupRatiosModal(){let e=document.getElementById("ratios-btn"),t=document.getElementById("ratios-modal-close"),s=this.ratiosModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.openRatiosModal()),t?.addEventListener("click",()=>this.closeRatiosModal()),s?.addEventListener("click",()=>this.closeRatiosModal()),document.addEventListener("keydown",i=>{i.key==="Escape"&&!this.ratiosModal.classList.contains("hidden")&&this.closeRatiosModal()})}async openRatiosModal(){if(!this.currentSymbol)return;let e=document.getElementById("ratios-loading"),t=document.getElementById("ratios-body"),s=document.getElementById("ratios-modal-title");s&&(s.textContent=`${this.currentSymbol} - Financial Ratios`),e&&(e.style.display="block"),t&&(t.innerHTML=""),this.ratiosModal.classList.remove("hidden");try{let i=await fetch(`/api/financials/${this.currentSymbol}`);if(!i.ok)throw new Error("Failed to fetch");let a=await i.json();this.renderRatios(a)}catch{t&&(t.innerHTML='<div class="ratios-loading">Failed to load financial data</div>')}finally{e&&(e.style.display="none")}}closeRatiosModal(){this.ratiosModal.classList.add("hidden")}renderRatios(e){let t=document.getElementById("ratios-body");if(!t)return;let s=(i,a="number")=>E(i,a);t.innerHTML=`
            <div class="ratios-section">
                <div class="ratios-section-title">VALUATION</div>
                <div class="ratio-row"><span class="ratio-label">P/E (TTM)</span><span class="ratio-value">${s(e.pe_ratio,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Forward P/E</span><span class="ratio-value">${s(e.forward_pe,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">PEG Ratio</span><span class="ratio-value">${s(e.peg_ratio,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Price/Book</span><span class="ratio-value">${s(e.price_to_book,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Price/Sales</span><span class="ratio-value">${s(e.price_to_sales,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EV/Revenue</span><span class="ratio-value">${s(e.ev_to_revenue,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EV/EBITDA</span><span class="ratio-value">${s(e.ev_to_ebitda,"ratio")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">PROFITABILITY</div>
                <div class="ratio-row"><span class="ratio-label">Profit Margin</span><span class="ratio-value ${v(e.profit_margin)}">${s(e.profit_margin,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Operating Margin</span><span class="ratio-value ${v(e.operating_margin)}">${s(e.operating_margin,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">ROA</span><span class="ratio-value ${v(e.return_on_assets)}">${s(e.return_on_assets,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">ROE</span><span class="ratio-value ${v(e.return_on_equity)}">${s(e.return_on_equity,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EPS (TTM)</span><span class="ratio-value">${s(e.eps,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EPS Forward</span><span class="ratio-value">${s(e.eps_forward,"ratio")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">GROWTH</div>
                <div class="ratio-row"><span class="ratio-label">Revenue Growth (QoQ)</span><span class="ratio-value ${v(e.quarterly_revenue_growth)}">${s(e.quarterly_revenue_growth,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Earnings Growth (QoQ)</span><span class="ratio-value ${v(e.quarterly_earnings_growth)}">${s(e.quarterly_earnings_growth,"percent")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">INCOME STATEMENT</div>
                <div class="ratio-row"><span class="ratio-label">Revenue</span><span class="ratio-value">${s(e.revenue,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Revenue/Share</span><span class="ratio-value">${s(e.revenue_per_share,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Gross Profit</span><span class="ratio-value">${s(e.gross_profit,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">EBITDA</span><span class="ratio-value">${s(e.ebitda,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Net Income</span><span class="ratio-value">${s(e.net_income,"currency")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">BALANCE SHEET</div>
                <div class="ratio-row"><span class="ratio-label">Total Cash</span><span class="ratio-value">${s(e.total_cash,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Total Debt</span><span class="ratio-value">${s(e.total_debt,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Debt/Equity</span><span class="ratio-value">${s(e.debt_to_equity,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Current Ratio</span><span class="ratio-value">${s(e.current_ratio,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Book Value</span><span class="ratio-value">${s(e.book_value,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Enterprise Value</span><span class="ratio-value">${s(e.enterprise_value,"currency")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">CASH FLOW</div>
                <div class="ratio-row"><span class="ratio-label">Operating Cash Flow</span><span class="ratio-value">${s(e.operating_cash_flow,"currency")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Free Cash Flow</span><span class="ratio-value">${s(e.free_cash_flow,"currency")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">STOCK INFO</div>
                <div class="ratio-row"><span class="ratio-label">Beta</span><span class="ratio-value">${s(e.beta,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Shares Outstanding</span><span class="ratio-value">${s(e.shares_outstanding,"number")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Float</span><span class="ratio-value">${s(e.float_shares,"number")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Insider Ownership</span><span class="ratio-value">${s(e.held_by_insiders,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Institutional Ownership</span><span class="ratio-value">${s(e.held_by_institutions,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Short Ratio</span><span class="ratio-value">${s(e.short_ratio,"ratio")}</span></div>
            </div>

            <div class="ratios-section">
                <div class="ratios-section-title">DIVIDENDS</div>
                <div class="ratio-row"><span class="ratio-label">Dividend Rate</span><span class="ratio-value">${s(e.dividend_rate,"ratio")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Dividend Yield</span><span class="ratio-value">${s(e.dividend_yield,"percent")}</span></div>
                <div class="ratio-row"><span class="ratio-label">Payout Ratio</span><span class="ratio-value">${s(e.payout_ratio,"percent")}</span></div>
            </div>
        `}setupIndexModal(){let e=document.querySelector('[data-fn="INDEX"]'),t=document.getElementById("index-modal-close"),s=this.indexModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.openIndexModal()),t?.addEventListener("click",()=>this.closeIndexModal()),s?.addEventListener("click",()=>this.closeIndexModal()),document.addEventListener("keydown",i=>{i.key==="Escape"&&!this.indexModal.classList.contains("hidden")&&this.closeIndexModal()})}async openIndexModal(){let e=document.getElementById("index-loading"),t=document.getElementById("index-body");e&&(e.style.display="block"),t&&(t.innerHTML=""),this.indexModal.classList.remove("hidden");try{let s=await fetch("/api/indices");if(!s.ok)throw new Error("Failed to fetch");let i=await s.json();this.renderIndices(i)}catch{t&&(t.innerHTML='<div class="ratios-loading">Failed to load indices</div>')}finally{e&&(e.style.display="none")}}closeIndexModal(){this.indexModal.classList.add("hidden")}renderIndices(e){let t=document.getElementById("index-body");if(!t)return;let i=(n=>{let d=new Map,c=["US","UK","Germany","France","Europe","Netherlands","Spain","Italy","Switzerland","Japan","Hong Kong","China","Australia","South Korea","Taiwan","India","Singapore","Brazil","Mexico","Canada"];for(let o of c){let h=n.filter(p=>p.region===o);h.length>0&&d.set(o,h)}return d})(e),a="",r={US:"UNITED STATES",UK:"UNITED KINGDOM",Germany:"GERMANY",France:"FRANCE",Europe:"EUROPE",Netherlands:"NETHERLANDS",Spain:"SPAIN",Italy:"ITALY",Switzerland:"SWITZERLAND",Japan:"JAPAN","Hong Kong":"HONG KONG",China:"CHINA",Australia:"AUSTRALIA","South Korea":"SOUTH KOREA",Taiwan:"TAIWAN",India:"INDIA",Singapore:"SINGAPORE",Brazil:"BRAZIL",Mexico:"MEXICO",Canada:"CANADA"};i.forEach((n,d)=>{a+=`<div class="index-section">
                <div class="index-section-title">${r[d]||d}</div>`;for(let c of n){let o=c.change>=0?"positive":"negative",h=c.change>=0?"+":"";a+=`
                <div class="index-row">
                    <div class="index-info">
                        <span class="index-symbol">${c.symbol}</span>
                        <span class="index-name">${c.name}</span>
                    </div>
                    <div class="index-data">
                        <span class="index-price">${c.price.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
                        <span class="index-change ${o}">${h}${c.change.toFixed(2)}</span>
                        <span class="index-percent ${o}">${h}${c.change_percent.toFixed(2)}%</span>
                    </div>
                </div>`}a+="</div>"}),t.innerHTML=a}setupStatementsModal(){let e=document.getElementById("statements-btn"),t=document.getElementById("statements-modal-close"),s=this.statementsModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.openStatementsModal()),t?.addEventListener("click",()=>this.closeStatementsModal()),s?.addEventListener("click",()=>this.closeStatementsModal()),this.statementsModal.querySelectorAll(".stmt-tab").forEach(i=>{i.addEventListener("click",a=>{let r=a.target,n=r.dataset.tab;this.currentTab=n,this.statementsModal.querySelectorAll(".stmt-tab").forEach(d=>d.classList.remove("active")),r.classList.add("active"),this.statementsData&&this.renderStatements(this.statementsData)})}),document.addEventListener("keydown",i=>{i.key==="Escape"&&!this.statementsModal.classList.contains("hidden")&&this.closeStatementsModal()})}setupGovtModal(){let e=document.querySelector('[data-fn="GOVT"]'),t=document.getElementById("govt-modal-close"),s=this.govtModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.openGovtModal()),t?.addEventListener("click",()=>this.closeGovtModal()),s?.addEventListener("click",()=>this.closeGovtModal()),document.addEventListener("keydown",i=>{i.key==="Escape"&&!this.govtModal.classList.contains("hidden")&&this.closeGovtModal()})}async openGovtModal(){let e=document.getElementById("govt-loading"),t=document.getElementById("govt-body"),s=document.getElementById("govt-date");e&&(e.style.display="block"),t&&(t.innerHTML=""),this.govtModal.classList.remove("hidden");try{let i=await fetch("/api/treasury");if(!i.ok)throw new Error("Failed to fetch");let a=await i.json();s&&(s.textContent=`As of ${a.date}`),this.renderTreasury(a)}catch{t&&(t.innerHTML='<div class="ratios-loading">Failed to load treasury rates</div>')}finally{e&&(e.style.display="none")}}closeGovtModal(){this.govtModal.classList.add("hidden")}renderTreasury(e){let t=document.getElementById("govt-body");if(!t)return;let s=e.rates.filter(c=>["1 Mo","1.5 Month","2 Mo","3 Mo","4 Mo","6 Mo"].includes(c.maturity)),i=e.rates.filter(c=>["1 Yr","2 Yr","3 Yr","5 Yr","7 Yr","10 Yr","20 Yr","30 Yr"].includes(c.maturity)),a=c=>{let o=c.change>=0?"positive":"negative",h=c.change>=0?"+":"";return`
                <div class="treasury-row">
                    <span class="treasury-maturity">${c.maturity}</span>
                    <span class="treasury-yield">${c.yield_rate.toFixed(2)}%</span>
                    <span class="treasury-change ${o}">${h}${c.change.toFixed(2)}</span>
                    <span class="treasury-pct ${o}">${h}${c.change_percent.toFixed(2)}%</span>
                </div>
            `},r="";s.length>0&&(r+=`
                <div class="treasury-section">
                    <div class="treasury-section-title">SHORT-TERM (BILLS)</div>
                    <div class="treasury-header">
                        <span>Maturity</span>
                        <span>Yield</span>
                        <span>Chg</span>
                        <span>Chg %</span>
                    </div>
                    ${s.map(a).join("")}
                </div>
            `),i.length>0&&(r+=`
                <div class="treasury-section">
                    <div class="treasury-section-title">LONG-TERM (NOTES & BONDS)</div>
                    <div class="treasury-header">
                        <span>Maturity</span>
                        <span>Yield</span>
                        <span>Chg</span>
                        <span>Chg %</span>
                    </div>
                    ${i.map(a).join("")}
                </div>
            `);let n=e.rates.find(c=>c.maturity==="10 Yr"),d=e.rates.find(c=>c.maturity==="2 Yr");if(n&&d){let c=n.yield_rate-d.yield_rate,o=c>=0?"positive":"negative";r+=`
                <div class="treasury-section">
                    <div class="treasury-section-title">YIELD CURVE</div>
                    <div class="treasury-row">
                        <span class="treasury-maturity">10Y-2Y Spread</span>
                        <span class="treasury-yield ${o}">${c>=0?"+":""}${(c*100).toFixed(0)} bps</span>
                        <span class="treasury-change"></span>
                        <span class="treasury-pct"></span>
                    </div>
                </div>
            `}r+=`<div class="treasury-updated">Last updated: ${new Date(e.updated_at).toLocaleString()}</div>`,t.innerHTML=r,t.querySelectorAll(".treasury-row").forEach(c=>{let o=c.querySelector(".treasury-maturity");if(o){let h=o.textContent;h&&!h.includes("Spread")&&(c.classList.add("clickable"),c.addEventListener("click",()=>this.openTreasuryChartModal(h)))}})}setupTreasuryChartModal(){let e=document.getElementById("treasury-chart-modal-close"),t=this.treasuryChartModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.closeTreasuryChartModal()),t?.addEventListener("click",()=>this.closeTreasuryChartModal()),document.addEventListener("keydown",s=>{s.key==="Escape"&&!this.treasuryChartModal.classList.contains("hidden")&&this.closeTreasuryChartModal()}),this.treasuryChartModal.querySelectorAll(".treasury-range-btn").forEach(s=>{s.addEventListener("click",i=>{let a=i.target,r=parseInt(a.dataset.days||"365",10);this.treasuryChartModal.querySelectorAll(".treasury-range-btn").forEach(n=>n.classList.remove("active")),a.classList.add("active"),this.currentTreasuryDays=r,this.currentTreasuryMaturity&&this.loadTreasuryHistory(this.currentTreasuryMaturity,r)})})}async openTreasuryChartModal(e){this.currentTreasuryMaturity=e,this.currentTreasuryDays=365;let t=document.getElementById("treasury-chart-title"),s=document.getElementById("treasury-chart-loading"),i=document.getElementById("treasury-chart-container");t&&(t.textContent=`${e} Treasury Yield History`),s&&(s.style.display="block"),i&&(i.innerHTML=""),this.treasuryChartModal.querySelectorAll(".treasury-range-btn").forEach(a=>{a.classList.toggle("active",a.getAttribute("data-days")==="365")}),this.treasuryChartModal.classList.remove("hidden"),await this.loadTreasuryHistory(e,365)}closeTreasuryChartModal(){this.treasuryChartModal.classList.add("hidden"),this.treasuryChart&&(this.treasuryChart.remove(),this.treasuryChart=null,this.treasuryLineSeries=null),this.currentTreasuryMaturity=null}async loadTreasuryHistory(e,t){let s=document.getElementById("treasury-chart-loading"),i=document.getElementById("treasury-chart-container");s&&(s.style.display="block");try{let a=encodeURIComponent(e),r=await fetch(`/api/treasury/history/${a}?days=${t}`);if(!r.ok)throw new Error("Failed to fetch treasury history");let n=await r.json();this.renderTreasuryChart(n)}catch{i&&(i.innerHTML='<div class="ratios-loading">Failed to load treasury history</div>')}finally{s&&(s.style.display="none")}}renderTreasuryChart(e){let t=document.getElementById("treasury-chart-container");if(!t)return;if(this.treasuryChart&&(this.treasuryChart.remove(),this.treasuryChart=null,this.treasuryLineSeries=null),t.innerHTML="",e.points.length===0){t.innerHTML='<div class="ratios-loading">No historical data available</div>';return}this.treasuryChart=LightweightCharts.createChart(t,{width:t.clientWidth,height:400,layout:{background:{color:"#1a1a1a"},textColor:"#ff9900"},grid:{vertLines:{color:"rgba(255, 153, 0, 0.1)"},horzLines:{color:"rgba(255, 153, 0, 0.1)"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"rgba(255, 153, 0, 0.3)"},timeScale:{borderColor:"rgba(255, 153, 0, 0.3)",timeVisible:!0,secondsVisible:!1}}),this.treasuryLineSeries=this.treasuryChart.addLineSeries({color:"#ff9900",lineWidth:2,crosshairMarkerVisible:!0,crosshairMarkerRadius:4,priceFormat:{type:"price",precision:2,minMove:.01}});let s=e.points.map(a=>({time:a.date,value:a.yield_rate}));this.treasuryLineSeries.setData(s),this.treasuryChart.timeScale().fitContent(),new ResizeObserver(()=>{this.treasuryChart&&t&&this.treasuryChart.applyOptions({width:t.clientWidth})}).observe(t)}setupBondsModal(){let e=document.querySelector('[data-fn="INTL"]'),t=document.getElementById("bonds-modal-close"),s=this.bondsModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.openBondsModal()),t?.addEventListener("click",()=>this.closeBondsModal()),s?.addEventListener("click",()=>this.closeBondsModal()),document.addEventListener("keydown",i=>{i.key==="Escape"&&!this.bondsModal.classList.contains("hidden")&&this.closeBondsModal()})}async openBondsModal(){let e=document.getElementById("bonds-loading"),t=document.getElementById("bonds-body"),s=document.getElementById("bonds-date");e&&(e.style.display="block"),t&&(t.innerHTML=""),this.bondsModal.classList.remove("hidden");try{let i=await fetch("/api/bonds");if(!i.ok)throw new Error("Failed to fetch");let a=await i.json();s&&(s.textContent=`Updated: ${new Date(a.updated_at).toLocaleString()}`),this.renderBonds(a)}catch{t&&(t.innerHTML='<div class="ratios-loading">Failed to load bond yields</div>')}finally{e&&(e.style.display="none")}}closeBondsModal(){this.bondsModal.classList.add("hidden")}renderBonds(e){let t=document.getElementById("bonds-body");if(!t)return;let s=["CN"],i=r=>{let n=r.change>=0?"positive":"negative",d=r.change>=0?"+":"",c=r.data_frequency==="daily"?"freq-daily":"freq-monthly",o=!s.includes(r.country_code),h=o?"clickable":"",p=o?"":'title="Historical chart not available"';return`
                <div class="bonds-row ${h}" data-country="${r.country}" data-country-code="${r.country_code}" ${p}>
                    <div class="bonds-info">
                        <span class="bonds-country">${r.country}<span class="bonds-freq ${c}" title="${r.data_frequency} data"></span></span>
                        <span class="bonds-code">${r.country_code}</span>
                    </div>
                    <div class="bonds-data">
                        <span class="bonds-yield">${r.yield_10y.toFixed(2)}%</span>
                        <span class="bonds-change ${n}">${d}${r.change.toFixed(2)}</span>
                        <span class="bonds-pct ${n}">${d}${r.change_percent.toFixed(2)}%</span>
                    </div>
                </div>
            `},a=`
            <div class="bonds-section">
                <div class="bonds-header">
                    <span>Country</span>
                    <span>10Y Yield</span>
                    <span>Chg</span>
                    <span>Chg %</span>
                </div>
                ${e.bonds.map(i).join("")}
            </div>
            <div class="bonds-legend">
                <span class="bonds-freq freq-daily"></span> Daily
                <span class="bonds-freq freq-monthly" style="margin-left: 8px;"></span> Monthly
            </div>
        `;t.innerHTML=a,t.querySelectorAll(".bonds-row.clickable").forEach(r=>{r.addEventListener("click",()=>{let n=r.dataset.country,d=r.dataset.countryCode;n&&d&&this.openBondsChartModal(n,d)})})}setupBondsChartModal(){let e=document.getElementById("bonds-chart-modal-close"),t=this.bondsChartModal.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.closeBondsChartModal()),t?.addEventListener("click",()=>this.closeBondsChartModal()),document.addEventListener("keydown",s=>{s.key==="Escape"&&!this.bondsChartModal.classList.contains("hidden")&&this.closeBondsChartModal()}),this.bondsChartModal.querySelectorAll(".bonds-range-btn").forEach(s=>{s.addEventListener("click",i=>{let a=i.target,r=parseInt(a.dataset.years||"10",10);this.bondsChartModal.querySelectorAll(".bonds-range-btn").forEach(n=>n.classList.remove("active")),a.classList.add("active"),this.currentBondYears=r,this.currentBondCountryCode&&this.loadBondHistory(this.currentBondCountryCode,r)})})}async openBondsChartModal(e,t){this.currentBondCountry=e,this.currentBondCountryCode=t,this.currentBondYears=10;let s=document.getElementById("bonds-chart-title"),i=document.getElementById("bonds-chart-loading"),a=document.getElementById("bonds-chart-container");s&&(s.textContent=`${e} 10 Year Bond Yield History`),i&&(i.style.display="block"),a&&(a.innerHTML=""),this.bondsChartModal.querySelectorAll(".bonds-range-btn").forEach(r=>{r.classList.toggle("active",r.getAttribute("data-years")==="10")}),this.bondsChartModal.classList.remove("hidden"),await this.loadBondHistory(t,10)}closeBondsChartModal(){this.bondsChartModal.classList.add("hidden"),this.bondsChart&&(this.bondsChart.remove(),this.bondsChart=null,this.bondsLineSeries=null),this.currentBondCountry=null,this.currentBondCountryCode=null}async loadBondHistory(e,t){let s=document.getElementById("bonds-chart-loading"),i=document.getElementById("bonds-chart-container"),a=document.getElementById("bonds-chart-notice");s&&(s.style.display="block");try{let r=await fetch(`/api/bonds/history/${e}?years=${t}`);if(!r.ok)throw new Error("Failed to fetch bond history");let n=await r.json();a&&(a.textContent=n.data_delay),this.renderBondsChart(n)}catch{i&&(i.innerHTML='<div class="ratios-loading">Failed to load bond history</div>')}finally{s&&(s.style.display="none")}}renderBondsChart(e){let t=document.getElementById("bonds-chart-container");if(!t)return;if(this.bondsChart&&(this.bondsChart.remove(),this.bondsChart=null,this.bondsLineSeries=null),t.innerHTML="",e.points.length===0){t.innerHTML='<div class="ratios-loading">No historical data available</div>';return}this.bondsChart=LightweightCharts.createChart(t,{width:t.clientWidth,height:400,layout:{background:{color:"#1a1a1a"},textColor:"#ff9900"},grid:{vertLines:{color:"rgba(255, 153, 0, 0.1)"},horzLines:{color:"rgba(255, 153, 0, 0.1)"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"rgba(255, 153, 0, 0.3)"},timeScale:{borderColor:"rgba(255, 153, 0, 0.3)",timeVisible:!0,secondsVisible:!1}}),this.bondsLineSeries=this.bondsChart.addLineSeries({color:"#ff9900",lineWidth:2,crosshairMarkerVisible:!0,crosshairMarkerRadius:4,priceFormat:{type:"price",precision:2,minMove:.01}});let s=e.points.map(a=>({time:a.date,value:a.yield_rate}));this.bondsLineSeries.setData(s),this.bondsChart.timeScale().fitContent(),new ResizeObserver(()=>{this.bondsChart&&t&&this.bondsChart.applyOptions({width:t.clientWidth})}).observe(t)}setupCommoditiesModal(){let e=document.querySelector('[data-fn="CMDTY"]'),t=document.getElementById("commodities-modal-close"),s=this.commoditiesModal?.querySelector(".modal-overlay");e?.addEventListener("click",()=>this.openCommoditiesModal()),t?.addEventListener("click",()=>this.closeCommoditiesModal()),s?.addEventListener("click",()=>this.closeCommoditiesModal()),document.addEventListener("keydown",i=>{i.key==="Escape"&&!this.commoditiesModal?.classList.contains("hidden")&&this.closeCommoditiesModal()})}async openCommoditiesModal(){let e=document.getElementById("commodities-loading"),t=document.getElementById("commodities-body");e&&(e.style.display="block"),t&&(t.innerHTML=""),this.commoditiesModal.classList.remove("hidden");try{let s=await fetch("/api/commodities");if(!s.ok)throw new Error("Failed to fetch");let i=await s.json();this.renderCommodities(i)}catch{t&&(t.innerHTML='<div class="ratios-loading">Failed to load commodities</div>')}finally{e&&(e.style.display="none")}}closeCommoditiesModal(){this.commoditiesModal.classList.add("hidden")}renderCommodities(e){let t=document.getElementById("commodities-body");if(!t)return;let s=[...new Set(e.commodities.map(r=>r.category))],i=r=>{let n=r.change>=0?"positive":"negative",d=r.change>=0?"+":"";return`
                <div class="commodity-row">
                    <div class="commodity-info">
                        <span class="commodity-name">${r.name}</span>
                        <span class="commodity-unit">${r.unit}</span>
                    </div>
                    <div class="commodity-data">
                        <span class="commodity-price">${r.price.toFixed(2)}</span>
                        <span class="commodity-change ${n}">${d}${r.change.toFixed(2)}</span>
                        <span class="commodity-pct ${n}">${d}${r.change_percent.toFixed(2)}%</span>
                    </div>
                </div>
            `},a="";for(let r of s){let n=e.commodities.filter(d=>d.category===r);a+=`
                <div class="commodity-section">
                    <div class="commodity-category">${r}</div>
                    ${n.map(i).join("")}
                </div>
            `}t.innerHTML=a}async openStatementsModal(){if(!this.currentSymbol)return;let e=document.getElementById("statements-loading"),t=document.getElementById("statements-body"),s=document.getElementById("statements-modal-title");s&&(s.textContent=`${this.currentSymbol} - Financial Statements`),e&&(e.style.display="block"),t&&(t.innerHTML=""),this.statementsModal.classList.remove("hidden");try{let i=await fetch(`/api/statements/${this.currentSymbol}`);if(!i.ok)throw new Error("Failed to fetch");this.statementsData=await i.json(),this.renderStatements(this.statementsData)}catch{t&&(t.innerHTML='<div class="ratios-loading">Failed to load financial statements</div>')}finally{e&&(e.style.display="none")}}closeStatementsModal(){this.statementsModal.classList.add("hidden")}renderStatements(e){let t=document.getElementById("statements-body");if(!t)return;let s=n=>_(n),i=n=>n.some(d=>d!=null&&d!==0),a=(n,d,c=!1)=>i(d)?`<tr${c?' class="stmt-highlight"':""}><td>${n}</td>${d.map(h=>`<td class="${v(h)}">${s(h)}</td>`).join("")}</tr>`:"",r="";if(this.currentTab==="income"){let n=e.income_statements;if(n.length===0)r='<div class="ratios-loading">No income statement data available</div>';else{let d=n.map(o=>o.fiscal_year.split("-")[0]||o.fiscal_year),c=[a("Total Revenue",n.map(o=>o.total_revenue),!0),a("Cost of Revenue",n.map(o=>o.cost_of_revenue)),a("Gross Profit",n.map(o=>o.gross_profit),!0),a("R&D Expenses",n.map(o=>o.research_development)),a("SG&A Expenses",n.map(o=>o.selling_general_admin)),a("Total Operating Expenses",n.map(o=>o.total_operating_expenses)),a("Operating Income",n.map(o=>o.operating_income),!0),a("Interest Expense",n.map(o=>o.interest_expense)),a("Income Before Tax",n.map(o=>o.income_before_tax)),a("Income Tax Expense",n.map(o=>o.income_tax_expense)),a("Net Income",n.map(o=>o.net_income),!0),a("EBIT",n.map(o=>o.ebit)),a("EBITDA",n.map(o=>o.ebitda))].filter(o=>o).join("");r=`
                    <table class="statements-table">
                        <thead>
                            <tr>
                                <th class="stmt-label-col">Item</th>
                                ${d.map(o=>`<th class="stmt-value-col">${o}</th>`).join("")}
                            </tr>
                        </thead>
                        <tbody>${c}</tbody>
                    </table>
                `}}else if(this.currentTab==="balance"){let n=e.balance_sheets;if(n.length===0)r='<div class="ratios-loading">No balance sheet data available</div>';else{let d=n.map(l=>l.fiscal_year.split("-")[0]||l.fiscal_year),c=[a("Cash & Equivalents",n.map(l=>l.cash_and_equivalents)),a("Short-term Investments",n.map(l=>l.short_term_investments)),a("Accounts Receivable",n.map(l=>l.accounts_receivable)),a("Inventory",n.map(l=>l.inventory)),a("Total Current Assets",n.map(l=>l.total_current_assets),!0),a("Property, Plant & Equipment",n.map(l=>l.property_plant_equipment)),a("Goodwill",n.map(l=>l.goodwill)),a("Intangible Assets",n.map(l=>l.intangible_assets)),a("Total Assets",n.map(l=>l.total_assets),!0)].filter(l=>l).join(""),o=[a("Accounts Payable",n.map(l=>l.accounts_payable)),a("Short-term Debt",n.map(l=>l.short_term_debt)),a("Total Current Liabilities",n.map(l=>l.total_current_liabilities),!0),a("Long-term Debt",n.map(l=>l.long_term_debt)),a("Total Liabilities",n.map(l=>l.total_liabilities),!0)].filter(l=>l).join(""),h=[a("Common Stock",n.map(l=>l.common_stock)),a("Retained Earnings",n.map(l=>l.retained_earnings)),a("Total Stockholders Equity",n.map(l=>l.total_stockholders_equity),!0)].filter(l=>l).join(""),p="";c&&(p+=`<tr class="stmt-section-header"><td colspan="${d.length+1}">ASSETS</td></tr>${c}`),o&&(p+=`<tr class="stmt-section-header"><td colspan="${d.length+1}">LIABILITIES</td></tr>${o}`),h&&(p+=`<tr class="stmt-section-header"><td colspan="${d.length+1}">EQUITY</td></tr>${h}`),p?r=`
                        <table class="statements-table">
                            <thead>
                                <tr>
                                    <th class="stmt-label-col">Item</th>
                                    ${d.map(l=>`<th class="stmt-value-col">${l}</th>`).join("")}
                                </tr>
                            </thead>
                            <tbody>${p}</tbody>
                        </table>
                    `:r='<div class="ratios-loading">No balance sheet data available</div>'}}else if(this.currentTab==="cashflow"){let n=e.cash_flows;if(n.length===0)r='<div class="ratios-loading">No cash flow data available</div>';else{let d=n.map(m=>m.fiscal_year.split("-")[0]||m.fiscal_year),c=[a("Net Income",n.map(m=>m.net_income)),a("Depreciation",n.map(m=>m.depreciation)),a("Change in Working Capital",n.map(m=>m.change_in_working_capital)),a("Operating Cash Flow",n.map(m=>m.operating_cash_flow),!0)].filter(m=>m).join(""),o=[a("Capital Expenditures",n.map(m=>m.capital_expenditures)),a("Investments",n.map(m=>m.investments)),a("Investing Cash Flow",n.map(m=>m.investing_cash_flow),!0)].filter(m=>m).join(""),h=[a("Dividends Paid",n.map(m=>m.dividends_paid)),a("Stock Repurchases",n.map(m=>m.stock_repurchases)),a("Debt Repayment",n.map(m=>m.debt_repayment)),a("Financing Cash Flow",n.map(m=>m.financing_cash_flow),!0)].filter(m=>m).join(""),p=a("Free Cash Flow",n.map(m=>m.free_cash_flow),!0),l="";c&&(l+=`<tr class="stmt-section-header"><td colspan="${d.length+1}">OPERATING ACTIVITIES</td></tr>${c}`),o&&(l+=`<tr class="stmt-section-header"><td colspan="${d.length+1}">INVESTING ACTIVITIES</td></tr>${o}`),h&&(l+=`<tr class="stmt-section-header"><td colspan="${d.length+1}">FINANCING ACTIVITIES</td></tr>${h}`),p&&(l+=`<tr class="stmt-section-header"><td colspan="${d.length+1}">FREE CASH FLOW</td></tr>${p}`),l?r=`
                        <table class="statements-table">
                            <thead>
                                <tr>
                                    <th class="stmt-label-col">Item</th>
                                    ${d.map(m=>`<th class="stmt-value-col">${m}</th>`).join("")}
                                </tr>
                            </thead>
                            <tbody>${l}</tbody>
                        </table>
                    `:r='<div class="ratios-loading">No cash flow data available</div>'}}t.innerHTML=r}handleKeydown(e){let t=this.searchResults.querySelectorAll(".search-item");e.key==="ArrowDown"?(e.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,t.length-1),this.updateSelectedItem(t)):e.key==="ArrowUp"?(e.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,-1),this.updateSelectedItem(t)):e.key==="Enter"?(e.preventDefault(),this.selectedIndex>=0&&this.searchResultsData[this.selectedIndex]?this.selectCompany(this.searchResultsData[this.selectedIndex]):this.searchResultsData.length>0&&this.selectCompany(this.searchResultsData[0])):e.key==="Escape"&&(this.searchResults.classList.remove("active"),this.selectedIndex=-1)}updateSelectedItem(e){e.forEach((t,s)=>{t.classList.toggle("selected",s===this.selectedIndex)})}async handleSearch(){let e=this.commandInput.value.trim();if(this.searchTimeout&&clearTimeout(this.searchTimeout),e.length<1){this.searchResults.classList.remove("active"),this.searchResultsData=[];return}this.searchTimeout=window.setTimeout(async()=>{this.setStatus("SEARCHING...");try{let s=await(await fetch(`/api/search?q=${encodeURIComponent(e)}`)).json();this.searchResultsData=s,this.selectedIndex=-1,this.renderSearchResults(s),this.setStatus("READY")}catch{this.setStatus("ERROR")}},150)}renderSearchResults(e){if(e.length===0){this.searchResults.innerHTML='<div class="search-item">No results found</div>',this.searchResults.classList.add("active");return}this.searchResults.innerHTML=e.map((t,s)=>`
            <div class="search-item" data-index="${s}">
                <span class="symbol">${t.symbol}</span>
                <span class="name">${t.name}</span>
            </div>
        `).join(""),this.searchResults.querySelectorAll(".search-item").forEach(t=>{t.addEventListener("click",()=>{let s=parseInt(t.dataset.index||"0",10);this.selectCompany(e[s])})}),this.searchResults.classList.add("active")}selectCompany(e){this.currentSymbol=e.symbol,this.commandInput.value=e.symbol,this.searchResults.classList.remove("active"),this.loadSecurityView(e)}async loadSecurityView(e){this.setStatus("LOADING..."),this.welcomeScreen.classList.add("hidden"),this.securityView.classList.remove("hidden"),await Promise.all([this.loadQuote(e.symbol),this.loadChartData(e.symbol,30),this.loadNews(e.symbol)]),this.renderDescription(e),this.setStatus("READY")}async loadQuote(e){try{let s=await(await fetch(`/api/quote/${e}`)).json();this.renderQuote(s)}catch{console.error("Failed to load quote")}}renderQuote(e){let t=document.getElementById("quote-symbol"),s=document.getElementById("quote-name"),i=document.getElementById("quote-exchange"),a=document.getElementById("quote-price"),r=document.getElementById("quote-change"),n=document.getElementById("quote-details");if(t&&(t.textContent=e.symbol),s&&(s.textContent=e.name),i&&(i.textContent=`\u2022 ${e.symbol.includes(".")?"LSE":"NASDAQ"}`),a&&(a.textContent=e.price.toFixed(2)),r){let d=e.change>=0?"+":"";r.textContent=`${d}${e.change.toFixed(2)} (${d}${e.change_percent.toFixed(2)}%)`,r.className=`change ${e.change>=0?"positive":"negative"}`}n&&(n.innerHTML=`
                <div class="quote-row"><span class="label">Open</span><span class="value">${e.open.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">High</span><span class="value">${e.high.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">Low</span><span class="value">${e.low.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">Volume</span><span class="value">${this.formatNumber(e.volume)}</span></div>
                <div class="quote-row"><span class="label">Mkt Cap</span><span class="value">${this.formatMarketCap(e.market_cap)}</span></div>
                <div class="quote-row"><span class="label">P/E</span><span class="value">${e.pe_ratio?.toFixed(2)||"N/A"}</span></div>
                <div class="quote-row"><span class="label">EPS</span><span class="value">${e.eps?.toFixed(2)||"N/A"}</span></div>
                <div class="quote-row"><span class="label">Div Yield</span><span class="value">${e.dividend_yield?e.dividend_yield.toFixed(2)+"%":"N/A"}</span></div>
                <div class="quote-row"><span class="label">52W High</span><span class="value">${e.week_52_high.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">52W Low</span><span class="value">${e.week_52_low.toFixed(2)}</span></div>
                <div class="quote-row"><span class="label">Avg Vol</span><span class="value">${this.formatNumber(e.avg_volume)}</span></div>
            `)}async loadChartData(e,t){try{let i=await(await fetch(`/api/chart/${e}?days=${t}`)).json();this.renderChart(i)}catch{console.error("Failed to load chart data")}}renderChart(e){let t=document.getElementById("chart-container");if(!t)return;this.chart&&this.chart.remove(),this.chart=LightweightCharts.createChart(t,{width:t.clientWidth,height:t.clientHeight,layout:{background:{color:"#111111"},textColor:"#888888"},grid:{vertLines:{color:"#222222"},horzLines:{color:"#222222"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"#333333"},timeScale:{borderColor:"#333333",timeVisible:!0}}),this.candleSeries=this.chart.addCandlestickSeries({upColor:"#00ff00",downColor:"#ff3333",borderUpColor:"#00ff00",borderDownColor:"#ff3333",wickUpColor:"#00ff00",wickDownColor:"#ff3333"});let s=e.points.map(a=>({time:a.timestamp,open:a.open,high:a.high,low:a.low,close:a.close}));this.candleSeries.setData(s),this.chart.timeScale().fitContent(),new ResizeObserver(()=>{this.chart&&t&&this.chart.applyOptions({width:t.clientWidth,height:t.clientHeight})}).observe(t)}async loadNews(e){try{let s=await(await fetch(`/api/news/${e}`)).json();this.renderNews(s)}catch{console.error("Failed to load news")}}renderNews(e){let t=document.getElementById("news-feed");t&&(this.newsData=e.items,t.innerHTML=e.items.map((s,i)=>`
            <div class="news-item">
                <div class="headline" data-news-index="${i}">${s.title}</div>
                <div class="meta">
                    <span>${s.source}</span>
                    <span>${this.formatTime(s.timestamp)}</span>
                    <span class="sentiment ${s.sentiment}">${s.sentiment.toUpperCase()}</span>
                </div>
            </div>
        `).join(""),t.querySelectorAll(".headline").forEach(s=>{s.addEventListener("click",()=>{let i=parseInt(s.dataset.newsIndex||"0",10);this.newsData[i]&&this.openNewsModal(this.newsData[i])})}))}renderDescription(e){let t=document.getElementById("company-description");t&&(t.innerHTML=`
                <p><strong>Sector:</strong> ${e.sector}</p>
                <p><strong>Industry:</strong> ${e.industry}</p>
                <p>${e.description}</p>
            `)}loadQuickTickers(){let e=["AAPL","MSFT","GOOGL","AMZN","NVDA","META","TSLA"];this.tickerList.innerHTML=e.map(t=>`<div class="ticker-item" data-symbol="${t}">${t}</div>`).join(""),this.tickerList.querySelectorAll(".ticker-item").forEach(t=>{t.addEventListener("click",async()=>{let s=t.dataset.symbol;if(s){this.commandInput.value=s;let a=await(await fetch(`/api/search?q=${s}`)).json();a.length>0&&this.selectCompany(a[0])}})})}updateTime(){let e=document.getElementById("current-time");if(e){let t=new Date;e.textContent=t.toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"})}}setStatus(e){this.statusText.textContent=e}formatNumber(e){return y(e)}formatMarketCap(e){return g(e)}formatTime(e){return f(e)}};document.addEventListener("DOMContentLoaded",()=>{new b});})();
