# Fin Terminal - UI Design Document

Technical documentation for the frontend architecture, component structure, and modification guidelines.

## File Structure

```
frontend/
├── index.html      # DOM structure, element IDs, modal templates
├── styles.css      # All CSS, theming, responsive breakpoints
├── app.ts          # TypeScript source (FinTerminal class)
└── app.js          # Compiled bundle (generated by esbuild)
```

**Build Command**: `bun run build` (compiles `app.ts` → `app.js`)

---

## Architecture Overview

### Single-Class Design

The entire UI is managed by one class: `FinTerminal` (~1100 lines)

```typescript
class FinTerminal {
    // DOM References (cached in constructor)
    private commandInput: HTMLInputElement;
    private searchResults: HTMLElement;
    private welcomeScreen: HTMLElement;
    private securityView: HTMLElement;
    // ... more elements
    
    // State
    private currentSymbol: string | null;
    private chart: LightweightCharts.IChartApi | null;
    private statementsData: FinancialStatements | null;
    private currentTab: 'income' | 'balance' | 'cashflow';
    private searchResultsData: Company[];
    private newsData: NewsItem[];
    
    constructor() {
        // Cache all DOM references
        // Call init()
    }
    
    private init(): void {
        this.setupEventListeners();
        this.setupModalListeners();
        this.setupRatiosModal();
        this.setupIndexModal();
        this.setupStatementsModal();
        this.updateTime();
        this.loadQuickTickers();
        setInterval(() => this.updateTime(), 1000);
    }
}

// Bootstrap on DOM ready
document.addEventListener('DOMContentLoaded', () => {
    new FinTerminal();
});
```

### Why Single Class?

1. **Simplicity** - No framework overhead, easy to understand
2. **Shared state** - `currentSymbol`, chart instance shared across features
3. **DOM caching** - All element references cached once in constructor
4. **Bundle size** - Minified output is ~28KB

---

## Component Breakdown

### 1. Header / Command Bar

**Location**: `index.html` lines 12-21, `styles.css` lines 38-78

```html
<header class="terminal-header">
    <div class="logo">FIN TERMINAL</div>
    <div class="command-bar">
        <input type="text" id="command-input" placeholder="Enter ticker symbol...">
        <div id="search-results" class="search-dropdown"></div>
    </div>
    <div class="header-info">
        <span id="current-time"></span>
    </div>
</header>
```

**Logic** (`app.ts`):
- `handleSearch()` - Debounced search (150ms) on input
- `handleKeydown()` - Arrow keys for navigation, Enter to select, Escape to close
- `renderSearchResults()` - Populates dropdown with company results

**To Modify**:
- Change search debounce: Edit `150` in `handleSearch()` setTimeout
- Add keyboard shortcuts: Extend `handleKeydown()` switch cases
- Change placeholder text: Edit `index.html` input placeholder

---

### 2. Sidebar (Function Keys)

**Location**: `index.html` lines 24-35, `styles.css` lines 140-205

```html
<aside class="sidebar">
    <div class="function-keys">
        <button class="fn-key yellow" data-fn="EQUITY">EQUITY</button>
        <button class="fn-key yellow" data-fn="INDEX">INDEX</button>
        <button class="fn-key yellow" data-fn="CMDTY">CMDTY</button>
        <button class="fn-key yellow" data-fn="GOVT">GOVT</button>
    </div>
    <div class="quick-tickers">
        <div class="section-title">QUICK ACCESS</div>
        <div id="ticker-list"></div>
    </div>
</aside>
```

**Logic**:
- `setupIndexModal()` - Binds INDEX button to world indices modal
- `loadQuickTickers()` - Populates ticker-list with default symbols

**To Add New Function Key**:
1. Add button in `index.html` with `data-fn="NAME"`
2. Add modal HTML template (see Modal Pattern below)
3. Add `setup[Name]Modal()` method in `app.ts`
4. Call setup method in `init()`

---

### 3. Welcome Screen

**Location**: `index.html` lines 38-49, `styles.css` lines 220-255

Shown when no stock is selected. Hidden class toggled when user selects a company.

```typescript
// In loadSecurityView()
this.welcomeScreen.classList.add('hidden');
this.securityView.classList.remove('hidden');
```

---

### 4. Security View (Main Content)

**Location**: `index.html` lines 51-102, `styles.css` lines 256-456

CSS Grid layout with 4 panels:

```css
.panel-grid {
    display: grid;
    grid-template-columns: 1fr 2fr;
    grid-template-rows: auto 1fr;
    gap: 10px;
}
```

| Panel | Grid Position | Content |
|-------|---------------|---------|
| Quote Panel | Row 1, Col 1 | Price, change, volume, ratios |
| Chart Panel | Row 1-2, Col 2 | Candlestick chart (spans 2 rows) |
| News Panel | Row 2, Col 1 | News headlines with sentiment |
| Desc Panel | Hidden | Company description (unused) |

**Responsive**: At `≤1200px`, switches to single column layout (`styles.css` line 497)

---

### 5. Chart Component

**Library**: [TradingView Lightweight Charts](https://tradingview.github.io/lightweight-charts/)

**CDN**: Loaded in `index.html` line 7
```html
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.min.js"></script>
```

**Logic** (`app.ts` lines 957-1017):

```typescript
private renderChart(data: ChartData): void {
    // Destroy existing chart
    if (this.chart) {
        this.chart.remove();
    }
    
    // Create new chart
    this.chart = LightweightCharts.createChart(container, {
        layout: {
            background: { color: '#111111' },
            textColor: '#888888',
        },
        // ... options
    });
    
    // Add candlestick series
    this.candleSeries = this.chart.addCandlestickSeries({
        upColor: '#00ff00',      // Green for up days
        downColor: '#ff3333',    // Red for down days
        // ...
    });
    
    // Set data and fit
    this.candleSeries.setData(chartData);
    this.chart.timeScale().fitContent();
    
    // Handle resize
    const resizeObserver = new ResizeObserver(() => {
        this.chart.applyOptions({
            width: container.clientWidth,
            height: container.clientHeight,
        });
    });
    resizeObserver.observe(container);
}
```

**Time Range Buttons**:
- Defined in `index.html` lines 74-82
- Handler in `setupEventListeners()` line 238
- Calls `loadChartData(symbol, days)` with `data-days` attribute value

**To Add Chart Indicator**:
1. Use `this.chart.addLineSeries()` or other series type
2. Calculate indicator values from OHLCV data
3. Call `series.setData(indicatorData)`

---

### 6. Modal System

**Pattern**: All modals follow same structure:

```html
<div id="[name]-modal" class="modal hidden">
    <div class="modal-overlay"></div>          <!-- Click to close -->
    <div class="modal-content [name]-modal-content">
        <div class="modal-header">
            <span id="[name]-modal-title" class="modal-source">Title</span>
            <button id="[name]-modal-close" class="modal-close">&times;</button>
        </div>
        <div id="[name]-loading" class="ratios-loading">Loading...</div>
        <div id="[name]-body" class="[name]-body"></div>
    </div>
</div>
```

**Setup Pattern** (`app.ts`):

```typescript
private setup[Name]Modal(): void {
    const triggerBtn = document.getElementById('[name]-btn');
    const closeBtn = document.getElementById('[name]-modal-close');
    const overlay = this.[name]Modal.querySelector('.modal-overlay');

    triggerBtn?.addEventListener('click', () => this.open[Name]Modal());
    closeBtn?.addEventListener('click', () => this.close[Name]Modal());
    overlay?.addEventListener('click', () => this.close[Name]Modal());

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !this.[name]Modal.classList.contains('hidden')) {
            this.close[Name]Modal();
        }
    });
}

private async open[Name]Modal(): Promise<void> {
    const loadingEl = document.getElementById('[name]-loading');
    const bodyEl = document.getElementById('[name]-body');

    loadingEl.style.display = 'block';
    bodyEl.innerHTML = '';
    this.[name]Modal.classList.remove('hidden');

    try {
        const response = await fetch('/api/[endpoint]');
        const data = await response.json();
        this.render[Name](data);
    } catch {
        bodyEl.innerHTML = '<div class="ratios-loading">Failed to load</div>';
    } finally {
        loadingEl.style.display = 'none';
    }
}

private close[Name]Modal(): void {
    this.[name]Modal.classList.add('hidden');
}
```

**Existing Modals**:

| Modal | Trigger | API Endpoint | Render Method |
|-------|---------|--------------|---------------|
| News | Click headline | N/A (data cached) | `openNewsModal(item)` |
| Ratios | FA - RATIOS button | `/api/financials/:symbol` | `renderRatios()` |
| Statements | FA - STMTS button | `/api/statements/:symbol` | `renderStatements()` |
| Indices | INDEX sidebar button | `/api/indices` | `renderIndices()` |

---

### 7. Statements Modal (Tabbed)

**Special Pattern**: Tabs that switch between Income/Balance/Cash Flow

```typescript
private currentTab: 'income' | 'balance' | 'cashflow' = 'income';
private statementsData: FinancialStatements | null = null;

private setupStatementsModal(): void {
    // ... standard modal setup ...
    
    // Tab switching
    document.querySelectorAll('.stmt-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = (tab as HTMLElement).dataset.tab as 'income' | 'balance' | 'cashflow';
            this.currentTab = tabName;
            
            // Update active tab styling
            document.querySelectorAll('.stmt-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // Re-render with same data, different tab
            if (this.statementsData) {
                this.renderStatements(this.statementsData);
            }
        });
    });
}
```

**Table Rendering** (`renderStatements()` lines 665-791):
- Builds `<table>` HTML with fiscal years as columns
- Uses section headers for grouping (REVENUE, EXPENSES, etc.)
- Highlights key rows (Net Income, Total Assets, FCF) with `stmt-highlight` class
- Formats numbers with `formatStatementValue()` helper

---

## CSS Architecture

### Color Variables (`styles.css` lines 1-16)

```css
:root {
    --bb-black: #000000;       /* True black background */
    --bb-dark: #0a0a0a;        /* Panel backgrounds */
    --bb-panel: #111111;       /* Content area backgrounds */
    --bb-border: #333333;      /* Borders */
    --bb-amber: #ff9900;       /* Primary text/accent */
    --bb-orange: #ff6600;      /* Logo, highlights */
    --bb-yellow: #ffcc00;      /* Function keys, symbols */
    --bb-green: #00ff00;       /* Positive values, up prices */
    --bb-red: #ff3333;         /* Negative values, down prices */
    --bb-blue: #3399ff;        /* Panel headers, section titles */
    --bb-gray: #888888;        /* Secondary text, labels */
    --bb-light-gray: #aaaaaa;  /* Descriptions */
    --bb-white: #ffffff;       /* Price display */
    --font-mono: 'Consolas', 'Monaco', 'Courier New', monospace;
}
```

**To Change Theme**:
1. Modify CSS variables in `:root`
2. For chart colors, also update `renderChart()` in `app.ts`

### Responsive Breakpoints

| Breakpoint | Changes |
|------------|---------|
| `≤1200px` | Grid switches to single column |
| `≤800px` | Ratios modal: 2-column grid |
| `≤700px` | Statements tabs wrap |
| `≤600px` | Index modal: stacked layout |
| `≤500px` | Ratios modal: single column |

### Key CSS Classes

| Class | Purpose |
|-------|---------|
| `.hidden` | `display: none !important` |
| `.positive` | Green color for gains |
| `.negative` | Red color for losses |
| `.active` | Highlighted state (tabs, buttons) |
| `.selected` | Keyboard-selected search result |
| `.stmt-highlight` | Emphasized table row |
| `.stmt-section-header` | Section divider in statements |

---

## Data Flow

### Search → Select → Load

```
User types in input
       ↓
handleSearch() [debounced 150ms]
       ↓
fetch('/api/search?q=...')
       ↓
renderSearchResults() → Dropdown shown
       ↓
User clicks/presses Enter
       ↓
selectCompany(company)
       ↓
loadSecurityView(company)
       ↓
Promise.all([
    loadQuote(symbol),      → renderQuote()
    loadChartData(symbol),  → renderChart()
    loadNews(symbol),       → renderNews()
])
```

### Modal Data Flow

```
User clicks trigger button
       ↓
open[Modal]Modal()
       ↓
Show loading state
       ↓
fetch('/api/[endpoint]')
       ↓
render[Modal](data)
       ↓
Hide loading state
```

---

## Helper Functions

### Number Formatting (`app.ts` lines 1060-1100)

```typescript
// Large numbers with K/M/B suffix
formatNumber(num: number): string
// Input: 1500000 → Output: "1.50M"

// Market cap / currency values
formatMarketCap(num: number): string
// Input: 2500000000000 → Output: "$2.50T"

// Statement values (handles negatives)
formatStatementValue(val: number | null): string
// Input: -50000000 → Output: "(50.00M)"

// Relative timestamps
formatTime(timestamp: string): string
// Input: ISO date → Output: "2 hours ago"
```

---

## Adding New Features

### Add a New Panel

1. **HTML**: Add `.panel-section` inside `.panel-grid`
2. **CSS**: Define grid position with `grid-row`/`grid-column`
3. **TypeScript**: 
   - Cache element in constructor
   - Add `load[Panel]()` async method
   - Add `render[Panel]()` method
   - Call in `loadSecurityView()`

### Add a New Modal

1. **HTML**: Copy modal template pattern, update IDs
2. **CSS**: Add `.modal-content.[name]-modal-content` if custom width needed
3. **TypeScript**:
   - Add DOM reference in constructor
   - Add `setup[Name]Modal()` - call in `init()`
   - Add `open[Name]Modal()` - async fetch + render
   - Add `close[Name]Modal()`
   - Add `render[Name](data)` - build HTML

### Add a New API Endpoint

1. **TypeScript**: 
   - Add interface for response type (top of file)
   - Add fetch call in relevant method
2. **No HTML/CSS changes** unless displaying new data

### Add Keyboard Shortcut

```typescript
// In setupEventListeners() or dedicated method
document.addEventListener('keydown', (e) => {
    // Check for modifier keys if needed
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        this.commandInput.focus();
    }
});
```

---

## TypeScript Interfaces

All interfaces defined at top of `app.ts` (lines 1-172):

```typescript
interface Company { symbol, name, exchange, sector, industry, market_cap, description }
interface Quote { symbol, name, price, change, change_percent, open, high, low, volume, ... }
interface ChartPoint { timestamp, open, high, low, close, volume }
interface ChartData { symbol, points: ChartPoint[] }
interface NewsItem { id, title, summary, content, source, timestamp, url, sentiment }
interface NewsResponse { symbol, items: NewsItem[] }
interface FinancialRatios { symbol, pe_ratio, forward_pe, ... (38 fields) }
interface IndexQuote { symbol, name, region, price, change, change_percent }
interface IncomeStatement { fiscal_year, total_revenue, cost_of_revenue, ... }
interface BalanceSheet { fiscal_year, total_assets, total_current_assets, ... }
interface CashFlow { fiscal_year, operating_cash_flow, net_income, ... }
interface FinancialStatements { symbol, income_statements, balance_sheets, cash_flows }
```

These mirror the Rust `models.rs` structs. Keep them in sync when adding fields.

---

## Build & Development

```bash
# Development (auto-rebuild on save)
bun run watch

# Production build
bun run build

# Type checking only
bun run typecheck
```

**esbuild config** (in `package.json`):
- Bundle: All imports resolved into single file
- Format: IIFE (immediately-invoked function expression)
- Target: ES2020
- Minify: Yes (production)

---

## Debugging Tips

1. **Search not working**: Check browser console for fetch errors
2. **Chart not rendering**: Ensure container has non-zero dimensions
3. **Modal not opening**: Check if element IDs match between HTML and TypeScript
4. **Styles not applying**: Check CSS specificity, use browser inspector
5. **TypeScript errors**: Run `bun run typecheck` for detailed errors

---

## Performance Considerations

1. **DOM Caching**: All elements cached in constructor, not queried repeatedly
2. **Debounced Search**: 150ms delay prevents excessive API calls
3. **Chart Cleanup**: Previous chart destroyed before creating new one
4. **ResizeObserver**: Chart resizes efficiently on container changes
5. **Single Bundle**: All code in one file, no module loading overhead
